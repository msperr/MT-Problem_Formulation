\chapter{Optimal Approach}
\label{ch:optimal_approach}

In this chapter, we develop a solution method in order to solve our problem to optimality. We expect this to require a very efficient algorithm and a lot of computation power since the problem is $\mathcal{NP}$-hard. The solution method should cope with multi-leg cover constraints as defined in \Cref{ch:problem_description}. The approach is based on the underlying master theses which have already found methods to solve a simplified version of our problem. \cite{Kaiser} provide an optimal algorithm for the problem with single-leg cover constraints. This problem setting assumes that each customer has a set of alternative trips, where one of them has to be fulfilled each. We want our algorithm to produce a result in reasonable time, therefore we require already a very good solution as an initial solution. For receiving a good initial solution, we apply the Successive Heuristics as developed in \Cref{ch:heuristics}.

In order to tackle the problem, we introduce a path flow formulation which is different to the arc flow formulation of \Cref{sec:arcflow_formulation}. Since the entire solution consists of separate vehicle duties, we decompose the problem into these single duties. This concept is an application of Dantzig-Wolfe Decomposition. There are only a few constraints connecting these subproblems, namely the cover constraints. First we regard the LP relaxation of this problem and solve this via column generation. The resulting subproblem for each duty is a shortest path problem with resource constraints (SPPRC), which is also $\mathcal{NP}$-hard. For solving this subproblem, we have both a heuristic and an exact algorithm. In order to receive a total solution, we apply branch-and-price. We provide and discuss some branching strategies used for this procedure.

Most of the procedure is already developed by \cite{Kaiser}. We show the crucial results for the algorithm and discuss our adaptions in the path flow formulation, the algorithm solving the subproblems and the branch-and-price procedure. This adaptions make the optimal approach also cope with multi-leg cover constraints.

%########################################################################################################################################
%#
%#   Path Flow Formulation
%#
%########################################################################################################################################

\section{Path Flow Formulation}
\label{sec:pathflow_formulation}

We apply Dantzig-Wolfe Decomposition in order to create a path flow formulation of our problem. This is advantageous since the size of the arc flow formulation grows very fast with increasing problem size. We give only a short outline on the general procedure and then show the application to our problem.

\subsection{Dantzig-Wolfe Decomposition}

Dantzig-Wolfe Decomposition can be used in order to deal with large mixed-integer linear programs. It breaks the problem into smaller subproblems if the structure is suitable. This is the case if a large subset of the variables can be partitioned in a way such that the sets of occurring variables are disjoint for most of the constraints. The structure of the matrix for such a linear program looks as follows:
\begin{align*}
	\left(\begin{array}{cccccccccccc}
		\star  & \cdots & \star  & \star  & \cdots & \star  &        &        &        & \star  & \cdots & \star  \\
		\vdots & \ddots & \vdots & \vdots & \ddots & \vdots &        & \cdots &        & \vdots & \ddots & \vdots \\
		\star  & \cdots & \star  & \star  & \cdots & \star  &        &        &        & \star  & \cdots & \star  \\
		\hline
		\star  & \cdots & \star  & 0      & \cdots & 0      &        &        &        & 0      & \cdots & 0      \\
		\vdots & \ddots & \vdots & \vdots & \ddots & \vdots &        & \cdots &        & \vdots & \ddots & \vdots \\
		\star  & \cdots & \star  & 0      & \cdots & 0      &        &        &        & 0      & \cdots & 0      \\
		0      & \cdots & 0      & \star  & \cdots & \star  &        &        &        &        &        &        \\
		\vdots & \ddots & \vdots & \vdots & \ddots & \vdots &        & \ddots &        &        & \vdots &        \\
		0      & \cdots & 0      & \star  & \cdots & \star  &        &        &        &        &        &        \\
		       &        &        &        &        &        &        &        &        & 0      &        & 0      \\
		       & \vdots &        &        & \ddots &        &        & \ddots &        & \vdots & \ddots & \vdots \\
		       &        &        &        &        &        &        &        &        & 0      &        & 0      \\
		0      & \cdots & 0      &        &        &        & 0      & \cdots & 0      & \star  & \cdots & \star  \\
		\vdots & \ddots & \vdots &        & \cdots &        & \vdots & \ddots & \vdots & \vdots & \ddots & \vdots \\
		0      & \cdots & 0      &        &        &        & 0      & \cdots & 0      & \star  & \cdots & \star  \\
	\end{array}\right)
\end{align*}

The entries with $\star$ denote the non-zero entries in the matrix.

The subproblems emerge by considering only the constraints of a single set of this partition. The other constraints concerning the whole variable set are called linking constraints as they link the respective subproblems. The master problem considers the objective function in connection with the linking constraints. We then apply column generation for each of the subproblems separately. Starting with only a small set of feasible solutions, we successively generate further feasible solutions and include them to the master problem. Each feasible solution represents a column of the matrix representing the linear program. In the master problem, the actual formulation of the subproblems is not needed. Thus, we can extract the subproblems and solve them with specialized algorithms if they have an appropriate structure.

The column generation method is only able to solve a linear program. Thus, we have to restate the integrality afterwards. How this is done is discussed later.

%----------------------------------------------------------------------------------------------------------------------------------------

\subsection{Application of the Decomposition}

In the original problem formulation, we regard only a single set of variables which models the entire flow of the vehicles. For the arc flow formulation, a single variable set is advantageous as the corresponding task graph stays small. In contrast, we extend the variable set here in order to define smaller subproblems.

\paragraph{Identification of the Subproblems} \parfill

Consider a solution of the $\eqref{eq:MMILP}$. This solution can be decomposed into a set of separate vehicle duties. For each of these duties, the time and fuel restrictions are applied individually. The only requirements that do not occur in the respective duties individually are the cover constraints. They guarantee that for each customer exactly one route is fulfilled and for each route, if it is fulfilled, each of its trips is fulfilled. Therefore the duty of each vehicle is a natural choice for the subproblems. We introduce $\left(x^v,z^v,e^v\right)$ for $v\in\mathcal{V}$ as the specific variables for each vehicle. With this we define the set of feasible vehicle duties as $X_v$ for $\vinV$.
\begin{align}
	X_v := \left\{\vphantom{\{0,1\}^A}\right. & \omit\rlap{$\displaystyle{(x,z,e)\in\left\{0,1\right\}^A \times \{0,1\}^{\left(A\cap\left(\mathcal{V}\cupdot\mathcal{T}\right)^2\right)\times\mathcal{R}} \times [0,1]^{\mathcal{V}\cupdot\mathcal{T}}|}$} \nonumber \\
	& \sum_{t\in\Nin(s)} x_{t,s} = \sum_{t\in\Nout(s)} x_{s,t} && \text{for all } s\in V\backslash\left\{d^{\operatorname{s}},d^{\operatorname{e}}\right\} \tag{\ref{eq:MMILP:flow}} \\
	& \sum_{s\in\Nin(v)} x_{s,v} = 1 \label{eq:Xv:vehicle} \\
	& \sum_{s\in\Nin(t)} x_{s,t} = 0 && \text{for all } t\in\mathcal{V}\backslash\{v\} \label{eq:Xv:other_vehicles} \\
	& \sum_{r\in\Rst} z_{s,r,t} \leq x_{s,t} & & \text{for all } t\in\mathcal{T}, s\in\Nin(t) \tag{\ref{eq:MMILP:refuel}} \\
	& e_s \leq f_s^0 & & \text{for all } s\in\mathcal{V} \tag{\ref{eq:MMILP:initial_fuel}} \\
	& 0 \leq e_s - \sum_{r\in\Rst} z_{s,r,t}\fd_{s,r} & & \text{for all } t\in\mathcal{T}, s\in\Nin(t) \tag{\ref{eq:MMILP:min_fuel}} \\
	& e_t \leq 1 - \ft_t - \sum_{r\in\Rst} z_{s,r,t}\fd_{r,t} & & \text{for all } t\in\mathcal{T}, s\in\Nin(t) \tag{\ref{eq:MMILP:max_fuel}} \\
	& \omit\rlap{$\displaystyle{e_t \leq e_s - x_{s,t}\left(f_{s,t}^{\operatorname{d}}+f_t^{\operatorname{t}}\right) - \sum_{r\in\Rst} z_{s,r,t}\left(\fd_{s,r}+\ft_r+\fd_{r,t}-\fd_{s,t}\right) + \left(1-x_{s,t}\right)}$} \nonumber \\
	& & & \text{for all } t\in\mathcal{T}, s\in\Nin(t) \tag{\ref{eq:MMILP:fuel_consumption}} \\
	& \left. \vphantom{\{0,1\}^A} \right\} \nonumber
\end{align}

Constraints $\eqref{eq:Xv:vehicle}$ and $\eqref{eq:Xv:other_vehicles}$ ensure that exactly vehicle $v$ is used in this formulation. We denote the set of feasible duties for any vehicle by $X:=\bigcup_{v\in\mathcal{V}}X_v$. Any feasible solution of $\eqref{eq:MMILP}$ can be decomposed into vehicle duties. This is guaranteed by $\eqref{eq:MMILP:vehicles}$ which forces the duties of the vehicles to be disjoint with respect to the trips. The only variables that are not considered in $X_v$ are the route variables $u_m$ which can be determined by the arc variables $x_{s,t}$. The objective function is additive with respect to the decomposition except for the route cost which we then consider explicitly. We write the cost for a configuration $\left(x^v,z^v,e^v\right)$ as $g\left(x^v,z^v,e^v\right)$.

The only constraints that are not ensured in $X_v$ are the cover constraints $\eqref{eq:MMILP:customer}$ and $\eqref{eq:MMILP:route}$. These are the linking constraints for the various subproblems. In summary, we can rewrite $\eqref{eq:MMILP}$ as:
\begin{align}
	\min \quad & \sum_{v\in\mathcal{V}}g\left(x^v,z^v,e^v\right) + \sum_{m\in\mathcal{M}} u_m \croute_m \nonumber \\
	\text{s.t.} \quad & \sum_{m\in C^{-1}(c)} u_m = 1 && \text{for all } c\in\mathcal{C} \tag{\ref{eq:MMILP:customer}} \\
	& \sum_{v\in\mathcal{V}}\sum_{s\in\Nin(t)}x^v_{s,t} = u_m && \text{for all } m\in\mathcal{M},t\in m \label{eq:MMILP:linking} \\
	& \left(x^v,z^v,e^v\right)\in X_v && \text{for all } v\in\mathcal{V} \nonumber \\
	& u_m\in\{0,1\} && \text{for all } m\in\mathcal{M} \tag{\ref{eq:MMILP:um}}
\end{align}

\paragraph{Reduction of the Master Problem} \parfill

Because of the introduction of variables for each vehicle, the resulting problem size is very large. For maintaining the master problem, not all information of $X_v$ are needed. In order to fulfill $\eqref{eq:MMILP:linking}$ we need only the term ${\sum_{s\in\Nin(t)} x^v_{s,t}}$, which is the set of trips served by a specific vehicle. Therefore, we define the linear mapping:
\begin{align*}
	\psi:X\to\{0,1\}^{\mathcal{T}} && (x,z,e)\mapsto\left(\sum_{s\in\Nin(t)}x_{s,t}\right)_{t\in\mathcal{T}} \label{eq:psi}
\end{align*}

The dimension of the codomain of $\psi$ is much smaller than the dimension of the domain. We can rewrite $\eqref{eq:MMILP}$ by using $y^v:=\psi\left(x^v,z^v,e^v\right)$:

\begin{align}
	\min \quad & \omit\rlap{$\displaystyle{\sum_{v\in\mathcal{V}}\min g\left(\psi^{-1}\left(y^v\right)\cap X_v\right) + \sum_{m\in\mathcal{M}}u_m\croute_m}$} \nonumber \\
	\text{s.t.} \quad & \sum_{m\in C^{-1}(c)} u_m = 1 && \text{for all } c\in\mathcal{C} \tag{\ref{eq:MMILP:customer}} \\
	& \sum_{v\in\mathcal{V}}y^v_t = u_m && \text{for all } m\in\mathcal{M},t\in m \label{eq:MMILP:linking_y} \\
	& y^v\in \psi\left(X_v\right) && \text{for all } v\in\mathcal{V} \nonumber \\
	& u_m\in\{0,1\} && \text{for all } m\in\mathcal{M} \tag{\ref{eq:MMILP:um}}
\end{align}

The mapping $\psi$ is not injective in general. Thus, there is more than one feasible duty that serves exactly the trips of $y^v$. These duties can have different cost. We therefore use the minimal resulting cost
\begin{align*}
	\min g\left(\psi^{-1}\left(y^v\right)\cap X_v\right) = \min \left\{g\left(x^v\right)|x^v\in X_v, \psi\left(x^v\right)=y^v\right\}.
\end{align*}

This is the smallest cost of a vehicle duty that serves exactly the trips as indicated by the incidence vector $y^v$. We do not have to determine these costs now. As we will see later, the costs are a byproduct of solving the subproblems.

\paragraph{Column Generation} \parfill

We apply column generation to our problem. For every $v\in\mathcal{V}$, let $\Iv$ be an index set for the finitely many points in $\psi\left(X_v\right)$ and let the columns of $Y^v\in\mathbb{R}^{\mathcal{T}\times\Iv}$ be exactly those points. Let $G^v\in\mathbb{R}^{1\times\mathcal{I}}$ be the respective values of $\min g\left(\psi^{-1}(\cdot)\cap X_v\right)$. Then we can reformulate the master problem as:
\begin{align*}
	\min \quad & \sum_{v\in\mathcal{V}}G^v\lambda^v + \sum_{m\in\mathcal{M}}u_m\croute_m \tag{IMP} \label{eq:IMP} \\
	\text{s.t.} \quad & \sum_{v\in\mathcal{V}} Y^v_{t,\cdot}\lambda^v = u_m && \text{for all } m\in\mathcal{M},t\in m \\
	& \sum_{m\in C^{-1}(c)} u_m = 1 && \text{for all } c\in\mathcal{C} \\
	& \sum_{i\in\Iv}\lambda_i^v=1 && \text{for all } v\in\mathcal{V}\\
	& \lambda^v\in\{0,1\}^{\Iv} && \text{for all } v\in\mathcal{V} \\
	& u_m\in\{0,1\} && \text{for all } m\in\mathcal{M}
\end{align*}

Then we regard the LP-relaxation of $\eqref{eq:IMP}$ by dropping the integrality constraints:
\begin{align*}
	\min \quad & \sum_{v\in\mathcal{V}}G^v\lambda^v + \sum_{m\in\mathcal{M}}u_m\croute_m \tag{LMP} \label{eq:LMP} \\
	\text{s.t.} \quad & \sum_{v\in\mathcal{V}} Y^v_{t,\cdot}\lambda^v = u_m && \text{for all } m\in\mathcal{M},t\in m \\
	& \sum_{m\in C^{-1}(c)} u_m = 1 && \text{for all } c\in\mathcal{C} \\
	& \sum_{i\in\Iv}\lambda_i^v=1 && \text{for all } v\in\mathcal{V}\\
	& \lambda^v\in\mathbb{R}_{\geq 0}^{\Iv} && \text{for all } v\in\mathcal{V} \\
	& u_m\geq 0 && \text{for all } m\in\mathcal{M}
\end{align*}

As a next step, we reduce the size of the problem by considering only subsets $\Jv\subset\Iv$ of the feasible solutions for all $\vinV$ and formulate the relaxed restricted master problem:
\begin{align*}
	\min \quad & \sum_{v\in\mathcal{V}}G^v_{\Jv}\lambda^v + \sum_{m\in\mathcal{M}}u_m\croute_m \tag{LRMP} \label{eq:LRMP} \\
	\text{s.t.} \quad & \sum_{v\in\mathcal{V}} Y^v_{t,\Jv}\lambda^v = u_m && \text{for all } m\in\mathcal{M},t\in m \\
	& \sum_{m\in C^{-1}(c)} u_m = 1 && \text{for all } c\in\mathcal{C} \\
	& \sum_{i\in\Jv}\lambda_i^v=1 && \text{for all } v\in\mathcal{V}\\
	& \lambda^v\in\mathbb{R}_{\geq 0}^{\Jv} && \text{for all } v\in\mathcal{V} \\
	& u_m\geq 0 && \text{for all } m\in\mathcal{M}
\end{align*}

Finally, we regard the dual relaxed restricted master problem. For this, we introduce dual variables $\gamma\in\mathbb{R}^{\mathcal{T}}$, $\mu\in\mathbb{R}^{\mathcal{V}}$ and $\eta\in\mathbb{R}^{\mathcal{C}}$. The dual problem is:
\begin{align}
	\max \quad & \sum_{c\in\mathcal{C}}\eta_c + \sum_{v\in\mathcal{V}}\mu_v \tag{DLRMP} \label{eq:DLRMP} \\
	\text{s.t.} \quad & \sum_{t\in\mathcal{T}} Y^v_{t,i}\gamma_t + \mu_v \leq G^v_i && \text{for all } v\in\mathcal{V},i\in\Jv \label{eq:DLRMP:vehicle} \\
	& \eta_{C(m)} - \sum_{t\in m}\gamma_t \leq \croute_m && \text{for all } m\in\mathcal{M} \label{eq:DLRMP:route} \\
	& \gamma\in\mathbb{R}^{\mathcal{T}} \nonumber \\
	& \mu\in\mathbb{R}^{\mathcal{V}} \nonumber \\
	& \eta\in\mathbb{R}^{\mathcal{C}} \nonumber
\end{align}

%----------------------------------------------------------------------------------------------------------------------------------------

\subsection{Solving the Relaxed Master Problem}

The size of the index set $\Iv$ of all feasible solutions of $X_v$ can be exponential in the input size. Therefore, the formulation $\eqref{eq:IMP}$ is hard, even the relaxed version $\eqref{eq:LMP}$ is hard. In order to tackle the problem, we first consider a small subset $\Jv\subset\Iv$ of the index set. We solve the problem $\eqref{eq:LRMP}$ where only duties from the restricted set are allowed. Since $\Jv$ is small, it is easier to solve the problem. Originating from this solution, we iteratively enlarge $\Jv$ and solve $\eqref{eq:LRMP}$ until the solution is an optimal solution of $\eqref{eq:LMP}$. For this method arise the following questions.
\begin{enumerate}
	\item{Does this procedure come up with an optimal solution in finitely many steps?}
	\item{How do we find columns to add?}
	\item{How do we check for optimality in $\eqref{eq:LMP}$?}
\end{enumerate}

If we iteratively add columns to $\Jv$, we finally have $\Jv=\Iv$ after a finite number of steps since $\Iv$ is a finite set. When this is reached, the problems $\eqref{eq:LRMP}$ and $\eqref{eq:LMP}$ are equivalent and thus the solution is optimal. Obviously, this behavior is not desirable as we do not want to solve the unrestricted problem. Thus, we hope to receive an optimal solution earlier.

We can check for optimality and find columns to add by using the dual problems of the restricted and the unrestricted problem. Consider a solution $\left(\lambda^v\right)_{\vinV}$ of $\eqref{eq:LRMP}$ and its corresponding dual solution $\left(\gamma^*,\mu^*,\eta^*\right)$ which is feasible in $\eqref{eq:DLRMP}$. We want to check whether $\left(\lambda^v\right)_{\vinV}$ is an optimal solution of the unrestricted problem $\eqref{eq:LMP}$. Due to strong duality, this is the case if and only if $\left(\gamma^*,\mu^*,\eta^*\right)$ is feasible in the unrestricted dual problem (DLMP).

We therefore consider the constraints of the dual problems. Constraints $\eqref{eq:DLRMP:route}$ are equivalent in both formulations. The constraints $\eqref{eq:DLRMP:vehicle}$ read as follows in the unrestricted case
\begin{align}
	\sum_{t\in\mathcal{T}} Y^v_{t,i}\gamma_t + \mu_v \leq G^v_i && \text{for all } \vinV,i\in\Iv. \label{eq:DLMP:vehicle}
\end{align}

Since $\left(\gamma^*,\mu^*,\eta^*\right)$ is a solution of the restricted problem, $\eqref{eq:DLMP:vehicle}$ is fulfilled for all $i\in\Jv$. It remains to check $\Iv\backslash\Jv$ which leads to the following subproblem:
\begin{align}
	\text{Find } i\in\Iv\backslash\Jv && \text{ s.t.} && \sum_{t\in\mathcal{T}}Y^v_{t,i}\gamma^*_t + \mu^*_v > G^v_i && \text{for } \vinV \label{eq:DLMP:index}
\end{align}

\newpage

\paragraph{Identification of the Subproblem} \parfill

Recall the definitions ${G^v_i = \min g\left(\psi^{-1}\left(Y^v_i\right)\cap X_v\right)}$ and ${Y^v_i = \psi(x,z,e)}$ for the respective ${(x,z,e)\in X_v}$. Using this, we can rewrite the subproblem to:
\begin{align*}
	\min \quad & g\left(x,z,e\right)-\sum_{t\in\mathcal{T}}\sum_{s\in\Nin(t)}x_{s,t}\gamma^*_t \tag{$\operatorname{SP}_v$} - \mu^*_v \label{eq:SPv} \\
	\text{s.t.} \quad & \left(x,z,e\right)\in X_v
\end{align*}

Actually, the term $g(x,z,e)$ would be ${\min g\left(\psi^{-1}\left(\psi(x,z,e)\right)\cap X_v\right)}$. The following result shows that this distinction is not necessary as this is done implicitly be solving the subproblem.

\begin{lemma}

For $\vinV$, an optimal solution ${\left(x^*,z^*,e^*\right)\in X_v}$ to the subproblem $\eqref{eq:SPv}$ fulfills
\begin{align*}
	g\left(x^*,z^*,e^*\right) = \min g\left(\psi^{-1}\left(\psi\left(x^*,z^*,e^*\right)\right)\cap X_v\right).
\end{align*}

In other words, the duty $\left(x^*,z^*,e^*\right)$ has the smallest possible cost under all duties which serve the same set of trips.

\end{lemma}

This lemma is proven by \cite[pp.~42-43]{Kaiser} and holds for our case, too.

How the subproblem $\eqref{eq:SPv}$ is solved, is shown in \Cref{sec:solving_subproblem}. As mentioned before, the cost $G^v_i$ are also determined by solving the subproblem. We receive a solution $(x,z,e)$ of $\eqref{eq:SPv}$ for all $\vinV$ and simultaneously the cost $g(x,z,e)$. If we then add the corresponding duty to $\Jv$, we can easily use the determined cost for $G^v$.

\paragraph{Updating the Index Set} \parfill

The value of a duty as determined in the subproblem is called reduced cost. As long as there exists a violated constraint in the dual problem, there exists a column with negative reduced cost. This is used for deciding if a duty is added to the index set. First, we solve the $\eqref{eq:DLRMP}$ and receive a solution $\left(\gamma^*,\mu^*,\eta^*\right)$. With this we solve the subproblems $\eqref{eq:SPv}$ for all $\vinV$ and receive solutions $\left(x^v,z^v,e^v\right)$. We know that all of these duties with negative reduced cost correspond to a violated constraint in (DLMP). Thus we consider these duties in the next step. 

For each $v\in\mathcal{V}$, we have a solution ${\left(x^v,z^v,e^v\right)\in X_v}$. This solution corresponds to an index ${i\in\Iv}$. If the reduced cost for the solution is negative, \ie $\operatorname{val}\left(x^v,z^v,e^v\right)<0$, then we update the index set as follows:
\begin{align*}
	\Jv\gets\Jv\cup\{i\} && Y^v_{\cdot,i}\gets\psi\left(x^v,z^v,e^v\right) && G^v_i\gets g\left(x^v,z^v,e^v\right)
\end{align*}

If $\operatorname{val}\left(x^v,z^v,e^v\right)\geq 0$ for all $\vinV$, then the dual solution $\left(\gamma^*,\mu^*,\eta^*\right)$ is feasible in the (DLMP) and the corresponding primal solution $\left(\lambda^v\right)_{\vinV}$ is an optimal solution of the relaxed master problem $\eqref{eq:LMP}$.

\paragraph{Initial Solution} \parfill

For starting the column generation method, an initial index set is required for $\Jv$ for all $\vinV$. These index sets have to be feasible, \ie each occurring duty is feasible and there is a solution satisfying the cover constraints $\eqref{eq:MMILP:customer}$ and $\eqref{eq:MMILP:route}$ using only duties out of $\bigcup_{\vinV}\Jv$. Otherwise the restricted problem is infeasible and its dual problem is unbounded. Then we do not receive a solution $\left(x^*,z^*,e^*\right)$ of $\eqref{eq:DLRMP}$ with which we define the subproblems. As an initial solution we use a heuristical solution of the problem, as we have developed in \Cref{ch:heuristics}.

Note that this procedure only provides a solution for the LP-relaxation of the master problem. In \Cref{sec:solving_masterproblem} we show how we receive a solution of the $\eqref{eq:IMP}$.

%########################################################################################################################################
%#
%#   Solving the Subproblems
%#
%########################################################################################################################################

\section{Solving the Subproblems}
\label{sec:solving_subproblem}

In every step of the master problem, we solve the subproblem $\eqref{eq:SPv}$ for each vehicle $\vinV$. This subproblem is equivalent to the Shortest Path Problem with Resource Constraints (SPPRC). A vehicle duty is expressed as a $\ds$-$\de$-path whose first vertex is the respective vehicle $v$. The main resource is the fuel state of the vehicle, where refuel stations a have negative fuel consumption. The goal is to find a feasible path with negative reduced cost which is then added to the index set. Besides fuel, we use additional resources in order to solve the subproblem.

\subsection{Shortest Path Problem with Resource Constraints}
\label{sec:spprc}

In this section, we summarize the crucial results for solving the subproblem optimally. For this, we use a label-setting algorithm which solves the (SPPRC) efficiently. The respective definitions and the algorithm are shown in detail in \cite{Kaiser} and \cite{Irnich_Desaulniers}. The (SPPRC) is a generalization of the Shortest Path Problem and is $\mathcal{NP}$-hard, as shown in \cite[p.~307]{Handler_Zang}. The problem is given by a graph, a set of resources and a relation on every arc that specifies the change of resources along its way. 

\begin{definition}[Graph with resource constraints]
\label{def:graph_resource_constraints}

We call ${H:=\left(V_H,A_H,\sqsubseteq,I,\REF\right)}$ a graph with resource constraints for a set of resources $\mathcal{U}$ if
\begin{enumerate}
	\item{$\left(V_H,A_H\right)$ is a directed graph with vertex set $V_H$ and arc set $A_H$.}
	\item{$\sqsubseteq\in\left\{\leq,=,\geq\right\}^{\mathcal{U}}$ is a vector of resource relations and is called the resource dominance relation.}
		For two resources ${r,\tilde{r}\in\mathbb{R}^{\mathcal{U}}}$, we write ${r\sqsubseteq\tilde{r}}$ if ${r_u\sqsubseteq_u \tilde{r}_u}$ for all $u\in\mathcal{U}$ and say that $\tilde{r}$ dominates $r$. The subset of maximal vectors of a set $R\subseteq\mathbb{R}^{\mathcal{U}}$ with respect to $\sqsubseteq$ is denoted by
		\begin{align*}
			\max_{\sqsubseteq} R := \left\{r\in R\mid \forall\tilde{r}\in R: r\sqsubseteq\tilde{r}\Rightarrow r=\tilde{r}\right\}.
		\end{align*}
		The closed cone of resource vectors less than or equal to zero with respect to $\sqsubseteq$ is denoted by
		\begin{align*}
			\mathbb{R}^{\mathcal{U}}_{\sqsubseteq 0} := \left\{r\in\mathbb{R}^{\mathcal{U}}\mid r\sqsubseteq 0_{\mathcal{U}}\right\}.
		\end{align*}
	\item{$I\subseteq\mathbb{R}^{\mathcal{U}}$ is the Cartesian product of closed intervals of $\mathbb{R}$.}
		The projection onto a single resource $u\in\mathcal{U}$ denoted by $\Pi_u(I)$ is called its resource window. If $\Pi_u(I)=\mathbb{R}$ for some resource $u\in\mathcal{U}$ it is called unrestricted.
	\item{$\REF = \left(\REF_{u,w}\right)_{(v,w)\in A_H}$}
		is a vector of binary relations ${\REF_{v,w}\subseteq I\times I}$ for all ${(v,w)\in A_H}$ such that the set of vectors related to some ${r^v\in I}$
		\begin{align*}
			\REF_{v,w}\left(r^v\right) := \left\{r^w\in I\mid \left(r^v,r^w\right)\in\REF_{v,w}\right\}
		\end{align*}
		is closed, has a finite set of maximal vectors ${\max_{\sqsubseteq}\REF_{v,w}\left(r^v\right)}$ and fulfills
		\begin{align*}
			\forall r^w,\tilde{r}^w\in I,r^w\sqsubseteq\tilde{r}^w : \tilde{r}^w\in\REF_{v,w}\left(r^v\right) \Rightarrow r^w\in\REF_{v,w}\left(r^v\right).
		\end{align*}
		$\REF_{v,w}$ is called the resource extension function with respect to $\sqsubseteq$ on the arc $(v,w)\in A_H$.
\end{enumerate}
	
\end{definition}

The resource vectors are assigned to the vertices of the graph. They describe the absolute amount of available resources at that vertex.

The resource dominance relation is a partial order on $\mathbb{R}^{\mathcal{U}}$. If two resource vectors are comparable, then the dominating vector is always preferable to the other. If it is desirable to have a high quantity of a resource, the resource relation is set to $\leq$, \eg for the fuel resource. Otherwise it is set to $\geq$, \eg for the modeling cost resource. If no general relation holds, it is set to $=$. The resource extension function models the change of the resource vectors along the arcs. It relates a resource vector to all possible outcomes when traveling along this arc. 

\begin{definition}[Monotone resource extension function]
\label{def:monotone_ref}

A resource extension function ${\REF_{v,w}\subseteq I\times I}$ with respect to $\sqsubseteq$ is called monotone if
\begin{align*}
	\forall r^v,\tilde{r}^v\in I, r^v\sqsubseteq\tilde{r}^v : \REF_{v,w}\left(r^v\right)\subseteq\REF_{v,w}\left(\tilde{r}^v\right)
\end{align*}
holds.

\end{definition}

The monotonicity is important for the consistency. If a resource vector is dominated by another, then there are not more possible outcomes than for the dominating one.

After introducing the graph with resource constraints, we define resource-feasible paths on this graph.

\begin{definition}[Resource-feasible path]

Let ${H=\left(V_H,A_H,\sqsubseteq,I,\REF\right)}$ be a graph with resource constraints. A path\linebreak
${P:=\left(v_0,\dots,v_n\right)}$ of length ${n\in\mathbb{N}_0}$ in $H$ is called resource-feasible if
\begin{align*}
	\exists r^{v_i}\in I,i\in\{0,\dots,n\}: \left(r^{v_{i-1}},r^{v_i}\right)\in\REF_{v_{i-1},v_i} \forall i\in\{1,\dots,n\}
\end{align*}
holds. We say $\left(r^v\right)_{v\in P}$ witnesses resource-feasibility of $P$.

\end{definition}

The witnessing resource vectors $\left(r^v\right)_{v\in\mathcal{P}}$ are the resources along this path, \eg the fuel state of the respective trips of a vehicle duty.

\paragraph{Contraction and Inversion} \parfill

We define the actions \enquote{contraction of an arc} and \enquote{inversion of a graph} in order to apply them to our problem.

\begin{definition}[Contraction]
\label{def:contraction}

Let ${H=\left(V_H,A_H,\sqsubseteq,I,\REF\right)}$ be a graph with resource constraints, ${(v,w)\in A_H}$ be the only arc leaving some vertex $v\in V_H$ and $\REF_{v,w}$ be monotone.
\begin{enumerate}
	\item
For $(u,v)\in A_H$, the concatenation of resource extension functions is defined as
\begin{align*}
	\REF_{v,w}\circ\REF_{u,v} := \left\{\vphantom{\REF_{v,w}}\right. & \left(r^u,r^w\right)\in I\times I\mid \exists r^v\in I: \\
	& \left.\left(r^u,r^v\right)\in\REF_{u,v}\land\left(r^v,r^w\right)\in\REF_{v,w}\right\}.
\end{align*}
	\item
The graph with resource constraints ${\widehat{H} := \left(V_{\widehat{H}},A_{\widehat{H}},\sqsubseteq,I,\widehat{\REF}\right)}$ which results from $H$ by contracting the arc $(v,w)$ is defined by the vertex set ${V_{\widehat{H}} := V_H\backslash\{v\}}$, the arc set
\begin{align*}
	A_{\widehat{H}} := \left(A_H\cap V^2_{\widehat{H}}\right) \cup \left\{(u,w)\mid (u,v)\in A_H\right\},
\end{align*}

and the resource extension function ${\left(\REF_a\right)_{a\in A_{\widehat{H}}}}$, where
\begin{align*}
	\widehat{\REF}_a :=
	\begin{cases}
		\REF_{u,w}\cup\left(\REF_{v,w}\circ\REF_{u,v}\right) & \text{if } \exists u\in V_{\widehat{H}}: a=(u,w) \\
		\REF_a & \text{otherwise}
	\end{cases}
\end{align*}

for all ${a\in A_H}$. $\REF_{u,w}$ and $\REF_{u,v}$ are considered to be the empty relation $\emptyset$ if ${(u,w)\notin A_H}$ or ${(u,v)\notin A_H}$, respectively.

\end{enumerate}

\end{definition}

In \cite[p.~79]{Kaiser} is proven that for a resource-feasible path $P$ in the original graph $H$ there is a resource-feasible path $\widehat{P}$ in the contracted graph $\widehat{H}$ and vice versa such that $P$ and $\widehat{P}$ cover the same vertices of $V_H\backslash\{v\}$. We need contraction since we have resources on both the vertices and the arcs in our problem. 

\begin{definition}[Inversion]
\label{def:inversion}

\begin{enumerate}
	\item{A resource extension function}
$\REF_{v,w}$ with respect to $\sqsubseteq$ is called invertible if the inverted relation
\begin{align*}
	\REF^{-1}_{v,w} := \left\{\left(r^w,r^v\right)\mid\left(r^v,r^w\right)\in\REF_{v,w}\right\}
\end{align*}
is a resource extension function with respect to the inverted dominance relation~$\sqsupseteq$. $\REF^{-1}_{v,w}$ is called the inversion of $\REF_{v,w}$.
	\item{Let}
${H := \left(V_H,A_H,\sqsubseteq,I,\REF\right)}$ be a graph with resource constraints and invertible resource extension functions.

The inversion of $H$ is defined to be the graph
\begin{align*}
	H^{-1} := \left(V_H,A^{-1}_H,\sqsupseteq,I,\REF^{-1}\right)
\end{align*}
with inverted arc set ${A_H^{-1}:=\left\{(w,v)\in V_H^2\mid (v,w)\in A_H\right\}}$ and inverted resource extension functions ${\REF^{-1} := \left(\REF^{-1}_{v,w}\right)_{(w,v)\in A^{-1}_H}}$.
\end{enumerate}

\end{definition}

\begin{theorem}[Feasibility-conservation of inversions]
\label{th:inversion}

Let ${H:=\left(V_H,A_H,\sqsubseteq,I,\REF\right)}$ be a graph with resource constraints. Further, let all the resource extension functions of $\REF$ be invertible.

Then a path ${P := \left(v_0,\dots,v_n\right)}$ of length ${n\in\mathbb{N}_0}$ in $H$ is resource-feasible with witnessing resource vectors $\left(r^v\right)_{v\in P}$ if and only if ${P^{-1} := \left(v_n,\dots,v_0\right)}$ is a resource-feasible path in the inverted graph $H^{-1}$ with witnessing resource vectors $\left(r^v\right)_{v\in P^{-1}}$.

\end{theorem}

This theorem is already proven in \cite[p.~83]{Kaiser}. We need inversions in order to improve the behavior of the algorithm. Using inversions we can apply the algorithm once for all subproblems and do not have to solve each subproblem separately.

\paragraph{Label-Setting Algorithm} \parfill

We solve the (SPPRC) via a label-setting algorithm. Previously in this section, we have added resources to the graph in order to restrict the set of feasible paths. Since we do not have a cost function, finding an optimal path is not straight-forward. We do not have a shortest path but multiple resource-feasible paths. We use the resource dominance relation $\sqsubseteq$ to compare different paths. If a path is dominated by another, it is not preferable and therefore not considered in the solution. If two paths are not comparable, we cannot decide which one is more preferable. This leads to the concept of Pareto-optimality.

\begin{definition}[Pareto-optimal paths]

Let ${H:=\left(V_H,A_H,\sqsubseteq,I,\REF\right)}$ be a graph with resource constraints. Let $P$ be a resource-feasible $v$-$w$-path in $H$.

$P$ is called Pareto-optimal if there exist witnesses $\left(r^u\right)_{u\in P}$ for the resource-feasibility of $P$ such that for every resource-feasible $v$-$w$-path $Q$ in $H$ with witnessing resource vectors $\left(\tilde{r}^u\right)_{u\in Q}$ fulfilling ${\tilde{r}^v = r^v}$ holds:
\begin{align*}
	r^w\sqsubseteq \tilde{r}^w \Rightarrow r^w = \tilde{r}^w
\end{align*}

We say that the resource vectors $\left(r^u\right)_{u\in P}$ witness Pareto-optimality of $P$.

\end{definition}

In general, there can be exponentially many paths in a graph with respect to its size. It is further possible no two of the witnessing resource vectors are comparable. Hence, there can be an exponential number of Pareto-optimal paths in a graph. This fact gives a feeling why (SPPRC) is $\mathcal{NP}$-hard.

The idea of the algorithm is to start with a trivial path, consisting of one single vertex. We then extend the paths while we maintain resource-feasibility and Pareto-optimality for all paths. Finally, we receive Pareto-optimal paths from the starting vertex to all vertices. The algorithm works on the concept of Dynamic Programming.

\begin{algorithm}[hbt]
	\SetAlgoLined
	\KwIn{graph with resource constraints ${H:=\left(V_H,A_H,\sqsubseteq,I,\REF\right)}$, topological sorting ${v_0,\dots,v_n}$ of $V_H$ and initial resource vector $r^{v_0}$}
	\KwOut{shortest path tree rooted at $\left(v_0,r^{v_0}\right)$ encoded by $\delta$}
	$\mathcal{P}_{v_0}\gets\left\{r^{v_0}\right\}$ \;
	$\delta\left(v_0,r^{v_0}\right)\gets\emptyset$ \;
	\lForEach{$i\in\left\{1,\dots,n\right\}$}{$\mathcal{P}_{v_i}\gets\emptyset$}
	\ForEach{$i=0,\dots,n$}{
		\ForEach{$r^{v_i}\in\mathcal{P}_{v_i}$}{
			\ForEach{$w\in\operatorname{N}^+_H\left(v_i\right)$}{
				$\mathcal{P}\gets\max_{\sqsubseteq}\REF_{v_i,w}\left(r^{v_i}\right)$ \;
				\lForEach{$r^w\in\mathcal{P}$}{$\delta\left(w,r^w\right)\gets\left(v_i,r^{v_i}\right)$}
				$\mathcal{P}_w\gets\mathcal{P}_w\cup\mathcal{P}$ \;
				$\mathcal{P}_w\gets\max_{\sqsubseteq}\mathcal{P}_w$ \;
			}
		}
	}
	\Return{$\delta$}
	\caption{Label-setting algorithm for acyclic graphs with resource constraints}
	\label{alg:label_setting}
\end{algorithm}

We have a graph with resource constraints, a topological sorting of the vertices and an initial resource vector as input. The graph has to be acyclic. A topological sorting ${\left\{v_0,\dots,v_n\right\}}$ means that there are no $i<j$ with ${\left(v_j,v_i\right)\in A_H}$. Starting with a vertex $v_0$ and an initial resource vector $r^{v_0}$, we treat the vertices successively in topological order. For each vertex $v\in V_H$ and for each computed Pareto-optimal $v_0$-$v$-path, we try to extend the path feasibly by a single vertex. If a path is found, we add a label to the extending vertex and update the mapping $\delta$ in order to identify the origin of the extension. At the end, we receive the mapping $\delta$ which identifies all resource-feasible Pareto-optimal $v_0$-$v$-paths for each vertex $v\in V_H$.

In the following, we show how we apply the (SPPRC) and \Cref{alg:label_setting} to the subproblem $\eqref{eq:SPv}$.

%----------------------------------------------------------------------------------------------------------------------------------------

\subsection{Strengthening Inequalities}

First we insert additional valid inequalities. They are not necessary but may improve the column generation process. In the original problem, we have the linking constraints $\eqref{eq:MMILP:customer}$ and $\eqref{eq:MMILP:route}$ which ensure that for every customer exactly one route is fulfilled. These constraints cannot be moved into the subproblems since the customers can be satisfied by different vehicles. It is even likely that two trips of the same route are fulfilled by different vehicles.

Nevertheless, we can identify duties that are infeasible with respect to the cover constraints. This is the case, if a vehicle fulfills two trips that belong to the same customer but not to the same route. If this duty is part of the overall solution, it is not possible that $\eqref{eq:MMILP:customer}$ and $\eqref{eq:MMILP:route}$ are fulfilled simultaneously. Therefore, we want to prevent such a duty from being added to the column set.

In order to use the inequalities, we have to introduce decision variables $u_m\in\{0,1\}$ for $m\in\mathcal{M}$. We insert the following inequalities to $\eqref{eq:SPv}$ for each $\vinV$. They are not necessary since they are implied by the cover constraints of the master problem, but they strengthen the formulation of the subproblem.
\begin{align}
	& \sum_{m\in C^{-1}(c)} u_m \leq 1 && \text{for all } c\in\mathcal{C} \label{eq:SPv:customer} \\
	& \sum_{s\in\Nin(t)} x_{s,t} \leq u_m && \text{for all } m\in\mathcal{M}, t\in m \label{eq:SPv:route}
\end{align}

These constraints ensure that for every customer at most one route can be fulfilled. Note that $\eqref{eq:SPv:customer}$ is also valid with equality. Adding these constraints possibly makes the subproblems harder to solve, but improves the behavior in the master problem since there are no duties added that are infeasible from the very beginning. If the addition is beneficial for the overall process, is not known in advance.

%----------------------------------------------------------------------------------------------------------------------------------------

\subsection{Determination of the Resources}
\label{sec:resources}

We define the resources that are needed to solve the $\eqref{eq:SPv}$. The only resource that we have used so far is the fuel resource. We use the index \emph{fuel} in our resource vector. The fuel is in the interval $[0,1]$ for the fuel level where $0$ means that the vehicle has no fuel and $1$ that the vehicle is completely fueled. A higher fuel level is preferable, hence the resource relation for fuel is $\leq$.

Since we have no objective function in this problem, we model the reduced cost as an additional resource. We introduce the index \emph{redcost} in order to keep track of the reduced cost of a duty. The reduced cost is unrestricted and a smaller reduced cost is preferable, thus we set the resource window to $\mathbb{R}$ and the resource relation to $\geq$.

An additional resource is the number of trips that a vehicle fulfills. We call it the length of a duty and use the index \emph{length}. This resource is not necessary for the subproblem but advantageous for the branch-and-bound procedure as we see in \Cref{sec:solving_masterproblem}. The length of a duty lies in the interval $[0,|\mathcal{T}|]$. Comparing two duties with different lengths, it is not clear which of them is preferable. Thus the resource relation is $=$.

In order to ensure the constraints $\eqref{eq:SPv:customer}$ and $\eqref{eq:SPv:route}$, we use a resource for every multimodal route. We use the respective $m\in\mathcal{M}$ as index for the route resource. This resource indicates how many trips of this route can still be fulfilled within this duty. Initially, all trips of a route can be fulfilled, thus the resource window is $[0,|m|]$ for $m\in\mathcal{M}$. Similar to the duty length it is not possible to compare different route resources, therefore the resource relation is $=$.

Altogether, we consider resources ${\mathcal{U} := \left\{\operatorname{redcost},\operatorname{fuel},\operatorname{length}\right\}\cupdot\mathcal{M}}$ in the resource window
\begin{align*}
	I := \mathbb{R}\times[0,1]\times[0,|\mathcal{T}|]\times\bigotimes_{m\in\mathcal{M}}[0,|m|]\subseteq\mathbb{R}^{\mathcal{U}}.
\end{align*}

A resource vector $r\in I$ consists of the reduced cost ${r_{\operatorname{redcost}}\in\mathbb{R}}$, the fuel level ${r_{\operatorname{fuel}}\in[0,1]}$, the duty length ${r_{\operatorname{length}}\in[0,|\mathcal{T}|]}$ and the route resources ${r_m\in[0,|m|]}$ for $m\in\mathcal{M}$ in this order. The resource relation vector is given by ${\sqsubseteq := \left(\geq,\leq,=,=,\dots,=\right)}$.

These resources coincide in large parts with the formulation in \cite{Kaiser}. They use resources for each customer instead of route resources in order to ensure the single-leg cover constraints. This is the only adaption of the resources.

%----------------------------------------------------------------------------------------------------------------------------------------

\subsection{Determination of the Resource Extension Function}
\label{sec:ref}

In this section, we determine the resource extension function such that we receive a formulation equivalent to the $\eqref{eq:SPv}$. We first define a more complex graph with simple resource extension functions. Then we contract the graph in order to shift the complexity from the graph into the functions.

\paragraph{Extended Task Graph with Split Vertices} \parfill

In the (SSPRC) as defined in \Cref{sec:spprc}, changes of the resource vectors are only defined on the arcs. This means, only resources occurring on the arcs are considered. Since we have also a trip cost and fuel consumption at the vertices of the task graph, we modify the graph in order to deal with vertex resources. Therefore, we create a graph by splitting the vertices, based on the extended task graph $\widehat{G}=\left(\widehat{V},\widehat{A}\right)$ according to \Cref{def:extended_taskgraph}. 

We define the extended task graph with split vertices ${\widetilde{G} := \left(\widetilde{V},\widetilde{A}\right)}$ with vertex set
\begin{align*}
	\widetilde{V} := \left\{\ds,\de\right\}\cupdot\left\{s^-,s^+\mid s\in\widehat{V}\backslash\left\{\ds,\de\right\}\right\}
\end{align*}

and arc set
\begin{align*}
	\widetilde{A} := & \left\{\left(\ds,s^-\right)\mid \left(\ds,s\right)\in\widehat{A}\right\}\cupdot\left\{\left(s^+,\de\right)\mid\left(s,\de\right)\in\widehat{A}\right\} \\
	& \cupdot\left\{\left(s^+,t^-\right)\mid (s,t)\in\widehat{A}\right\}\cupdot\left\{\left(s^-,s^+\right)\mid s\in\widehat{V}\backslash\left\{\ds,\de\right\}\right\}.
\end{align*}

Based on the graph $\widetilde{G}$, we define the resource extension functions $\widetilde{\operatorname{REF}}$. For this, we use $\sqsubseteq$ and $I$ as described in \Cref{sec:resources}. The values $\gamma_t$ for $t\in\mathcal{T}$ and $\mu_v$ for the specific $\vinV$ come from the dual solution of $\eqref{eq:DLRMP}$, from which the subproblem results. We define the resource extension function
\begin{align*}
	\widetilde{\operatorname{REF}}_{t,t'}(c,e,l,b) && \text{for } \left(t,t'\right)\in\widetilde{A} \text{ and } (c,e,l,b)\in I.
\end{align*}

The values $c, e, l$ denote the reduced cost, fuel and length resource, respectively. The value ${b=\left(b_m\right)_{m\in\mathcal{M}}}$ stands for the route resources. 

In the arc between the split vertices of a vehicle $\vinV$ occurs the reduced cost $-\mu_v$ and the fuel consumption $\left(1-f^0_v\right)$ due to the initial fuel $f^0_v$. Thus we define the resource extension function for $\vinV$ as:
\begin{align*}
	\widetilde{\REF}_{v^-,v^+}(c,e,l,b) := \left(\left(
	\begin{array}{c}
		c-\mu_v \\ e-\left(1-f^0_v\right) \\ l \\ b
	\end{array}
	\right) + \mathbb{R}^{\mathcal{U}}_{\sqsubseteq 0}\right) \cap I
\end{align*}

In refuel points we have the fuel consumption $\ft_r$, thus we define the resource extension function for each refuel point $r$ as:
\begin{align*}
	\widetilde{\REF}_{r^-,r^+}(c,e,l,b) := \left(\left(
	\begin{array}{c}
		c \\ e-\ft_r \\ l \\ b
	\end{array}
	\right) + \mathbb{R}^{\mathcal{U}}_{\sqsubseteq 0}\right) \cap I
\end{align*}

If a trip~$t\in\mathcal{T}$ is fulfilled in this duty, no other trip of the same customer must be fulfilled, unless it belongs to the same route. Therefore, we introduce an auxiliary function. For ${t\in\mathcal{T}}$ and  the route resource vector ${b\in\bigotimes_{m\in\mathcal{M}}\left[0,|m|\right]}$, we define
\begin{gather*}
	a^t:\bigotimes_{m\in\mathcal{M}}\left[0,|m|\right] \to \bigotimes_{m\in\mathcal{M}}\left[-1,|m|\right], \\
	a^t_m(b) = \left\{ \begin{array}{cl} b_m & \text{if } \left(C\circ M\right)(t)\neq C(m) \\ b_m - 1 & \text{if } M(t)=m \\ 0 & \text{if } \left(C\circ M\right)(t)=C(m) \text{ and } M(t)\neq m. \end{array} \right.
\end{gather*}

If trip ${t\in\mathcal{T}}$ is covered by the vehicle, then at most one trip less of the same route can be fulfilled. No other trip that belongs to another route of the same customer can be fulfilled, while the routes of other customers are not affected. If we have already ${b_{M(t)}=0}$, then ${a^t_{M(t)}(b)\cap [0,1] = \emptyset}$ and then $t$ cannot be fulfilled.

In ${t\in\mathcal{T}}$ further occurs the cost ${\ct_t-\gamma_t}$, the fuel consumption is $\ft_t$ and the length of the duty increases by~$1$. Therefore, we define the resource extension function for $t\in\mathcal{T}$ as:
\begin{align}
	\widetilde{\REF}_{t^-,t^+}(c,e,l,b) := \left(\left(
	\begin{array}{c}
		c+\ct_t-\gamma_t \\ e-\ft_t \\ l+1 \\ a^t(b)
	\end{array}
	\right) + \mathbb{R}^{\mathcal{U}}_{\sqsubseteq 0}\right) \cap I \label{eq:ref_trip}
\end{align}

Between two trips occurs the cost and the fuel consumption for the deadhead trip. Therefore we have for ${(s,t)\in A\cap\left(\mathcal{T}\cupdot\mathcal{R}\right)^2}$:
\begin{align*}
	\widetilde{\REF}_{s^+,t^-}(c,e,l,b) := \left(\left(
	\begin{array}{c}
		c + \cd_{s,t} \\ e-\fd_{s,t} \\ l \\ b
	\end{array}
	\right) + \mathbb{R}^{\mathcal{U}}_{\sqsubseteq 0}\right) \cap I
\end{align*}

Between a vehicle and a trip we additionally have to consider the fixed vehicle cost $\cv$, thus the resource extension function for ${(s,t)\in A\cap\left(\mathcal{V}\times\left(\mathcal{T}\cupdot\mathcal{R}\right)\right)}$ is defined as:
\begin{align*}
	\widetilde{\REF}_{s^+,t^-}(c,e,l,b) := \left(\left(
	\begin{array}{c}
		c + \cv + \cd_{s,t} \\ e-\fd_{s,t} \\ l \\ b
	\end{array}
	\right) + \mathbb{R}^{\mathcal{U}}_{\sqsubseteq 0}\right) \cap I
\end{align*}

For all arcs incident with $\ds$ or $\de$, the resource extension function is the function corresponding to the identity, \ie ${\left((c,e,l,b)+\mathbb{R}^{\mathcal{U}}_{\sqsubseteq 0}\right)\cap I}$.

\paragraph{Extended Task Graph} \parfill

We transform the extended task graph with split vertices ${\widetilde{G}=\left(\widetilde{V},\widetilde{A},\sqsubseteq,I,\widetilde{\REF}\right)}$ by contracting the arcs $\left(t^-,t^+\right)$ for all $t\in\widehat{V}\backslash\left\{\ds,\de\right\}$. Then we identify $t^+$ with $t$ for all $t\in\widehat{V}\backslash\left\{\ds,\de\right\}$ and receive the extended task graph ${\widehat{G}=\left(\widehat{V},\widehat{A},\sqsubseteq,I,\widehat{\REF}\right)}$ with
\begin{align*}
	\widehat{\REF}_{s,t} = \widetilde{\REF}_{t^-,t^+}\circ\widetilde{\REF}_{s^+,t^-}
\end{align*}

for all $s,t\in\widehat{V}\backslash\left\{\ds,\de\right\}$. The graph ${\widehat{G}=\left(\widehat{V},\widehat{A}\right)}$ is the extended task graph according to \Cref{def:extended_taskgraph}. For arcs starting from a refuel point or a trip and leading to a trip, \ie ${(s,t)\in\widehat{A},s\notin\mathcal{V},t\in\mathcal{T}}$, we have:
\begin{align*}
	\widehat{\REF}_{s,t}(c,e,l,b) := \left(\left(
	\begin{array}{c}
		c + \cd_{s,t} + \ct_{s,t} - \gamma_t \\ e - \fd_{s,t} - \fd_{s,t} \\ l + 1 \\ a^t(b)
	\end{array}
	\right) + \mathbb{R}^{\mathcal{U}}_{\sqsubseteq 0}\right) \cap I
\end{align*}

since $\fd_{s,t}\geq 0$ and $\ft_t\geq 0$. The resources are independent from each other.

For arcs starting at a trip and leading to a refuel point, \ie ${(s,r),(s,t)\in A}$, ${s\in\mathcal{T}}$, ${r\in\Rst}$, we have:
\begin{align*}
	\widehat{\REF}_{s,r}(c,e,l,b) := \left\{ \begin{array}{cl}
		\left(\left( \begin{array}{c}
			c + \cd_{s,r} \\ e - \fd_{s,r} - \ft_r \\ l \\ b
		\end{array} \right) + \mathbb{R}^{\mathcal{U}}_{\sqsubseteq 0}\right) \cap I & \text{if } e\geq\fd_{s,r} \\
		\\
		\emptyset & \text{otherwise}
	\end{array} \right.
\end{align*}

Note that ${\ft_r\leq 0}$.

For both cases, we extend the evaluation to $s\in\mathcal{V}$ by adding $\cv$ to the reduced cost resource. For arcs incident with $\ds$ or $\de$ we have:
\begin{align*}
	\widehat{\REF}_{\ds,s}=\widetilde{\REF}_{s^-,s^+} && \widehat{\REF}_{s,\de}=\widetilde{\REF}_{s^+,\de} && \text{for } s\in\mathcal{V}\cupdot\mathcal{T}
\end{align*}

\paragraph{Task Graph} \parfill

We transform the extended task graph ${\widehat{G}=\left(\widehat{V},\widehat{A},\sqsubseteq,I,\widehat{\REF}\right)}$ by contracting the arcs ${(r,t)\in\widehat{A}}$ for all ${s,t\in\mathcal{V}\cupdot\mathcal{T}}$ with ${s\prec t}$ and ${r\in\Rst}$. This yields the task graph ${G=\left(V,A,\sqsubseteq,I,\REF\right)}$ which builds on the task graph ${G=\left(V,A\right)}$ according to \Cref{def:taskgraph}.

For every arc $(s,t)\in A$ with $s\notin\mathcal{V}, t\in\mathcal{T}$ and $r\in\Rst$, we determine the resource vectors ${\left(\widehat{\REF}_{r,t}\circ\widehat{\REF}_{s,r}\right)(c,e,l,b)}$ as
\begin{align*}
	\begin{array}{cl}
		\left(\left( \begin{array}{c}
			c + \cd_{s,r} + \cd_{r,t} + \ct_t - \gamma_t \\ \min\left(e-\fd_{s,r}-\ft_r, 1\right) - \fd_{r,t} - \ft_t \\ l + 1 \\ a^t(b)
		\end{array} \right) + \mathbb{R}^{\mathcal{U}}_{\sqsubseteq 0} \right) \cap I & \text{if } e\geq\fd_{s,r} \\
		\\
		\emptyset & \text{otherwise.}
	\end{array}
\end{align*}

For $s\in\mathcal{V}$, we add $\cv$ to the reduced cost resource. According to \Cref{def:contraction}, the resource extension function is then given by
\begin{align*}
	& \REF_{s,t}(c,e,l,b) = \widehat{\REF}_{s,t}(c,e,l,b)\cup\bigcup_{r\in\Rst}\left(\widehat{\REF}_{r,t}\circ\widehat{\REF}_{s,r}\right)(c,e,l,b) \\
	= & \left[\left(\left(\begin{array}{c}
		c + \cd_{s,t} + \ct_t - \gamma_t \\ e - \fd_{s,t} - \ft_t \\ l + 1 \\ a^t(b)
	\end{array} \right) + \mathbb{R}^{\mathcal{U}}_{\sqsubseteq 0}\right)\cap I\right] \\
	\cup & \left[\left(\left\{\left(\begin{array}{c}
		c + \cd_{s,r} + \cd_{r,t} + \ct_t - \gamma_t \\ \min\left(e-\fd_{s,r}-\ft_r,1\right) - \fd_{r,t} - \ft_t \\ l + 1 \\ a^t(b)
	\end{array}\right) \mid r\in\Rst, e\geq\fd_{s,r}\right\} + \mathbb{R}^{\mathcal{U}}_{\sqsubseteq 0}\right)\cap I\right]
\end{align*}

for $s\notin\mathcal{V}$ and with an additional $\cv$ in the first component of all vectors for $s\in\mathcal{V}$.

%----------------------------------------------------------------------------------------------------------------------------------------

\subsection{Algorithms for Solving the Subproblems}

After specification of the resources and the resource extension function, we present an algorithm that solves the subproblem for every vehicle optimally.

\paragraph{Model Equivalence} \parfill

First, we prove that the previously developed problem formulation is equivalent to the subproblem and that the values for the reduced cost coincide.

\begin{theorem}[Correspondence to $\eqref{eq:MMILP}$]
\label{th:equivalence_SPv_MMILP}

For every resource-feasible $\ds$-$\de$-path ${P:=\left(\ds,v,t_1,\dots,t_n,\de\right)}$ with $n\in\mathbb{N}_0$ in the graph ${G=\left(V,A,\sqsubseteq,I,\REF\right)}$ with witnessing resource vectors $\left(r^v\right)_{v\in P}$, there is a feasible solution ${(x,z,e,u)\in X_v}$ satisfying $\eqref{eq:SPv:customer}$ and $\eqref{eq:SPv:route}$ such that
\begin{align*}
	g^v(x,z,e,u)\leq r^{\de}_{\operatorname{redcost}} - r^{\ds}_{\operatorname{redcost}}.
\end{align*}

Inversely, for every feasible solution ${(x,z,e,u)\in X_v}$ to some subproblem $\vinV$ that satisfies $\eqref{eq:SPv:customer}$ and $\eqref{eq:SPv:route}$, there is a resource-feasible $\ds$-$\de$-path ${P:=\left(\ds,v,t_1,\dots,t_n,\de\right)}$, $n\in\mathbb{N}_0$ in ${G=\left(V,A,\sqsubseteq,I,\REF\right)}$ with witnessing resource vectors $\left(r^v\right)_{v\in P}$ such that the equation ${g^v(x,z,e)=r^{\de}_{\operatorname{redcost}} - r^{\ds}_{\operatorname{redcost}}}$ holds.

\end{theorem}

This theorem is proven by \cite[pp.~96-99]{Kaiser} for a slightly modified problem. The strengthening inequality is adapted to single-leg cover constraints and the route resource is a customer resource there. This has also an impact on the resource extension function. We do not present the complete proof, but only the parts that are different here. This concerns mainly the decision variable $u_m$ and the route resources $r_m$ for ${m\in\mathcal{M}}$.

\begin{proof}

We show that we can create a solution of $\eqref{eq:MMILP}$ out of a resource-feasible path and vice versa.

\paragraph{\enquote{$\boldsymbol{\Rightarrow}$}: Resource-feasible path to feasible solution} \proofparfill

Let ${P:=\left(\ds,t_0,t_1,\dots,t_n,\de\right)}, {n\in\mathbb{N}_0}$ be a resource-feasible $\ds$-$\de$-path in\linebreak
${G=\left(V,A,\sqsubseteq,I,\REF\right)}$ with witnessing resource vectors $\left(r^s\right)_{s\in P}$. Construct the following solution $(x,z,e,u)$: For $a\in A$, set $x_a$ to $1$ if the path $P$ uses the arc $a$ and $0$ otherwise. Set ${e_s := r^s_{\operatorname{fuel}}}$ if $s\in P$ and $e_s:=0$ otherwise. For all $i\in[n]$ and $r\in\mathcal{R}_{t_{i-1},t_i}$, set ${z_{t_{i-1},r,t_i} := 1}$ if ${r^{t_{i-1}}\in\left(\REF_{r,t_i}\circ\REF_{t_{i-1},r}\right)\left(r^{t_{i-1}}\right)}$ and ${z_{t_{i-1},r,t_i} := 0}$ otherwise. If this holds true for more than one ${r\in\mathcal{R}_{t_{i-1},t_i}}$, change $z_{t_{i-1},r,t_i}$ to $0$ for all such $r$ but one. For all other arcs $a\in A$, set $z_a:=0$. For all $m\in\mathcal{M}$ set ${u_m := 1}$ if there is an ${i\in[n]}$ such that ${M\left(t_i\right)=m}$ and ${u_m := 0}$ otherwise. We claim that $(x,z,e,u)\in X_v$, \ie $(x,z,e,u)$ is a feasible solution to the subproblem of vehicle $v:=t_0$.

The flow conservation and the fuel constraints hold as proven by \cite{Kaiser}. This applies directly since the respective parts of $X_v$ and $\REF$ have not been modified. The claim concerning the reduced cost is also proven there.

Due to $\eqref{eq:MMILP:flow}$ and $\eqref{eq:MMILP:xst}$ we have ${\sum_{s\in\operatorname{N}^-_{G}(t)} x_{s,t} \in\{0,1\}}$ for all $t\in\mathcal{T}$. From the construction follows that
\begin{align*}
	\sum_{s\in\operatorname{N}^-_{G}(t)} x_{s,t} = 1 && \Rightarrow && t\in P && \Rightarrow && u_{M(t)} = 1
\end{align*}

for all $t\in\mathcal{T}$ and therefore $\eqref{eq:SPv:route}$. For constraint $\eqref{eq:SPv:customer}$, we assume by contradiction that there is a $m\in\mathcal{M}$ with ${\sum_{m\in C^{-1}(c)} u_m > 1}$. Then there exist ${i,j\in[n]}$ with ${i<j}$ such that
\begin{align*}
	t_i,t_j\in P && \text{and} && M\left(t_i\right)\neq M\left(t_j\right) && (M\circ C)\left(t_i\right) = (M\circ C)\left(t_j\right).
\end{align*}

Due to the definition of $\REF_{t_{i-1},t_i}$ we have ${a^{t_i}_{M\left(t_j\right)}(b) = 0}$ for all ${b\in I_{\mathcal{M}}}$. The route resource is monotonously decreasing along each path. Therefore
\begin{align*}
	r^{t_i}_{M\left(t_j\right)}=0 && \Rightarrow && r^{t_{j-1}}_{M\left(t_j\right)} = 0 && \Rightarrow && r^{t_j}_{M\left(t_j\right)} = r^{t_{j-1}}_{M\left(t_j\right)} - 1 = -1 && \Rightarrow && r^{t_j} \notin I.
\end{align*}

This leads to contradiction to the resource-feasibility of $P$ and therefore holds $\eqref{eq:SPv:customer}$.

\paragraph{\enquote{$\boldsymbol{\Leftarrow}$}: Feasible solution to resource-feasible path} \proofparfill

Let $(x,z,e,u)\in X_v$ for some $\vinV$. Set ${t_0 := v}$. By the definition of $X_v$ holds ${x_{\ds,t_0} = 1}$. Based on the flow conservation $\eqref{eq:MMILP:flow}$ and construction of the task graph $G$, the existence of exactly one ${t_1\in\mathcal{T}\cupdot\left\{\de\right\}}$ with ${x_{t_0,t_1} = 1}$ follows. This step can be repeated ${n\in\mathbb{N}_0}$ times for finding ${t_i\in\mathcal{T}\cupdot\left\{\de\right\}}, {i = 2,\dots,n+1}$ until ${t_{n+1}=\de}$ is reached. This defines a path ${P:=\left(\ds,t_0,\dots,t_n,\de\right)}$ in the task graph. Set the resource vectors $\left(r^s\right)_{s\in P}$ along this path as follows. For all vertices $t_k, {k\in\left\{0,\dots,n\right\}}$, set the reduced cost
\begin{align*}
	r^{t_k}_{\operatorname{redcost}} := \cv + \sum_{i=1}^k\left[ \vphantom{\sum_{r\in\mathcal{R}_{t_{i-1}}}} \right. & x_{t_{i-1},t_i}\left(\cd_{t_{i-1},t_i}+\ct_{t_i}-\gamma_{t_i}\right) + \\
	& \left. \sum_{r\in\mathcal{R}_{t_{i-1},t_i}} z_{t_{i-1},r,t_i}\left(\cd_{t_{i-1},r}+\cd_{r,t_i}-\cd_{t_{i-1},t_i}\right)\right] - \mu_v,
\end{align*}

the fuel level ${r^{t_k}_{\operatorname{fuel}} := e_{t_k}}$, the length ${r^{t_k}_{\operatorname{length}} := k}$ and the route resources
\begin{align*}
	r^{t_k}_m = \left\{\begin{array}{ccl}
		0 && \displaystyle{\text{if } \sum_{ \substack{i\in[k]: \\ (C\circ M)\left(t_i\right) = C(m) \\ M\left(t_i\right) \neq m} } \sum_{s\in\operatorname{N}^-_{G}\left(t_i\right)} x_{s,t_i} > 0} \\ \\
		\displaystyle{\vert m\vert - \sum_{ \substack{i\in[k]: \\ m = M\left(t_i\right)} } \sum_{s\in\operatorname{N}^-_{G}\left(t_i\right)} x_{s,t_i}} && \text{otherwise}
	\end{array}\right.
\end{align*}

for $m\in\mathcal{M}$. The route resource lies in the resource window since $\vert m\vert$ is chosen large enough. The resource vectors at the source and sink are set to ${r^{\ds} := \left(0,1,0,\left(\vert m\vert\right)_{m\in\mathcal{M}}\right)}$ and ${r^{\de} := r^{t_n}}$, respectively. We claim that these resource vectors $\left(r^s\right)_{s\in P}$ witness resource-feasibility of the path $P$ in the task graph $G$. 

The resource-feasibility for the resources \emph{fuel}, \emph{redcost} and \emph{length} are already proven by \cite{Kaiser}. This applies directly since the respective parts of $X_v$ and $\REF$ have not been modified.

For all $m\in\mathcal{M}$, we have ${r^{t_0}_m = \vert m\vert\in I_m}$. For ${k\in[n]}$, we distinguish the following cases for the resource-feasibility of $r^{t_k}_m$:
\begin{align*}
	\left. \begin{array}{lll}
		m = M\left(t_k\right) & \Rightarrow & r^{t_k}_m = r^{t_{k-1}}_m - 1, r^{t_k}_m\geq 0 \\
		C(m)\neq\left(C\circ M\right)\left(t_k\right) & \Rightarrow  & r^{t_k}_m = r^{t_{k-1}}_m \\
		\text{else} & \Rightarrow & r^{t_k}_m = 0
	\end{array} \right\} \Rightarrow r^{t_k}_m\in\REF_{t_{k-1},t_k}\left(r^{t_{k-1}}_m\right)
\end{align*}

We always have ${r^{t_k}_m\geq 0}$ since the initial value has been chosen large enough. Therefore, the above defined resource vector witnesses resource-feasibility for all $m\in\mathcal{M}$. This concludes the proof.

\end{proof}

\paragraph{Inversion of the Graph} \parfill

We have seen in \Cref{th:equivalence_SPv_MMILP} that the subproblem $\eqref{eq:SPv}$ can be written as a Shortest Path Problem with Resource Constraints. Therefore, we can apply \Cref{alg:label_setting} in order to solve the subproblem optimally. Since there is a subproblem for every vehicle $\vinV$, it is not advantageous to apply the algorithm for each subproblem separately. In order to improve this behavior we can exploit the symmetry of the problem. Remember, that the only differences of the subproblems are caused by the the dual variables $\left(\gamma_t,\mu_v\right)$ from the dual solution of $\eqref{eq:DLRMP}$. Thus, the subproblems vary only in the fact which vehicle is included. As we search $\ds$-$\de$-paths in the subproblem, only the second vertex of such a path is affected. 

From the results of \Cref{th:inversion} and \Cref{th:equivalence_SPv_MMILP} we can see that (SPPRC) given on the inverted task graph $G^{-1}$ is equivalent to the one given by $G$. As \Cref{alg:label_setting} yields Pareto-optimal paths from the starting vertex to each vertex in the graph, it is profitable to apply the algorithm to $G^{-1}$ with starting vertex $\de$. Thus, we receive Pareto-optimal $\de$-$v$-paths for all $\vinV$ in the inverted graph and we have to execute the algorithm only once. We can then extend the respective $\de$-$v$-paths to $\de$-$\ds$-paths and receive solutions for all the subproblems.

The following lemma shows that it is possible to invert the problem. It is a condition for \Cref{th:inversion} that the resource extension function is invertible.

\begin{lemma}[Invertibility of $\REF$]

The resource extension function $\REF$ is invertible. 

\end{lemma}

\begin{proof}

We will only prove that the resource extension function $\widetilde{\REF}$ restricted to the route constraints and to the split vertices of trips is invertible. \cite{Kaiser} has already shown that the resource extension function for the simplified problem is invertible setting and that invertibility is maintained if arcs are contracted. Since the parts of $\widetilde{\REF}$ are independent from each other, the 	invertibility of $\REF$ follows directly.

Let ${t\in\mathcal{T}}$ be arbitrary. For readability, we write the restriction of the resource extension function to the route resources $\widetilde{\REF}_{t^-,t^+}(c,e,l,b)$ as $F_{t^-,t^+}(b)$. The restricted resource window is ${I_{\mathcal{M}}:=\bigotimes_{m\in\mathcal{M}}[0,\vert m\vert]}$ and the resource dominance relation is ${\sqsubseteq_{\mathcal{M}} := \left(=,\dots,=\right)}$. Further we define the set
\begin{align*}
	\overline{M}(t) := C^{-1}\left((C\circ M)(t)\right)\backslash\left\{M(t)\right\}
\end{align*}

as the routes that must not be fulfilled after $t$.

Due to the definition of $\widetilde{\REF}$, we have
\begin{align*}
	F_{t^-,t^+}\left(b\right) = \left(a^t(b) + \mathbb{R}^{\mathcal{M}}_{\sqsubseteq_{\mathcal{M}} 0}\right) \cap I_{\mathcal{M}}.
\end{align*}

for ${t\in\mathcal{T}}$ and ${b\in I_{\mathcal{M}}}$. Due to the definition of $\sqsubseteq_{\mathcal{M}}$, we can rewrite this expression as follows:
\begin{align*}
	F_{t^-,t^+}\left(b\right) = \left\{a^t(b)\mid b_{M(t)}\geq 1\right\}
\end{align*}

Further, we examine the preimage of the auxiliary function $a^t$. This is given by
\begin{align*}
	\left(a^t_m\right)^{-1}(b) = \begin{cases} \left\{b_m + 1\right\} & \text{if } m = M(t) \\ [0,\vert m\vert] & \text{if } m\in\overline{M}(t) \\ \left\{b_m\right\} & \text{otherwise} \end{cases}
\end{align*}

for $\left\{b\in I_{\mathcal{M}}\mid b_{M(t)}\leq\vert M(t)\vert - 1, b_m=0 \text{ for all } m\in\overline{M}(t)\right\}$ and $\left(a^t\right)^{-1}(b) = \emptyset$ otherwise.

According to \Cref{def:inversion}, the inverted relation is given by
\begin{align*}
	F^{-1}_{t^-,t^+} := \left\{\left(r^{t^+},r^{t^-}\right)\mid \left(r^{t^-},r^{t^+}\right)\in F_{t^-,t^+}\right\}
\end{align*}

for all $t\in\mathcal{T}$. Applying the respective definitions we get:
\begin{align*}
	F_{t^-,t^+} & = \left\{\left(b, a^t(b)\right)\right. && \mid \left. b\in I_{\mathcal{M}}, b_{M(t)}\geq 1\right\} \\
	F^{-1}_{t^-,t^+} & = \left\{\left(a^t(b), b\right)\right. && \mid \left. b\in I_{\mathcal{M}}, b_{M(t)}\geq 1\right\} \\
	& = \left\{\vphantom{\bigotimes_{m\in\mathcal{M}}}\left(b, b'\right)\right. && \mid b\in I_{\mathcal{M}}, b_{M(t)}\leq\vert M(t)\vert-1, b_m=0 \text{ for all } m\in\overline{M}(t), \\
	&&& \left. b'\in\bigotimes_{m\in\mathcal{M}}\left(a^t_m\right)^{-1}(b)\right\}
\end{align*}

We show that $F^{-1}_{t^-,t^+}$ is a resource extension function with respect to $\sqsupseteq_{\mathcal{M}}$ for all $t\in\mathcal{T}$. Since ${\sqsubset_{\mathcal{M}} = \left(=,\dots,=\right)}$ holds ${\left(\sqsupseteq_{\mathcal{M}}\right) = \left(\sqsubseteq_{\mathcal{M}}\right)}$. Thus, for ${r^v,\tilde{r}^v\in I_{\mathcal{M}}}$ holds ${r^v\sqsupseteq\tilde{r}^v\Leftrightarrow r^v = \tilde{r}^v}$ and the conditions of \Cref{def:graph_resource_constraints} and \Cref{def:monotone_ref} are fulfilled.

Considering the other resources and contraction of vertices does not destroy the invertibility. Therefore $\REF$ is invertible.

\end{proof}

\paragraph{Heuristic Approach to the Subproblem} \parfill

For the column generation approach, it is sufficient to receive a duty with negative reduced cost for each vehicle. This solution is not necessarily optimal \wrt the negative reduced cost. This follows directly from the formulation $\eqref{eq:DLMP:index}$. Thus, we describe a heuristic approach for solving the subproblem. This is directly applied by \cite[pp.~104-107]{Kaiser}.

As the label-setting algorithm is very expensive as it create many labels, we try to decrease the number of possible labels by discretizing some continuous resources, \eg the fuel resource. For this, we define a discrete set of allowed fuel levels as
\begin{align*}
	\mathcal{E}\subseteq[0,1] && 0,1\in\mathcal{E} && \text{and} && \lfloor e\rfloor_{\mathcal{E}} := \max\left\{e'\in\mathcal{E}\mid e'\leq e\right\} && \text{for } e\in[0,1].
\end{align*}

Using the set of fuel levels $\mathcal{E}$, the fuel component of $\widehat{\REF}_{s,t}$ for ${s\in\mathcal{V}\cupdot\mathcal{T}}$, ${t\in\mathcal{T}}$ changes to
\begin{align*}
	e\mapsto \left(\left\lfloor e - \fd_{s,t} - \ft_t\right\rfloor_{\mathcal{E}}\right)\cap I_{\operatorname{fuel}}
\end{align*}

for $e\in I_{\operatorname{fuel}} = [0,1]$. Similarly, the fuel component for ${\widehat{\REF}_{r,t}\circ\widehat{\REF}_{s,r}}$ reads as
\begin{align*}
	e\mapsto \left\{\begin{tabular}{cr}
		$\displaystyle{\left(\left\lfloor\min\left(e - \fd_{s,r} - \ft_r, 1\right) - \fd_{r,t} - \ft_t\right\rfloor_{\mathcal{E}} + \mathbb{R}_{\leq 0}\right)\cap I_{\operatorname{fuel}}}$ & if $e\geq \fd_{s,r}$ \\
		$\emptyset$ & otherwise.
	\end{tabular}\right.
\end{align*}

The modified $\REF$ with fuel levels $\mathcal{E}$ is also an invertible resource extension function. Further, each duty that is resource-feasible in the heuristic is also feasible in the original formulation. This is proven by \cite{Kaiser}.

In the column generation process, we create columns with the heuristic methods. If the heuristic finds duties with negative reduced cost, we insert these duties to the index set. Only if we cannot find suitable duties we apply the optimal label-setting algorithm. If the optimal algorithm does not find any duties with negative reduced cost any more, we have reached an optimal solution to the relaxed master problem.

%########################################################################################################################################
%#
%#   Solving the Master Problem
%#
%########################################################################################################################################

\section{Solving the Master Problem}
\label{sec:solving_masterproblem}

With the methods developed in \Cref{sec:pathflow_formulation} and \Cref{sec:solving_subproblem} we are able to solve the relaxed master problem. Having a solution of this relaxed problem, it is not guaranteed that the solution is an integer solution. However, this is a condition for feasibility in the master problem. If the solution is a fractional solution, we apply a \enquote{Branch-and-Bound} process in order to receive an integer solution. We describe how Branch-and-Bound works in general and how we can apply this to our problem. Then we discuss a number of possible branching rules. Finally, we show how the branching rules are chosen. The branching rules are mainly taken over by the branching rules created by \cite{Kaiser}. The branching rule concerning the choice of routes is modified.

\subsection{Branch-and-Bound}

The set of feasible solutions for the relaxed problem is divided into two separate sets by a hyperplane. We express this restriction as an inequality. We evaluate both sets individually. An optimal solution of one of these sets is an optimal solution for the entire problem. If we repeat this procedure iteratively, we get smaller problems. This procedure is called \enquote{Branching}. We receive a tree of smaller problems where the root is the original master problem and the respective child nodes are the smaller problems resulting by branching.

The overall process works as follows: Starting with the root, we solve the respective relaxed problem. If we receive a fractional solution, we branch the problem and create child nodes. We continue this procedure for each child until we either receive a feasible integer solution or the problem becomes infeasible. After this, we iteratively assign to each node the feasible solution of its child nodes with the smallest objective value, or infeasible, if both child nodes are infeasible. Therefore, the solution assigned to the root is the optimal solution of the entire problem.

Depending on the problem and the branching strategy, the decision tree might become quite large. Therefore we have to think about methods to improve this behavior. If we already have an initial feasible solution, then the value of this solution is an upper bound to the optimal solution value. As we know, the value of the relaxation is a lower bound to the optimal value of this problem. Therefore, if the value of the relaxation for a subtree is greater than the value of the initial solution, we know that the optimal solution does not lie in this subtree. Thus we can completely neglect this subtree. This method is called \enquote{Bounding}.

\paragraph{Application to the Master Problem} \parfill

A branching decision is always an inequality that we add to the master problem. As suggested by \cite{Kaiser}, we only use inequalities written in terms of ${(x,z,e,u)\in X_v}, {\vinV}$ such that the structure of the subproblems is not changed. Further, we do not want to affect the symmetry of the subproblems since we exploit this when we solve the subproblems. Thus, we discuss the decision rules with respect to keeping the symmetry.

If an inequality concerns only one single subproblem, we move this restriction completely to the subproblem. This has the advantage that we still create feasible columns. However, moving the inequalities to the subproblems might lead to a change of their structure and therefore might make it harder to solve. In \Cref{sec:branching_rules} we discuss several branching rules.

%----------------------------------------------------------------------------------------------------------------------------------------

\subsection{Branching Rules}
\label{sec:branching_rules}

In the following, we present a number of branching rules. In order to keep the branching tree small, we try to create decisions that lead to a balanced branching. The branching is used for enforcing integrality in the master problem. In order to discuss the branching rules, we introduce for each vertex $v\in V$ the set of vertices that can be reached from $v$ and the set of vertices from which $v$ can be reached:
\begin{align*}
	\operatorname{N}_G^{++}(v) := \left\{w\in V\mid\exists v \text{-} w \text{-path in } G\right\} && \operatorname{N}_G^{--}(v) := \left\{w\in V\mid\exists w \text{-} v \text{-path in } G\right\}
\end{align*}

\paragraph{Assignment of Trips} \parfill

We first consider a branching on the components of the image with respect to $\psi$. This is a branching on the single variables of the master problem and thus the most specific branching rule we consider. We fix a value for the expression
\begin{align*}
	\psi\left(x^v,z^v,e^v\right)_t = \sum_{s\in\Nin(t)} x^v_{s,t} \in\left\{0,1\right\}
\end{align*}

for some $\vinV, t\in\mathcal{T}$. This decision can be interpreted as determining whether trip $t$ is fulfilled by vehicle $v$. This is a very specific decision since it implicitly chooses the route $M(t)$ for customer $(M\circ C)(t)$ and assigns trip $t$ to vehicle $v$.

Branching down means setting ${\sum_{s\in\Nin(t)} x^v_{s,t} = 0}$ for some $\vinV, t\in\mathcal{T}$. This can be implemented in $\eqref{eq:SPv}$ by setting
\begin{align*}
	x^v_{s,t}=0 && \text{for all } s\in\Nin(t).
\end{align*}

This corresponds to deleting the respective arcs in the task graph corresponding to subproblem~$v$.

Branching up means demanding ${\sum_{s\in\Nin(t)} x^v_{s,t} = 1}$ for some $\vinV, t\in\mathcal{T}$. With the constraints $\eqref{eq:MMILP:flow}, \eqref{eq:Xv:vehicle}, \eqref{eq:Xv:other_vehicles}$ and the fact that $G$ is acyclic, this is equivalent to setting
\begin{align*}
	x^v_{s,u} = 0 && \text{for all } (s,u)\in A\cap\left(\left(\operatorname{N}_G^{--}(t)\backslash\{t\}\right)\times\left(\operatorname{N}_G^{++}(t)\backslash\{t\}\right)\right).
\end{align*}

This corresponds to deleting all arcs skipping trip $t$.

According to the cover constraints $\eqref{eq:MMILP:route}$ and $\eqref{eq:MMILP:linking}$, branching up implicitly choose the route for customer $(C\circ M)(t)$. Therefore, it further demands
\begin{align*}
	x^v_{s,t'} = 0 && \text{for all } v\in\mathcal{V}, t'\in\overline{M}(t), s\in\Nin(t').
\end{align*}

Hence all trips belonging to another route of the same customer are deleted. This applies for all subproblems simultaneously.

While branching up excludes a lot of possible assignments, branching down only forbids one such assignment. This leads to a quite unbalanced tree. Another disadvantage is that this rule destroys symmetry between the subproblems as it concerns only one subproblem. Nevertheless, there is always a branching decision that can be made if the previous solution was not integral. This means, this rule is enough to completely ensure integrality in the master problem.

\paragraph{Length of Vehicle Duties} \parfill

Another suggestion is to consider not a single trip, but the sum up over all trips for the components of the image of $\psi$. We fix a value for the expression
\begin{align*}
	\sum_{t\in\mathcal{T}}\psi\left(x^v,z^v,e^v\right)_t = \sum_{t\in\mathcal{T}} \sum_{s\in\Nin(t)} x^v_{s,t} \in\left\{0,\dots,\vert\mathcal{T}\vert\right\}
\end{align*}

for some $\vinV$. This can be interpreted as determining the duty length for vehicle $v$. As the length of the duty can be expressed linearly in terms of $\left(x^v,z^v,e^v\right)$ and in terms of images of $\psi$ it would be possible to include this decision in the master problem without changing the subproblems. But since this decision affects only one specific vehicle, we move it to the subproblem.

This leads to the following general setting of the subproblem using a lower bound $l^{\operatorname{LB}}$ and an upper bound $l^{\operatorname{UB}}$ for the vehicle length.
\begin{align}
	\min \quad & g^v\left(x^v,z^v,e^v\right) \nonumber \\
	\text{s.t.} \quad & l^{\operatorname{LB}} \leq \sum_{t\in\mathcal{T}} \sum_{s\in\Nin(t)} x^v_{s,t} \leq l^{\operatorname{UB}} \label{eq:SPv:duty_length} \\
	& \left(x^v,z^v,e^v\right)\in X_v \nonumber
\end{align}

As proven by \cite{Kaiser}, this problem can be solved by using the resource length as introduced before. We modify the resource extension function for $(c,e,l,b)\in I$ and ${t\in\mathcal{V}\cupdot\mathcal{T}}$ as follows:
\begin{align*}
	\REF_{t,\de}(c,e,l,b) := \left(\left\{(c,e,l,b)\mid l^{\operatorname{LB}}\leq l \leq l^{\operatorname{UB}}\right\} + \mathbb{R}^{\mathcal{U}}_{\sqsubseteq 0}\right) \cap I
\end{align*}

This is a coarser branching rule than the assignment of trips, but still destroys the symmetry between the subproblems. In contrast to before, this rule alone is not sufficient to completely ensure the integrality in the master problem.

\newpage

\paragraph{Choice of Multimodal Routes} \parfill

The next approach is to sum up over all vehicles for the components of the image of $\psi$. We fix a value for the expression
\begin{align*}
	\sum_{\vinV}\psi\left(x^v,z^v,e^v\right)_t = \sum_{\vinV} \sum_{s\in\Nin(t)} x^v_{s,t} \in\left\{0,1\right\}
\end{align*}

for some $t\in\mathcal{T}$. This can be interpreted as deciding whether trip $t$ is fulfilled by some vehicle. Because of the cover constraint $\eqref{eq:MMILP:linking}$, this decision directly determines the route variable $u_m$ for ${m := M(t)}$ and therefore all other trips ${t'\in M^{-1}(m)}$. Because of this implication, we directly regard the case of branching on $u_m$.

Branching down means setting ${u_m = 0}$ for some ${m\in\mathcal{M}}$. By $\eqref{eq:MMILP:linking}$ follows\linebreak
${\sum_{s\in\Nin(t)}x_{s,t}^v = 0}$ for all ${t\in M^{-1}(m)}, \vinV$ and therefore
\begin{align*}
	x^v_{s,t} = 0 && \text{for all } \vinV, t\in M^{-1}(m), s\in\Nin(t).
\end{align*}

This corresponds to deleting the respective arcs in all task graphs.

Branching up means setting ${u_m = 1}$ for some ${m\in\mathcal{M}}$ and therefore demanding\linebreak
${\sum_{s\in\Nin(t)}x_{s,t}^v = 1}$ for all ${t\in M^{-1}(m)}, \vinV$. Due to the cover constraint $\eqref{eq:MMILP:customer}$ this is equivalent to setting ${u_{m'} = 0}$ for all ${m'\in\left(C^{-1}\circ C\right)(m)\backslash\{m\}}$. We therefore set
\begin{align*}
	x^v_{s,t} = 0 && \text{for all } & \vinV, m'\in\left(C^{-1}\circ C\right)(m)\backslash\{m\}, \\
	&&& t\in M^{-1}(m'), s\in\Nin(t).
\end{align*}

In other words, stating that a multimodal route is fulfilled by some vehicle is equivalent to stating that all trips belonging to other routes of the same customer are not fulfilled by any vehicle, if $\eqref{eq:MMILP:customer}$ and $\eqref{eq:MMILP:linking}$ hold. Again, this can be realized by deleting the respective arcs in all task graphs.

This branching rule maintains the symmetry for the various subproblems since for all $\vinV$ the same arcs are deleted. Therefore, we can still solve all subproblems by just one execution of the algorithm. Further, the tree is more balanced than before. Similar to the duty length, this rule alone is not sufficient to completely ensure integrality in the master problem.

\paragraph{Number of Used Vehicles} \parfill

Finally, we regard the branching on the number of used vehicles. We say, a vehicle is used if it fulfills at least one trip. The only duty that a vehicle can have to be unused is the duty with no trip, uniquely described by the path ${\left(\ds,v,\de\right)}$ in $G$. For a duty $(x,z,e)\in X_v, \vinV$ the term
\begin{align*}
	\sum_{(s,t)\in A\cap\left(\mathcal{V}\times\mathcal{T}\right)} x^v_{s,t}\in\left\{0,1\right\}
\end{align*}

is one if and only if the vehicles serves at least one trip. One possibility would be to decide if a specific vehicle is used or not. But the various subproblems are too similar as only the vehicle vertex is different and therefore this branching rule leads to an unbalanced tree.

Instead, we regard the number of used vehicles. For ${\left(x^v,e^v,z^v\right)\in X_v}$ the number of used vehicles can be expressed as
\begin{align*}
	\sum_{\vinV}\sum_{(s,t)\in A\cap\left(\mathcal{V}\times\mathcal{T}\right)} x^v_{s,t}\in\left\{0,\dots,\vert\mathcal{V}\vert\right\}.
\end{align*}

Using this branching decision requires adding a suitable inequality to the master problem. As these inequalities concern the duties of all vehicles, they cannot be moved to the subproblems. We modify the master problem using a lower bound $v^{\operatorname{LB}}$ and an upper bound $v^{\operatorname{UB}}$ for the number of used cars as follows:

\begin{align}
	\min \quad & \sum_{v\in\mathcal{V}}g\left(x^v,z^v,e^v\right) + \sum_{m\in\mathcal{M}} u_m \croute_m \nonumber \\
	\text{s.t.} \quad & \sum_{m\in C^{-1}(c)} u_m = 1 && \text{for all } c\in\mathcal{C} \tag{\ref{eq:MMILP:customer}} \\
	& \sum_{v\in\mathcal{V}}\sum_{s\in\Nin(t)}x^v_{s,t} = u_m && \text{for all } m\in\mathcal{M},t\in m \tag{\ref{eq:MMILP:linking}} \\
	& \omit\rlap{$\displaystyle{v^{\operatorname{LB}} \leq \sum_{\vinV}\sum_{(s,t)\in A\cap\left(\mathcal{V}\times\mathcal{T}\right)} x^v_{s,t} \leq v^{\operatorname{UB}}}$} \label{eq:MMILP:used_vehicles} \\
	& \left(x^v,z^v,e^v\right)\in X_v && \text{for all } v\in\mathcal{V} \nonumber \\
	& u_m\in\{0,1\}^{\mathcal{M}} \nonumber
\end{align}

%----------------------------------------------------------------------------------------------------------------------------------------

\subsection{Choosing Branching Decisions}

Consider, we have received a non-integer solution after solving the relaxed master problem. Then we need to choose a branching rule for the Branch-and-Bound process. Further we select the expression on which the branching rule is applied, \eg ${(v,t)\in\mathcal{V}\times\mathcal{T}}$ for applying the rule for trip assignment. Using this, we create inequalities which define the resulting subproblems. The branching rule is only applicable, if the solution violates the inequalities. As mentioned before, in each non-integer solution the rule for trip assignment is applicable for some ${(v,t) \in\mathcal{V}\times\mathcal{T}}$.

We select the branching rule in a lexicographic order. We prefer coarser rules and rules that maintain the symmetry of the resulting tree. If applicable, we always branch on the number of vehicles. If not, we branch on the multimodal routes, the length of the duties and the assignment of trips, when one of the rules is applicable. After choosing the branching rule, we apply this on the variable which differs most from the nearest integer. \Cref{alg:branching_decision} describes the procedure.

\begin{algorithm}[hbt]
	\SetAlgoLined
	\KwIn{solution $(y,u)$ of $\eqref{eq:LMP}$ with $\left(y^v\right)\in\operatorname{conv}\left(\psi\left(X_v\right)\right)$ for $\vinV$ and $\left(u_m\right)_{m\in\mathcal{M}}$}
	\KwOut{branching inequalities or statement that solution is integer}
	$v_{\operatorname{sum}}\gets\sum_{v\in\mathcal{V}}\left(1-\prod_{t\in\mathcal{T}}y^v_t\right)$\;
	\uIf{$v_{\operatorname{sum}}\notin\mathbb{N}_0$}{
		$v^{\operatorname{UB}}\gets\lfloor v_{\operatorname{sum}}\rfloor$ and $v^{\operatorname{LB}}\gets\lceil v_{\operatorname{sum}}\rceil $\;}
	\uElseIf{$\exists m\in\argmin_{m'\in\mathcal{M}}\vert u_{m'}-0.5\vert$ with $ u_m\notin\mathbb{N}_0$}{
		$u_m = 0$ and $u_m = 1$\;}
	\uElseIf{$\exists v\in\argmin_{v'\in\mathcal{V}}\vert\mathbbm{1}^T_{\mathcal{T}}y^{v'} - \lfloor\mathbbm{1}^T_{\mathcal{T}}y^{v'} + 0.5\rfloor\vert$ with $\mathbbm{1}^T_{\mathcal{T}}y^v\notin\mathbb{N}_0$}{
		$l^{\operatorname{UB}}\gets\lfloor\mathbbm{1}^T_{\mathcal{T}}y^v\rfloor$ and $l^{\operatorname{LB}}\gets\lceil\mathbbm{1}^T_{\mathcal{T}}y^v\rceil$\;}
	\uElseIf{$\exists(v,t)\in\argmin_{\left(v',t'\right)\in\mathcal{V}\times\mathcal{T}}\vert y^{v'}_{t'} - 0.5\vert$ with $y^v_t\notin\mathbb{N}_0$}{
		$y^v_t = 0$ and $y^v_t=1$\;}
	\Else{Solution is integer\;}
	\caption{Selection of a branching decisions}
	\label{alg:branching_decision}
\end{algorithm}

The choice of the branching rules is based on the observations of \cite[Sec.~8.3]{Kaiser}. They investigated the symmetry of the Branch-and-Bound tree for the respective branching rules and came up with this strategy.