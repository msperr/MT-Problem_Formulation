\chapter{Successive Heuristics}
\label{ch:heuristics}

In this chapter, successive heuristics are introduced in order to solve our problem. As seen in \Cref{sec:complexity}, the problem is ${\mathcal{NP}\text{-hard}}$ even if we apply one of the restrictions, the cover constraints or the fuel constraints, individually. Our goal is to develop a heuristic that can cope with both multi-leg cover constraints and fuel constraints. We build our heuristic on a heuristic for a simpler version of the problem, developed in the underlying theses. \cite{Knoll} present heuristical solution methods for the problem only with fuel constraints. The problem setting assumes that there is a set of trips where each of these trips shall be fulfilled. They already claim, that solving a complete instance of 24 hours to optimality is not possible with their respective computing capacity. Therefore it is a plausible assumption that an optimal solution for our problem cannot be expected in reasonable time. 

Their solution methods are based on the idea of splitting the complete instance according to several time intervals. For each interval, only the trips starting in the respective interval are considered. From this formulation emerge several separate partial instances that are still loosely connected to each other. Each of these partial instances is solved separately and then the partial solutions are connected to a complete feasible solution. Two different approaches are presented in order to solve the problem: The constraints connecting the partial instances are relaxed by using Lagrange Relaxation. With suitable computation of Lagrange multipliers, the partial instances are solved in parallel. In the other one, the partial instances are solved successively, where the respective connecting constraints are fixed beginning at the end.

An adaption of the cover constraints to the heuristic using Lagrange Relaxation seems not practicable. This heuristics heavily exploits the loosely connection of the partial instances. The cover constraints strongly influence the complete instance by selecting the fulfilled trips, the multi-leg cover constraints even require an additional set of variables, belonging to none of the partial instances. Therefore, an additional relaxing of these cover constraints is not a promising approach. Instead, we focus on the second approach of Successive Heuristics.

The crucial difficulty for this procedure is to ensure the customer satisfaction. In particular, if trips of a customer are wide apart in terms of time, these trips will lie in different splittings. This makes it hard to keep control over the trip selection in separately solved partial instances.

We first define the splitting of the instance and the arising adaptions of task graph and model. Then, we describe the heuristic in general. Finally, we introduce different splitting methods, one according to the customers and one according to time. 

%########################################################################################################################################
%#
%#   Successive Heuristics
%#
%########################################################################################################################################

\section{Successive Heuristics}
\label{sec:successive_heuristics}

\subsection{Splitting the Problem}

In order to create the partial instances, we define splittings of $\mathcal{T}$. In contrast to \cite{Knoll}, we define the splittings in a general way.

\begin{definition}[Splitting]
\label{def:splitting}

Let $n\in\mathbb{N}$ and let
\begin{align*}
	\mathcal{T}=\Cupdot_{i=1}^n\Ti
\end{align*}

be a partition of the set of trips. Then we call $\left\{\Ti\mid i\in[n]\right\}$ splitting of $\mathcal{T}$ and $\Ti$ partial trip set.\fxnote{Only vehicles available in 1st splitting considered}

\end{definition}

\paragraph{Adaption of the Task Graph} \parfill

We transform our task graph such that it contains the splitting as defined in \Cref{def:splitting}. For this, we introduce so called split points connecting the partial sets. Arcs that connect two partial sets in the original formulation, take a detour over the respective split point in the transformed graph.

\begin{definition}[Transformed Task Graph]

Let $\left\{\mathcal{T}_1,\dots\mathcal{T}_n\right\}$ be a splitting of $\mathcal{T}$ according to \Cref{def:splitting}. Then we define:
\begin{enumerate}
	\item{Split Point: Let $s\in\Ti$ for $i\in[n]\backslash\{1\}$. For $j\in[i-1]$, we define the split point $\SPjs$ with $\pstart_{\SPjs}=\pend_{\SPjs}=:\pstart_s, \zstart_{\SPjs}=\zend_{\SPjs}=:\zstart_s$ and $\ft_{\SPjs}=:0$.}
	\item{For $i\in[n]\backslash\{1\}$ and $j\in[i-1]$, we define $\mathcal{P}_{j,i}:=\left\{\SPjs\mid s\in\Ti\right\}$.}
	\item{Partial Split Point Set: For $j\in[n-1]$, we define the partial split point set $\mathcal{P}_j:=\Cupdot_{i=j+1}^n \mathcal{P}_{j,i}$.}
	\item{Split Point Set: We define the split point set $\mathcal{P}:=\Cupdot_{j=1}^{n-1}\mathcal{P}_j$.}
\end{enumerate}

Let $G=(V,A)$ be the task graph.
\begin{enumerate}
	\setcounter{enumi}{4}
	\item{For $i\in[n], t\in\Ti$ and $j\in[i-1]$ we define ${s\prec\operatorname{SP}_j(t):\Leftrightarrow s\prec t}$.}
	\item{Transformed Task Graph: We define the transformed task graph $\overline{G}=\left(\overline{V},\overline{A}\right)$ with vertex set
		\begin{align*}
			\overline{V} := V\cup \mathcal{P} = V\cup\left\{\operatorname{SP}_i(s)\mid i\in[n-1],j\in[n+1]\backslash[i],s\in\mathcal{T}_j\right\}
		\end{align*}
		and arc set
		\begin{align*}
			\overline{A} := & \left(\ds\times\mathcal{V}\right)\cupdot\left\{(s,t)\in\left(\mathcal{V}\cupdot\mathcal{T}_1\right)\times\left( \mathcal{T}_1\cupdot\mathcal{P}_1\right)\mid s\prec t\right\} \\
			& \cupdot\bigcup_{i=2}^n\left\{(s,t)\in\Ti\times\left(\Ti\cupdot \mathcal{P}_i\right)\mid s\prec t\right\} \\
			& \cupdot\bigcup_{i=2}^n\left(\bigcup_{j=1}^{i-1}\left\{(s,t)\in\mathcal{P}_{j,i}\times\Ti\mid s=\operatorname{SP}_j(t)\right\}\right)\cupdot \left(\left(\mathcal{V}\cupdot\mathcal{T}\right)\times\left\{\de\right\}\right)
		\end{align*}}
\end{enumerate}

\end{definition}

\paragraph{Adaption of the Model} \parfill

In order to adapt $\eqref{eq:MMILP}$ to the transformed task graph, we make the following considerations:

For all split points we define the costs and fuel states as
\begin{align*}
	\ct_s := 0 && \cd_{s,t} := 0 && \ft_s := 0 && \fd_{s,t} := 0 && \text{for } s\in \mathcal{P},t\in\Nouto(s)
\end{align*}

since $\pend_s = \pstart_t$ and $\zend_s = \zstart_t$. Furthermore, refueling is not possible between $s$ and $t$.

In the task graph, the arcs between two trips of different splittings are replaced by the detour over the splitting point. Therefore, the trip costs of a trip directly after a split point are not considered in the objective function any more. In order to compensate this, we add the following term to the objective function:
\begin{align*}
	\sum_{s\in \mathcal{P}}\sum_{t\in\Nouto(s)}x_{s,t}\ct_t
\end{align*}

We want to ensure the flow conservation also in the new nodes $\mathcal{P}$, thus we add
\begin{align}
	\sum_{t\in\Nino(s)} x_{t,s} = \sum_{t\in\Nouto(s)} x_{s,t} & & \text{for all } s\in\mathcal{P} \label{eq:SMILP:splitpoint_flow}
\end{align}

The equations $\eqref{eq:MMILP:flow}$ and $\eqref{eq:SMILP:splitpoint_flow}$ are contracted to
\begin{align}
	\sum_{t\in\Nino(s)} x_{t,s} = \sum_{t\in\Nouto(s)} x_{s,t} & & \text{for all } s\in \overline{V}\backslash\left\{d^{\operatorname{s}},d^{\operatorname{e}}\right\} \label{eq:SMILP:flow}
\end{align}

\newpage

\begin{align}
	\min \quad & \omit\rlap{$\displaystyle{\sum_{s\in\mathcal{V}} \sum_{t\in\Nouto(s)\backslash\{d^{\operatorname{e}}\}} x_{s,t}\cv + \sum_{s\in \mathcal{P}}\sum_{t\in\Nouto(s)} x_{s,t} \ct_t + \sum_{m\in\mathcal{M}} u_m \croute_m}$} \nonumber \\
	& \omit\rlap{$\displaystyle{ + \sum_{t\in\mathcal{T}\cup \mathcal{P}} \sum_{s\in\Nino(t)\backslash \mathcal{P}} \left[x_{s,t}\left(\cd_{s,t}+\ct_t\right) + \sum_{r\in\Rst} z_{s,r,t}\left(\cd_{s,r}+\cd_{r,t}-\cd_{s,t}\right)\right]}$} \tag{SMILP} \label{eq:SMILP} \\
	\text{s.t.} \quad & \sum_{t\in\Nino(s)} x_{t,s} = \sum_{t\in\Nouto(s)} x_{s,t} & & \text{for all } s\in \overline{V}\backslash\left\{d^{\operatorname{s}},d^{\operatorname{e}}\right\} \tag{\ref{eq:SMILP:flow}} \\
	& \sum_{s\in\Nino(t)} x_{s,t} = 1 & & \text{for all } t\in\mathcal{V} \tag{\ref{eq:MMILP:vehicles}} \\
	& \sum_{m\in C^{-1}(c)} u_m = 1 && \text{for all } c\in\mathcal{C} \tag{\ref{eq:MMILP:customer}} \\
	& \sum_{s\in\Nino(t)} x_{s,t} = u_m && \text{for all } m\in\mathcal{M},t\in m \tag{\ref{eq:MMILP:route}} \\
	& \sum_{r\in\Rst} z_{s,r,t} \leq x_{s,t} & & \text{for all } t\in\mathcal{T}\cup \mathcal{P}, s\in\Nino(t)\backslash \mathcal{P} \label{eq:SMILP:refuel} \\
	& e_s \leq f_s^0 & & \text{for all } s\in\mathcal{V} \tag{\ref{eq:MMILP:initial_fuel}} \\
	& 0 \leq e_s - \sum_{r\in\Rst} z_{s,r,t}\fd_{s,r} & & \text{for all } t\in\mathcal{T}\cup \mathcal{P}, s\in\Nino(t)\backslash \mathcal{P} \label{eq:SMILP:min_fuel} \\
	& e_t \leq 1 - \ft_t - \sum_{r\in\Rst} z_{s,r,t}\fd_{r,t} & & \text{for all } t\in\mathcal{T}\cup \mathcal{P}, s\in\Nino(t)\backslash \mathcal{P} \label{eq:SMILP:max_fuel} \\
	& \omit\rlap{$\displaystyle{e_t \leq e_s - x_{s,t}\left(f_{s,t}^{\operatorname{d}}+f_t^{\operatorname{t}}\right) - \sum_{r\in\Rst} z_{s,r,t}\left(\fd_{s,r}+\ft_r+\fd_{r,t}-\fd_{s,t}\right) + \left(1-x_{s,t}\right)}$} \nonumber \\
	& & & \text{for all } t\in\mathcal{T}\cup \mathcal{P}, s\in\Nino(t)\backslash \mathcal{P} \label{eq:SMILP:fuel_consumption} \\
	& e_t \leq e_s-x_{s,t}\ft_t+\left(1-x_{s,t}\right) && \text{for all } s\in \mathcal{P},t\in\Nouto(s) \tag{\ref{eq:SMILP:fuel_splitpoint}} \\
	& x_{s,t}\in\{0,1\} & & \text{for all } (s,t)\in\overline{A} \\
	& z_{s,r,t}\in\{0,1\} & & \text{for all } t\in\mathcal{T}\cup \mathcal{P},s\in\Nino(t)\backslash \mathcal{P},r\in\Rst \\
	& e_s\in[0,1] & & \text{for all } s\in\overline{V}\backslash\left\{d^{\operatorname{s}},d^{\operatorname{e}}\right\} \\
	& u_m \in\{0,1\} && \text{for all } m\in\mathcal{M} \tag{\ref{eq:MMILP:um}}
\end{align}

The fuel constraints are adapted in the following way: $\eqref{eq:MMILP:refuel}$, $\eqref{eq:MMILP:min_fuel}$, $\eqref{eq:MMILP:max_fuel}$ and $\eqref{eq:MMILP:fuel_consumption}$ hold also on the arcs leading to $\mathcal{P}$ and are therefore replaced by $\eqref{eq:SMILP:refuel}$, $\eqref{eq:SMILP:min_fuel}$, $\eqref{eq:SMILP:max_fuel}$ and $\eqref{eq:SMILP:fuel_consumption}$.

Further the arcs leading from a split points to its respective trips have to be considered. Since refueling is not possible there, we have only to adapt $\eqref{eq:MMILP:fuel_consumption}$. Since $\fd_{s,t} = 0$ and refueling is not possible between $s$ and $t$, the constraint reads as follows:
\begin{align}
	e_t \leq e_s - x_{s,t}\ft_t + \left(1-x_{s,t}\right) && \text{for all } s\in \mathcal{P},t\in\Nouto(s) \label{eq:SMILP:fuel_splitpoint}
\end{align}

The customer constraints $\eqref{eq:MMILP:customer}$ are not affected by transforming the graph. The decision whether a trip $t\in\mathcal{T}$ is fulfilled is still given by $\sum_{s\in\Nino(t)} x_{s,t}$, no matter if the ingoing arc is a split point or not. Thus, the route constraints $\eqref{eq:MMILP:route}$ do not change either.

Putting all together, we have the formulation $\eqref{eq:SMILP}$.

\paragraph{Model Equivalence} \parfill

We show that $\eqref{eq:SMILP}$ is also feasible in $\eqref{eq:MMILP}$. Inversely, not every solution of the original formulation is also feasible in the split formulation.

\begin{theorem}

Let ${S=(x,z,e,u)}$ be a feasible solution of the $\eqref{eq:SMILP}$. Then $S$ can be converted into a solution ${\bar{S}=\left(\bar{x},\bar{z},\bar{e},\bar{u}\right)}$ which is feasible in the $\eqref{eq:MMILP}$ and the objective values $\operatorname{val}(S)$ and $\operatorname{val}(\bar{S})$ coincide.

\end{theorem}

\begin{proof}

Let ${S=(x,z,e,u)}$ be a feasible solution of the $\eqref{eq:SMILP}$. We define ${\bar{S}=\left(\bar{x},\bar{z},\bar{e},\bar{u}\right)}$ as follows: Let ${s\in\mathcal{V}}$, ${t\in\mathcal{T}}$ with ${s\prec t}$ and ${r\in\Rst}$. We set
\begin{align*}
	\bar{x}_{s,t} := \begin{cases} x_{s,t} & \text{if } t\in\mathcal{T}_1 \\ x_{s,\operatorname{SP}_1(t)} & \text{otherwise} \end{cases} &&
	\bar{z}_{s,r,t} := \begin{cases} z_{s,r,t} & \text{if } t\in\mathcal{T}_1 \\ z_{s,r,\operatorname{SP}_1(t)} & \text{otherwise} \end{cases}
\end{align*}

For ${i\in[n]}, {s\in\Ti}$, ${t\in\mathcal{T}}$ with ${s\prec t}$ and ${r\in\Rst}$, we set
\begin{align*}
	\bar{x}_{s,t} := \begin{cases} x_{s,t} & \text{if } t\in\Ti \\ x_{s,\operatorname{SP}_i(t)} & \text{if } t\in\Cupdot_{j=i+1}^n \mathcal{T}_j \\ 0 & \text{otherwise} \end{cases} &&
	\bar{z}_{s,r,t} := \begin{cases} z_{s,r,t} & \text{if } t\in\Ti \\ z_{s,r,\operatorname{SP}_i(t)} & \text{if } t\in\Cupdot_{j=i+1}^n \mathcal{T}_j \\ 0 & \text{otherwise} \end{cases}
\end{align*}

Additionally, we set ${\bar{e}_s := e_s}$ for all ${s\in\mathcal{V}\cupdot\mathcal{T}}$ and ${\bar{u}_m := u_m}$ for all ${m\in\mathcal{M}}$. From the flow conservation $\eqref{eq:SMILP:flow}$ and ${\Nouto\left(\operatorname{SP}_i(t)\right)=\{t\}}$ follows:
\begin{align*}
	x_{s,\operatorname{SP}_i(t)}=1 \Rightarrow x_{\operatorname{SP}_i(t),t}=1 && \text{for } i\in[n], s\in\Ti, t\in\Cupdot_{j=i+1}^n \mathcal{T}_j \text{ with } s\prec t
\end{align*}

The time feasibility of $\bar{S}$ follows directly from the definition of ${s\prec\operatorname{SP}_i(t)}$. Visiting a refuel point between $s$ and $\operatorname{SP}_i(t)$ in the $\eqref{eq:SMILP}$ is equivalent to visiting a refuel point between $s$ and $t$ in the $\eqref{eq:MMILP}$. Visiting a refuel point between $\operatorname{SP}_i(t)$ and $t$ is not feasible in the $\eqref{eq:SMILP}$. The fuel constraints are equivalent by construction and therefore $\bar{S}$ is feasible \wrt fuel. The cover constraints are equivalent in both formulations. Therefore $\bar{S}$ is a feasible solution of the $\eqref{eq:MMILP}$.

The objective function of $\eqref{eq:SMILP}$ is adapted such that the trip and deadhead costs arise for exactly the same trips, the vehicle and route costs are not affected by the transformation. Thus ${\operatorname{val}(S)=\operatorname{val}(\bar{S})}$.

\end{proof}

\begin{remark}

Note that a feasible solution in $\eqref{eq:MMILP}$ is not necessarily feasible in $\eqref{eq:SMILP}$. If there are ${s,t\in\mathcal{T}}$ with ${s\prec t}$ and ${s\in\mathcal{T}_{i+1}}, {t\in\Ti}$, then $s$ and $t$ cannot be connected in the transformed task graph. This issue is further discussed in \Cref{sec:customer_dependent_splitting}.

\end{remark}

%----------------------------------------------------------------------------------------------------------------------------------------

\subsection{General Setting}
\label{sec:general_setting}

In this section, we describe the general setting of the heuristic. Let $\left\{\mathcal{T}_1,\dots,\mathcal{T}_n\right\}$ be a splitting. For each partial trip set, we create a partial instance ${I_1,\dots,I_n}$ which contains exactly the partial trip set $\mathcal{T}_i$ and some endpoints $\Phat_i$. How these endpoints are created is explained afterwards. The partial instance~$I_1$ additionally contains the vehicle set. The partial instances are solved from the end to the start, \ie ${I_n,\dots,I_1}$ are solved successively. For each partial instance~$I_i$, a partial solution~$S_i$ is computed which is based on the already solved partial instances. In $I_1$ which is solved last, the partial duties are actually assigned to the vehicles. Finally the partial solutions are feasibly connected to an overall solution.

This heuristic is directly applied from \cite[Sec.~10.4]{Knoll}. As presented there, the order in which the partial instances are solved can be stated arbitrarily as long as $I_1$ is solved last. They argue that the setting with ordering from the end to the start suits best to the underlying instance structure. Therefore we present only this approach here.

\paragraph{Determination of the Endpoints} \parfill

The sets of end points $\Phat_i$ are initially empty for all $i\in[n]$. We first solve the partial instance~$I_n$ with ${\Phat_n = \emptyset}$. For ${i\in[n-1]}$ assume that we have solved $I_{i+1}$ right now. Based on the received partial solution~$S_{i+1}$, we update the endpoint set for the preceding partial instance~$I_i$.

Each duty of $S_{i+1}$ consists of a sequence of trips out of $\mathcal{T}_{i+1}$ and refuel points and possibly ends with an end point out of $\Phat_{i+1}$. It is possible that a duty only consists of an end point. For each duty we create an end point in $\Phat_i$. If the duty starts with a trip or end point $s$, we create the end point $t$ with the following properties
\begin{align*}
	\pstart_t = \pend_t := \pstart_s && \zstart_t = \zend_t := \zstart_s && f_t^0 := e_s + \ft_s
\end{align*}

where $e_s$ is the respective value of decision variable $e$ in the $S_{i+1}$. We add $t$ to the end point set $\Phat_i$.

For each end point $t$, we call the respective trip $s$ from where it is created, the trip representing $t$. If an end point $t$ is created from an end point $s$, the trip representing $t$ is the trip representing $s$. Note that each end point ${t\in\bigcup_{i=1}^n\Phat_i}$ has a trip ${s\in\mathcal{T}}$ representing it.

The partial instance~$I_1$ has a special role. This instance additionally contains the vehicle set. Each duty of the partial solution $S_1$ starts with a vehicle $v\in\mathcal{V}$, consists of trips out of $\mathcal{T}_1$ and refuel points and possibly ends with an endpoint out of $\Phat_1$. It is possible that a duty only consists of a vehicle.

\paragraph{Feasible Connection of Partial Solutions} \parfill

In order to generate an overall solution which is feasible for $\eqref{eq:MMILP}$, we connect the partial solutions. Let ${\left\{S_1,\dots S_n\right\}}$ be the partial solutions, solved as described before with the start and end points created as before. The connection works as follows:

For each duty in $S_1$, we check whether it ends with an end point $t\in\bigcup_{i=1}^n\Phat_i$. We call this duty start duty.
\begin{itemize}
	\item
		If it does, we delete the end point and append the duty of $S_i$ for ${i\in[n]\backslash\{1\}}$ that starts with the trip representing $t$ to the start duty. We then restart this procedure with the new end of the start duty.
	\item
		If it does not, the start duty is finished and we continue with the next duty in $S_1$.
\end{itemize}

In the partial instances has to be ensured that each end point ${t\in\Phat_i}$ is covered by some duty in $S_i$. This guarantees that all duties of the partial solutions are finally part of the overall solution. \Cref{alg:successive_heuristic} describes the procedure of the Successive Heuristics.

\begin{algorithm}[htb]
	\SetAlgoLined
	\KwIn{splitting $\left\{\mathcal{T}_1,\dots,\mathcal{T}_n\right\}$, vehicle set $\mathcal{V}$}
	\KwOut{overall solution $S$ with duty set $D$}
	\lForEach{$i\in[n]$}{$\Phat_i\gets\emptyset$}
	\ForEach{$i=n,\dots,2$}{
		solve $I_i$, receive partial solution~$S_i$ with duty set~$D_i$\;
		\ForEach{$D_i\ni d=\left(s_1,\dots,s_l\right)$}{
			create end point $t$\;
			$\pstart_t\gets\pstart_{s_1}, \pend_t\gets\pstart_{s_1}, \zstart_t\gets\zstart_{s_1}, \zend_t\gets\zstart_{s_1}, f_t^0\gets e_{s_1} + \ft_{s_1}$\;
			$\Phat_{i-1}\gets\Phat_{i-1}\cup\{t\}$\;
		}
	}
	solve $I_1$, receive partial solution~$S_1$ with duty set~$D_1$\;
	\ForEach{$D_1\ni d=\left(s_1,\dots,s_l\right)$}{
		$t\gets s_l$\;
		\While{$t\in\bigcup_{i=1}^{n}\Phat_i$}{
			determine duty $d'=\left(s_{l+1},\dots,s_{l'}\right)$ with $t_{l+1}\in\mathcal{T}$ representing $t$\;
			$d\gets\left(s_1,\dots,s_{l-1},s_{l+1},\dots,s_{l'}\right)$\;
			$t\gets s_{l'}; l\gets l'-1$\;
		}
	}
	$D\gets D_1$\;
	\Return{S, D}
	\caption{Successive Heuristic (general setting) \label{alg:successive_heuristic}}
\end{algorithm}

%----------------------------------------------------------------------------------------------------------------------------------------

\subsection{Solving the Subproblems}

We describe how the partial instances ${I_1,\dots,I_n}$ are solved. We create a task graph containing $\Ti$ and $\Phat_i$ and solve this partial instance similar to the $\eqref{eq:SMILP}$. We first describe the procedure for ${i\in[n]\backslash\{1\}}$. Finally we explain the modifications to solve~$I_1$.

\begin{remark}

The formulation developed here is only a basic structure for solving the partial instances. The realization of the cover constraints depends on the splitting method. Since there are several approaches to split the trip set, we refer to \Cref{sec:customer_dependent_splitting} and \Cref{sec:time_dependent_splitting} for the actual description of the cover constraints. The route costs heavily depend on the cover constraints and are thus also neglected here. The in \Cref{sec:successive_heuristics} developed approach solely is not appropriate to gain meaningful results. Since the cover constraints are completely left out here, the empty solution is feasible and is obviously the cost-minimal solution.

\end{remark}

\paragraph{Task Graph} \parfill

First we define the task graph with which we can solve the partial instances. The transformed task graph $\overline{G}$ covers the complete instance, but contains already the partial trip sets of the splitting. We divide $\overline{G}$ into partial task graphs. For ${i\in[n]\backslash\{1\}}$, the partial task graph $\overline{G}_i$ contains the respective partial trip set $\Ti$ and the end point set $\Phat_i$. The graph is defined as follows:

\begin{definition}[Partial Transformed Task Graph]

Let ${i\in[n]\backslash\{1\}}$. For a set of end points $\Phat_i$ and the partial trip set $\Ti$, the partial transformed task grah is the directed graph ${\overline{G}_i=\left(\overline{V}_i,\overline{A}_i\right)}$ with vertex set
\begin{align*}
	\overline{V}_i := \left\{\ds,\de\right\}\cupdot\Ti\cupdot\Phat_i
\end{align*}

and arc set
\begin{align*}
	\overline{A}_i := & \left(\left\{\ds\right\}\times\left(\Ti\cupdot\Phat_i\right)\right)\cupdot\left\{(s,t)\in\Ti\times\left(\Ti\cupdot\Phat_i\right)\mid s\prec t\right\} \cupdot\left(\left(\Ti\cupdot\Phat_i\right)\times\left\{\de\right\}\right)
\end{align*}

\end{definition}

In the partial instance are no vehicles. Thus each duty starts with a trip or end point.

\paragraph{Solving the Partial Instances} \parfill

Let ${i\in[n]\backslash\{1\}}$. In order to solve each partial instance, we create a formulation which is based on the partial transformed task graph $\overline{G}_i$. The flow constraints and the fuel constraints are basically the same as in $\eqref{eq:SMILP}$, restricted to $\overline{G}_i$. 

As mentioned before, there is no vehicle set any more. Instead all endpoints have to be visited. Therefore we replace $\eqref{eq:MMILP:vehicles}$ by
\begin{align}
	& \sum_{s\in\Ninoi(t)} x_{s,t} = 1 && \text{for all } t\in\Phat_i \label{eq:CMILP:start_end_points}
\end{align}

We are given initial fuel levels for the end points. They indicate the required fuel for the start of the next partial duty. These fuel levels work as lower bounds for the end of the duties in this partial instance. Therefore we introduce the constraints
\begin{align}
	& f^0_s \leq e_s && \text{for all } s\in\Phat_i \label{eq:CMILP:final_fuel}
\end{align}

Since there are no vehicles in the partial instance, the constraint $\eqref{eq:MMILP:initial_fuel}$ is dropped.

We introduce two additional constraints. If a duty starts or ends with a trip, then the fuel at the start or at the end of this duty is bounded by $f^{\min}$ or $f^{\max}$, respectively. How these boundaries are actually defined, is part of the heuristic. The constraints are the following:
\begin{align}
	& e_s + \ft_s \leq f^{\max}_s + \left(1-x_{\ds,s}\right)\cdot\left(1+\ft_s\right) && \text{for all } s\in\Ti \label{eq:CMILP:fmax} \\
	& f^{\min}_s \leq e_s + \left(1-x_{s,\de}\right) && \text{for all } s\in\Ti \label{eq:CMILP:fmin}
\end{align}

While solving the partial instances partial duties are created. For ${i\in[n]\backslash\{1\}}$, the number of these duties is not bounded so far. The number of duties in $S_{i+1}$ equals $\vert\Phat_i\vert$. If ${\vert\Phat_1\vert > \vert\mathcal{V}\vert}$, the partial instance~$I_1$ is infeasible and then the complete heuristic is infeasible. In order to prevent this, we restrict the number of created duties by the following inequality:
\begin{align}
	\sum_{t\in\Ti\cup\Phat_i} x_{\ds,t} \leq \vert\mathcal{V}\vert \label{eq:CMILP:strengthening}
\end{align}

As mentioned before, it requires some additional work to include the cover constraints into the partial instances. The fulfilling of the cover constraints is also part of the respective heuristic and therefore $\eqref{eq:MMILP:customer}$ and $\eqref{eq:MMILP:route}$ are left out in this formulation.

\paragraph{Cost Function} \parfill

\begin{figure}[htb]
	\centering
	\begin{tikzpicture}[node distance=1cm, auto,]
		\node[circ] (de) {$d^{\operatorname{e}}$};
		\node[dummy, above=of de] (dummy1) {};
		\node[dummy, below=of de] (dummy2) {};
		\node[rect, left= 1.5cm of dummy2] (endpoints) {$\widehat{\mathcal{P}}_i$};
		\node[rect, left= 3cm of dummy1] (trips) {$\mathcal{T}_i$};
		\node[dummy, left= 1.5cm of trips] (dummy3) {};
		\node[circ, below=of dummy3] (ds) {$d^{\operatorname{s}}$};
		\draw[arrow] (ds) to node[auto] {$0$} (trips.west);
		\draw[arrow] (ds) to node[auto] {$0$} (endpoints.west);
		\draw[arrow] (trips) to node[auto] {$0$} (endpoints);
		\draw[arrow] (trips.east) to node[auto] {$c^{\operatorname{v}}$} (de);
		\draw[arrow] (endpoints.east) to node[auto] {$0$} (de);
	\end{tikzpicture}
	\caption{Graph $\overline{G}_i$ and vehicle cost for $i\in[n]\backslash\{1\}$}
	\label{fig:graph_instance}
\end{figure}

The cost function is also modified. The deadhead cost between trips ${s,t\in\Ti}$ are the same as in the $\eqref{eq:SMILP}$. Between trips ${s\in\Ti}, {t\in\mathcal{T}_j}$ with ${i<j}$, there is an end point ${t'\in\Phat_i}$ with $t$ representing $t'$ if $t$ starts another partial duty in $S_j$. The deadhead cost $\cd_{s,t}$ is treated in $I_i$ as $\cd_{s,t'}$ and the trip cost $\ct_t$ is treated in $I_j$. Therefore the trip cost for the trip starting a duty arises additionally.

The fixed vehicle costs require a different treatment. If a duty ends with an end point, the vehicle cost of this duty arises already in the partial instance where the end point is created. Therefore, we use the vehicle cost only for duties that end with a trip. Thus, the arcs ${\Ti\times\de}$ have vehicle cost $\cv$. All other arcs that are incident with $\ds$ or $\de$ have no vehicle cost. \Cref{fig:graph_instance} shows a simplified visualization of the partial task graph and the vehicle cost.

Besides the cover constraints, also the route costs are not treated here. They are specified in the heuristic. The formulation of the partial instance is called $\eqref{eq:SMILPi}$ for ${i\in[n]\backslash\{1\}}$.

\paragraph{Solving Partial Instance $\boldsymbol{I_1}$} \parfill

As mentioned before, the partial instance~$I_1$ plays a special role since the vehicles are introduced there. The vehicle set $\mathcal{V}$ is added to the partial task graph and all duties start with a vehicle. We show how the formulation $(\operatorname{SMILP}_1)$ differs from $\eqref{eq:SMILPi}$ for ${i\in[n]\backslash\{1\}}$.

\newpage

\begin{align}
	\min \quad & \omit\rlap{$\displaystyle{\sum_{s\in\Ti} x_{s,\de}\cv + \sum_{t\in\Ti} x_{\ds, t}\ct_t}$} \nonumber \\
	& \omit\rlap{$\displaystyle{\sum_{t\in\Ti\cup\Phat_i}\sum_{s\in\Ninoi(t)\backslash\left\{\ds\right\}}\left[x_{s,t}\left(\cd_{s,t}+\ct_t\right)+\sum_{r\in\Rst}z_{s,r,t}\left(\cd_{s,r}+\cd_{r,t}-\cd_{s,t}\right)\right]}$} \tag{$\operatorname{SMILP}_i$} \label{eq:SMILPi} \\
	\text{s.t.} \quad & \sum_{t\in\Ninoi(s)} x_{t,s} = \sum_{t\in\Noutoi(s)} x_{s,t} & & \text{for all } s\in \overline{V}_i\backslash\left\{\ds,\de\right\} \label{eq:CMILP:flow} \\
	& \sum_{s\in\Ninoi(t)} x_{s,t} = 1 && \text{for all } t\in\Phat_i \tag{\ref{eq:CMILP:start_end_points}} \\	
	& \sum_{r\in\Rst} z_{s,r,t} \leq x_{s,t} && \text{for all } t\in\Ti\cup\Phat_i, s\in\Ninoi(t)\backslash\left\{\ds\right\} \label{eq:CMILP:refuel} \\
	& f^0_s \leq e_s && \text{for all } s\in\Phat_i \tag{\ref{eq:CMILP:final_fuel}} \\
	& 0 \leq e_s - \sum_{r\in\Rst} z_{s,r,t}\fd_{s,r} & & \text{for all } t\in\Ti\cup\Phat_i, s\in\Ninoi(t)\backslash\left\{\ds\right\} \label{eq:CMILP:min_fuel} \\
	& e_t \leq 1 - \ft_t - \sum_{r\in\Rst} z_{s,r,t}\fd_{r,t} & & \text{for all } t\in\Ti\cup\Phat_i, s\in\Ninoi(t)\backslash\left\{\ds\right\} \label{eq:CMILP:max_fuel} \\
	& \omit\rlap{$\displaystyle{e_t \leq e_s - x_{s,t}\left(f_{s,t}^{\operatorname{d}}+f_t^{\operatorname{t}}\right) - \sum_{r\in\Rst} z_{s,r,t}\left(\fd_{s,r}+\ft_r+\fd_{r,t}-\fd_{s,t}\right) + \left(1-x_{s,t}\right)}$} \nonumber \\
	& & & \text{for all } t\in\Ti\cup\Phat_i, s\in\Ninoi(t) \label{eq:CMILP:fuel_consumption} \\
	& \omit\rlap{$\displaystyle{e_s + \ft_s \leq f^{\max}_s + \left(1-x_{\ds,s}\right)\cdot\left(1+\ft_s\right)} \qquad \text{for all } s\in\Ti \tag{\ref{eq:CMILP:fmax}}$} \\
	& f^{\min}_s \leq e_s + \left(1-x_{s,\de}\right) && \text{for all } s\in\Ti \tag{\ref{eq:CMILP:fmin}} \\
	& \sum_{t\in\Ti\cup\Phat_i} x_{\ds,t} \leq \vert\mathcal{V}\vert \tag{\ref{eq:CMILP:strengthening}} \\
	& x_{s,t}\in\{0,1\} & & \text{for all } (s,t)\in\overline{A}_i \label{eq:CMILP:xst} \\
	& z_{s,r,t}\in\{0,1\} & & \text{for all } t\in\Ti\cup\Phat_i,s\in\Ninoi(t)\backslash\left\{\ds\right\},r\in\Rst \label{eq:CMILP:zsrt} \\
	& e_s\in[0,1] & & \text{for all } s\in\overline{V}_i\backslash\left\{\ds,\de\right\} \label{eq:CMILP:es}
\end{align}

\newpage

\begin{definition}[Partial Transformed Task Graph]

Let $i=1$. For a set of vehicles $\mathcal{V}$, a set of end points $\Phat_1$ and the partial trip set $\mathcal{T}_1$, the partial transformed task graph for $I_1$ is the directed graph $\overline{G}_1=\left(\overline{V}_1,\overline{A}_1\right)$ with vertex set
\begin{align*}
	\overline{V}_1 := \left\{\ds,\de\right\}\cupdot\mathcal{V}\cupdot\mathcal{T}_1\cupdot\Phat_1
\end{align*}

and arc set
\begin{align*}
	\overline{A}_1 := & \left(\left\{\ds\right\}\times\mathcal{V}\right)\cupdot\left\{(s,t)\in\left(\mathcal{V}\cupdot\Ti\right)\times\left(\Ti\cupdot\Phat_i\right)\mid s\prec t\right\} \cupdot\left(\left(\mathcal{V}\cupdot\Ti\cupdot\Phat_i\right)\times\left\{\de\right\}\right).
\end{align*}

\end{definition}

With introducing the vehicles we have to ensure that each vehicle is considered exactly once and respect its initial fuel state. Hence we add the constraints
\begin{align}
	& \sum_{s\in\operatorname{N}^-_{\overline{G}_1}(t)} x_{s,t} = 1 && \text{for all } s\in\mathcal{V} \tag{\ref{eq:MMILP:vehicles}} \\
	& e_s \leq f^0_s && \text{for all } s\in\mathcal{V} \tag{\ref{eq:MMILP:initial_fuel}}
\end{align}

to $(\operatorname{SMILP}_1)$.

\begin{figure}[htb]
	\centering
	\begin{tikzpicture}[node distance=1cm, auto,]
		\node[circ] (de) {$d^{\operatorname{e}}$};
		\node[dummy, above=of de] (dummy1) {};
		\node[dummy, below=of de] (dummy2) {};
		\node[rect, left= 1.5cm of dummy2] (endpoints) {$\widehat{\mathcal{P}}_1$};
		\node[rect, left= 3cm of dummy1] (trips) {$\mathcal{T}_1$};
		\node[dummy, left= 1.5cm of trips] (dummy3) {};
		\node[rect, below=of dummy3] (vehicles) {$\mathcal{V}$};
		\node[circ, left=of vehicles] (ds) {$d^{\operatorname{s}}$};
		\draw[arrow] (ds) to node[auto] {$0$} (vehicles);
		\draw[arrow, bend left=90] (vehicles.north) to node[auto] {$0$} (de.north);
		\draw[arrow] (vehicles) to node[auto] {$0$} (trips.west);
		\draw[arrow] (vehicles) to node[auto] {$0$} (endpoints.west);
		\draw[arrow] (trips) to node[auto] {$0$} (endpoints);
		\draw[arrow] (trips.east) to node[auto] {$c^{\operatorname{v}}$} (de);
		\draw[arrow] (endpoints.east) to node[auto] {$0$} (de);
	\end{tikzpicture}
	\caption{Graph $\overline{G}_1$ and vehicle cost for $(\operatorname{SMILP}_1)$}
	\label{fig:graph_instance_1}
\end{figure}

The objective function is not modified. The vehicle cost is charged for each non-empty duty that does not end with an end point. The deadhead cost $\cd_{s,t}$ or $\cd_{s,r} + \cd_{r,t}$ for ${s\in\mathcal{V}}$ is respected in the objective function. \Cref{fig:graph_instance_1} shows a simplified visualization of the partial task graph $\overline{G}_1$ and the vehicle cost.

\paragraph{Model Equivalence} \parfill

\begin{theorem}
\label{thm:equivalence_heuristic_SMILP}

Let ${\left\{S_1,\dots,S_n\right\}}$ be partial solutions where $S_i$ is feasible in the $\eqref{eq:SMILPi}$ and the end point set $\Phat_i$ is created according to \Cref{alg:successive_heuristic} for ${i\in[n]}$. They can be transformed into a solution $\overline{S}$ that is feasible in the $\eqref{eq:SMILP}$ without the cover constraints $\eqref{eq:MMILP:customer}$ and $\eqref{eq:MMILP:route}$. The values ${\sum_{i=1}^n \operatorname{val}\left(S_i\right)}$ and ${\operatorname{val}(\overline{S})}$ coincide.

\end{theorem}

\begin{proof}

For ${i\in[n]}$, let ${S_i=\left(x^i,z^i,e^i\right)}$ be the partial solution of $I_i$. We construct a solution ${\overline{S}=\left(\bar{x},\bar{z},\bar{e},\bar{u}\right)}$. For this, we identify each end point set $\Phat_i$ with the partial split point set $\mathcal{P}_i$. An end point ${t\in\Phat_i}$ that represents a trip ${s\in\Cupdot_{j=i+1}^n \mathcal{T}_j}$ is identified with the split point $\operatorname{SP}_i(s)$. Each split point with which no end point is identified is not used in $\overline{S}$.

Let ${i\in[n]}$ be arbitrary. For ${i=1}$, let ${s\in\mathcal{V}\cupdot\mathcal{T}_1}$ and ${t\in\mathcal{T}_1\cupdot\mathcal{P}_1}$. For ${i>1}$, let ${s\in\Ti}$ and ${t\in\Ti\cupdot\mathcal{P}_i}$. We state
\begin{align*}
	\bar{x}_{s,t} := \begin{cases} x^i_{s,t} & \text{if } t\in\Ti\cupdot\Phat_i \\ 0 & \text{if } t\in\mathcal{P}_i\backslash\Phat_i \end{cases} &&
	\bar{z}_{s,r,t} := \begin{cases} z^i_{s,r,t} & \text{if } t\in\Ti\cupdot\Phat_i \\ 0 & \text{if } t\in\mathcal{P}_i\backslash\Phat_i \end{cases} &&
	\text{for } r\in\Rst.
\end{align*}

The term ${t\in\mathcal{P}_i\backslash\Phat_i}$ means that \Cref{alg:successive_heuristic} has not created the respective end point and therefore the split point is not used in this solution.

Let ${t\in\Ti}$ and ${s=\operatorname{SP}_j(t)}$ with ${j<i}$. Then we state
\begin{align*}
	\bar{x}_{s,t} := \begin{cases} 1 & \text{if } s\in\Phat_j \text{ and } x^j_{\ds,s} = 0 \\ 0 & \text{otherwise} \end{cases}
\end{align*}

Consider ${s\in\Phat_j}$ and ${x^j_{\ds,s}=1}$. Then the end point is not appended to a partial duty. In this case, \Cref{alg:successive_heuristic} creates a new end point in $\Phat_{j-1}$. If ${x^j_{\ds,s}=0}$, then we have ${x^j_{t',s}=1}$ for some ${t\in\mathcal{T}_j}$ and therefore $s$ is appended to a duty and no further end point is created.

Finally, we state
\begin{align*}
	\bar{x}_{\ds,v} & := 1 && \text{for } v\in\mathcal{V} & \bar{x}_{s,\de} & := x^i_{s,\de} && \text{for } s\in\Ti \\
	\bar{e}_s & := e^i_s && \text{for } s\in\Ti\cupdot\Phat_i & \bar{e}_v & := e^1_v && \text{for } v\in\mathcal{V} \\
	\bar{e}_s & := 0 && \text{for } s\in\mathcal{P}\backslash\Cupdot_{i=1}^n \Phat_i & \bar{u}_m & := 0 && m\in\mathcal{M} \\
\end{align*}

We show that $\overline{S}$ is a feasible solution of the $\eqref{eq:SMILP}$. The flow conservation $\eqref{eq:SMILP:flow}$ is obviously fulfilled for ${t\in\mathcal{V}\cupdot\mathcal{T}\cupdot\mathcal{P}\backslash\Cupdot_{i=1}^n \Phat_i}$. Let ${t\in\Phat_i}$ with ${t=\operatorname{SP}_i\left(t'\right)}$ for some ${t'\in\Cupdot_{j=i+1}^n \mathcal{T}_j}$. We have ${\sum_{s\in\Ninoi(t)} x^i_{s,t} = 1}$ due to $\eqref{eq:CMILP:start_end_points}$ and $\Nouto(t) = \left\{t'\right\}$. Thus
\begin{align*}
	x^j_{\ds,t} + \sum_{s\in\Nino(t)} x_{s,t} = 1 && \text{and} && x^j_{\ds,t} + x_{t,t'} = 1 && \Rightarrow && \sum_{s\in\Nino(t)} x_{s,t} = \sum_{s\in\Nouto(t)} x_{t,s}
\end{align*}

The fuel constraints hold in each partial solution individually, the initial fuel states $f^0_t$ for ${t\in\Cupdot_{i=1}^n \Ti}$ maintain feasible fuel states at the transitions between the partial instances. Therefore, $\overline{S}$ is feasible in the $\eqref{eq:SMILP}$ without the cover constraints $\eqref{eq:MMILP}$ and $\eqref{eq:MMILP}$.

In each partial instance, we distinguish the non-empty duties concerning the vehicle cost. For each partial duty that ends with a trip, the vehicle cost is charged. If it ends with an end point, no vehicle cost is charged, since the partial duty is prepended to an already existing duty. Therefore the vehicle costs are charged exactly once for each duty of $\overline{S}$. Each trip cost $\ct_t$ and deadhead cost $\cd_{s,t}$ or ${\cd_{s,r}+\cd_{r,t}}$ occurs in exactly one partial instance. Because of ${\bar{u}_m=0}$, the route cost is not considered. Therefore
\begin{align*}
	\sum_{i=1}^n\operatorname{val}\left(S_i\right) = \operatorname{val}\left(\overline{S}\right)
\end{align*}

\end{proof}

\begin{theorem}
\label{thm:equivalence_SMILP_heuristic}

Let ${\overline{S}=\left(\bar{x},\bar{z},\bar{e},\bar{u}\right)}$ be a feasible solution of the $\eqref{eq:SMILP}$. We can transform $\overline{S}$ into partial solutions $\left\{S_1,\dots,S_n\right\}$ where $S_i$ is feasible in $\eqref{eq:SMILPi}$ for ${i\in[n]}$. The values $\operatorname{val}(\overline{S})$ and ${\sum_{i=1}^n S_i}$ coincide without respecting the route cost.

\end{theorem}

\begin{proof}

Let ${\overline{S}=\left(\bar{x},\bar{z},\bar{e},\bar{u}\right)}$ be a feasible solution of the $\eqref{eq:SMILP}$. We construct solutions ${S_i=\left(x^i,z^i,e^i\right)}$ for ${i\in[n]}$. Similarly to the proof of \Cref{thm:equivalence_heuristic_SMILP}, we create an end point for each used split point. Let ${t\in\Ti}$ with ${\bar{x}_{\operatorname{SP}_{i'}(t),t}=1}$ for some ${i',i\in[n]}$. Then, for each ${j\in\left\{i',\dots,i-1\right\}}$ we create an end point $\operatorname{SP}_j(t)$ in $\Phat_j$. We identify each end point with the split point from which it is created.

Let ${i\in[n]}$ be arbitrary. For ${i=1}$, let ${s\in\mathcal{V}\cupdot\mathcal{T}_1}$ and ${t\in\mathcal{T}_1\cupdot\Phat_1}$. For ${i>1}$, let ${s\in\Ti}$ and ${t\in\Ti\cupdot\Phat_i}$. We state
\begin{align*}
	x^i_{s,t} := \bar{x}_{s,t} && z^i_{s,r,t} := \bar{z}_{s,r,t} && \text{for } r\in\Rst.
\end{align*}

Let ${s\in\Ti}$. Then we state
\begin{align*}
	x^i_{\ds,s} := \max_{j\in[i-1]} \left(\bar{x}_{\operatorname{SP}_j(s),s}\right) && x^i_{s,\de} := \bar{x}_{s,\de}
\end{align*}

For ${s\in\Phat_i}$ with ${s=\operatorname{SP}_i(t)}$ for some ${t\in\Cupdot_{j=i+1}^n\mathcal{T}_j}$, we state
\begin{align*}
	x^i_{\ds,s} := \max_{j\in[i-1]} \left(\bar{x}_{\operatorname{SP}_j(t),t}\right) && x^i_{s,\de} := 1
\end{align*}

We have ${x^i_{\ds,s}=1}$, iff $s$ is the start of a partial duty. This means for ${s\in\Ti}$ that $s$ is connected to one of its split points, \ie ${\bar{x}_{\operatorname{SP}_j(s),s}=1}$ for some ${j\in[i-1]}$. For ${s\in\Phat_i}$, \Cref{alg:successive_heuristic} creates a new end point out of $s$ and one of these split points is connected to the original trip. We have ${x^i_{s,\de}=1}$, iff $s$ is the end of a partial duty. If $s$ is a trip then $s$ is the end of the whole duty, while each end point is the end of a partial duty.

We further state
\begin{align*}
	x^1_{\ds,v} := 1 && x^1_{v,\de} := \bar{x}_{v,\de} && e^1_v := \bar{e}_v && \text{for } v\in\mathcal{V} && e^i_s & := \bar{e}_s && \text{for } s\in\Ti\cupdot\Phat_i
\end{align*}

Each $S_i$ is a feasible solution of the $\eqref{eq:SMILPi}$ and the objective values $\operatorname{val}(\overline{S})$ and ${\sum_{i=1}^n\operatorname{val}\left(S_i\right)}$ coincide up to the route cost. The proof works analogously to the proof of \Cref{thm:equivalence_heuristic_SMILP}. The route cost is not considered in the objective function of $\eqref{eq:SMILPi}$.

\end{proof}

%########################################################################################################################################
%#
%#   Customer-dependent Splitting
%#
%########################################################################################################################################

\section{Customer-dependent Splitting}
\label{sec:customer_dependent_splitting}

In this section, we introduce the customer-dependent splitting. In contrast to the splitting performed by \cite{Knoll}, the trips are not split according to their start times but according to their customers' start times. Therefore all trips of a route and all routes of a customer are in the same partial trip set. The advantage is that the cover constraints can be applied easily in the respective subproblems. The problem is that this formulation is not equivalent to the original problem, \ie duties that are feasible in $\eqref{eq:MMILP}$ can be cut off in this formulation. We show restrictions, in which the application of this splitting is sensible, though. 

\subsection{Basic Idea}

\paragraph{Splitting} \parfill

The customer-dependent splitting is defined as follows:

\begin{definition}[Customer-dependent splitting]
\label{def:customer_dependent_splitting}

Given points in time $c_i$ for $i\in[n-1]$ with $c_i<c_{i+1}$ for $i\in[n-2]$. We first define a splitting of the customers $\mathcal{C}=\Cupdot_{i=1}^n\mathcal{C}_i$ as
\begin{align*}
	\mathcal{C}_i := \begin{cases}
		\left\{c\in\mathcal{C}\mid \zstart_c\leq c_1\right\} & \text{for } i=1 \\
		\left\{c\in\mathcal{C}\mid c_{i-1}<\zstart_c\leq c_i\right\} & \text{for } i\in[n-1]\backslash\{1\} \\
		\left\{c\in\mathcal{C}\mid c_{n-1}<\zstart_c\right\} & \text{for } i=n.
	\end{cases}
\end{align*}

Based on the customer splitting, we define the splitting of $\mathcal{T}$ as
\begin{align*}
	\Ti := \left\{t\in\mathcal{T}\mid (M\circ C)(t)\in\mathcal{C}_i\right\} && \text{for } i\in[n]
\end{align*}

\end{definition}

\paragraph{Solving the Partial Instances} \parfill

The formulation of the partial instances is built on the basic structure $\eqref{eq:SMILPi}$. The cover constraints have not been considered there. We therefore introduce the decision variable $u_m\in\{0,1\}$ for $m\in C^{-1}\left(\mathcal{C}_i\right)$. Since a customer $c\in\mathcal{C}_i$ has all his trips in~$\Ti$, only the cover constraints concerning these customers are included in partial instance~$I_i$. We therefore add the following constraints:
\begin{align}
	& \sum_{m\in C^{-1}(c)} u_m = 1 && \text{for all } c\in\mathcal{C}_i \label{eq:CMILP:customer} \\
	& \sum_{s\in\operatorname{N}_{\overline{G}_i}^-(t)} x_{s,t} = u_m && \text{for all } m\in C^{-1}\left(\mathcal{C}_i\right), t\in m \label{eq:CMILP:route} \\
	& u_m\in\{0,1\} && \text{for all } m\in C^{-1}\left(\mathcal{C}_i\right) \label{eq:CMILP:um}
\end{align}

Further the route costs are not considered in $\eqref{eq:SMILPi}$ so far. We again have to consider only the route costs belonging to $c\in\mathcal{C}_i$. We therefore add the following term to the objective function
\begin{align*}
	\sum_{m\in C^{-1}\left(\mathcal{C}_i\right)} u_m \croute_m
\end{align*}

We call this formulation $(\operatorname{CMILP}_i)$ for $i\in[n]$. Let $S$ be a solution that is created with \Cref{alg:successive_heuristic} and the respective partial solutions~$S_i$ are feasible in $(\operatorname{CMILP}_i)$ for ${i\in[n]}$. Then we call $S$ a feasible solution of the $(\operatorname{CMILP})$.

\paragraph{Model Equivalence} \parfill

In the following, we examine whether the formulations $\eqref{eq:MMILP}$ and $(\operatorname{CMILP})$ are equivalent. We show that each solution that is computed with the heuristic is actually a feasible solution of the original problem. On the other hand, we provide a counterexample, in which the optimal solution is not a feasible outcome of the heuristic.

\begin{theorem}
\label{thm:equivalence_CMILP_MMILP}

Let $S$ be a feasible solution of the $(\operatorname{CMILP})$. Then $S$ is feasible in the $\eqref{eq:MMILP}$ and
\begin{align*}
	\operatorname{cost}\left(S\right) = \sum_{i=1}^n\operatorname{cost}\left(S_i\right)
\end{align*}

\end{theorem}

\begin{proof}

Let $S$ be a solution that is created with \Cref{alg:successive_heuristic} and the respective partial solutions $S_i$ are feasible in $(\operatorname{CMILP}_i)$ for ${i\in[n]}$. The $(\operatorname{CMILP}_i)$ builds on the $(\operatorname{SMILP}_i)$ and additionally contains the variables $u_m$ and the constraints $\eqref{eq:CMILP:customer}, \eqref{eq:CMILP:route}$ and $\eqref{eq:CMILP:um}$. Therefore each feasible solution of the $(\operatorname{CMILP}_i)$ is also feasible in $(\operatorname{SMILP}_i)$.

According to \Cref{thm:equivalence_heuristic_SMILP}, solution~$S$ is feasible in $\eqref{eq:MMILP}$ except for the cover constraints. Let $c\in\mathcal{C}$ arbitrary. Then there is a unique $i\in[n]$ with ${c\in\mathcal{C}_i}$. In $(\operatorname{CMILP}_i)$ exist decision variables $u_m$ for all ${m\in C^{-1}(c)}$ and then $\eqref{eq:MMILP:customer}$ follows directly from $\eqref{eq:CMILP:customer}$. Let ${m\in\mathcal{M}}$ arbitrary. There is a unique ${i\in[n]}$ with ${m\in C^{-1}(\mathcal{C}_i)}$ and all trips ${t\in m}$ are in $(\operatorname{CMILP}_i)$. Then $\eqref{eq:MMILP:route}$ and $\eqref{eq:MMILP:um}$ follow directly from $\eqref{eq:CMILP:route}$ and $\eqref{eq:CMILP:um}$. 

In the $(\operatorname{CMILP}_i)$, the route cost is added to the objective function. For each route, the route cost arises in exactly one partial instance. Therefore $S$ is a feasible solution of the $\eqref{eq:MMILP}$ and ${\operatorname{cost}(S) = \sum_{i=1}^n\operatorname{cost}\left(S_i\right)}$.

\end{proof}

\Cref{thm:equivalence_CMILP_MMILP} shows that each heuristical solution is a feasible solution. Now we show that a feasible solution is not necessarily feasible in the heuristic using a customer-dependent splitting.

\begin{example}
\label{ex:equivalence_MMILP_CMILP}

Let ${\mathcal{T}=\left\{t_1, t_2, t_3\right\}}$ with ${t_1\prec t_2\prec t_3}$ and the properties as shown in \Cref{tab:customer_heuristic_example}

\begin{table}[htb]
	\centering
	\begin{tabular}{c|cccc}
		Trip & Start & End & Route & Customer \\
		\hline
		$t_1$ & 8:00 & 8:15 & $m_1$ & $b_1$ \\
		$t_2$ & 8:30 & 8:45 & $m_2$ & $b_2$ \\
		$t_3$ & 9:00 & 9:15 & $m_1$ & $b_1$ \\
	\end{tabular}
	\caption{Trips}
	\label{tab:customer_heuristic_example}
\end{table}

We can see easily that the duty ${d=\left(t_1,t_2,t_3\right)}$ is a feasible solution. 

If we now set a time point ${c_1 := \text{8:15}}$, then the partial trip sets are ${\mathcal{T}_1=\left\{t_1,t_3\right\}}$ and ${\mathcal{T}=\left\{t_2\right\}}$. There is one split point ${\operatorname{SP}_1\left(t_2\right)}$ with ${\zstart_{\operatorname{SP}_1\left(t_2\right)} = \text{8:30}}$ and thus ${t_3\not\prec\operatorname{SP}_1\left(t_2\right)}$. The connection of $t_2$ and $t_3$ is not feasible in this heuristic and therefore the duty~$d$ is not feasible.

\end{example}

\subsection{Quality of the Heuristic}

Although the optimal solution is possibly not feasible in the heuristic, we examine the quality of feasible heuristical solutions. Based on an arbitrary feasible solution we inspect where this solution becomes infeasible in the heuristic and if we can construct a new solution which is feasible there. Depending on the initial solution, we aim to receive upper bounds for the total cost of the new solution. 

\paragraph{Quality of Feasible Solutions} \parfill

The only reason that makes a duty~$d$ infeasible in the customer-dependent heuristic is when an earlier trip $s$ is located in a later partial trip set than $t$ and therefore the connection between $s$ and $t$ is deleted. Under certain conditions it is possible to create new duties $d_1$ and $d_2$ covering all trips of~$d$ where $d_1$ and $d_2$ are feasible in the heuristic. To realize these duties, we also need an additional vehicle that covers duty~$d_2$. Having these additional vehicles, we construct a new solution whose total cost is bounded by twice the original cost.

\begin{definition}[Customer extension and splitting length]

Consider a customer set $\mathcal{C}$ and time points $c_i$ for $i\in[n-1]$ with $c_i<c_{i+1}$ for all $i\in[n-2]$. We define the following values:
\begin{itemize}
	\item{Customer Extension for $c\in\mathcal{C}$: $\displaystyle{L_{\operatorname{C}}(c) := \max_{t\in(M\circ C)^{-1}(c)}\zstart_t - \min_{t\in(M\circ C)^{-1}(c)}\zstart_t}$}
	\item{Customer Extension: $\displaystyle{L_{\operatorname{C}} := \max_{c\in\mathcal{C}} L_{\operatorname{C}}(c)}$}
	\item{Splitting Length: $\displaystyle{L_{\operatorname{S}} := \min_{i\in[n-1]} c_{i+1}-c_i}$}
\end{itemize}

\end{definition}

The customer extension and the splitting length are important values for investigating the behavior of the heuristic. If the customer extension is small, the possibility of customer overlapping is restricted. If additionally the splitting length is large, the number of partial trip set affected by a single customer is small. Since only the overlapping of customers causes the infeasibilities, these are  desirable issues.

We make the next definitions in order to specify the cost of a solution and its duties.

\begin{definition}[Duty cost]
\label{def:dutycost}

Let ${d=\left(v,t_1,\dots,t_k\right)}$ be a non-empty duty of a solution with ${v\in\mathcal{V}}$ and ${t\in\mathcal{T}\cupdot\mathcal{R}}$. We define the cost of duty~$d$ as
\begin{align*}
	\operatorname{cost}(d) := \cv + \cd_{v,t_1} + \sum_{i=1}^{k-1} \left(\ct_{t_i} + \cd_{t_i, t_{i+1}}\right) + \ct_{t_k}
\end{align*}

where $\ct_r := 0$ for $r\in\mathcal{R}$.

\end{definition}

Only the route costs~$\croute$ have been neglected in \Cref{def:dutycost}. Note that the total cost of a solution consists of the costs of all of its duties and the route costs of all the selected routes. We refer to the total cost of a solution as $\operatorname{cost}\left(S\right)$ and to the number of non-empty duties as $\operatorname{duties}\left(S\right)$. 

In the following lemma, we construct two heuristic-feasible duties $d_1$ and $d_2$ from each duty $d$. This construction requires the customer extension to be bounded by the splitting length. It further requires an additional vehicle that can be prepended to the additional duty. Only in this lemma, we denote the vehicle duties as lists of trips and assume the respective refuel points to be given as additional information. We write ${s\prec t}$ if $(s,t)$ is feasible in the $\eqref{eq:MMILP}$, \ie ${(s,t)\in A}$.  We write ${s\to t}$ if the connection $(s,t)$ is feasible in $(\operatorname{CMILP})$, \ie ${(s,t)\in\overline{A}}$ or there is a ${t'\in\mathcal{P}}$ with ${(s,t'),(t',t)\in\overline{A}}$.

\begin{lemma}
\label{lem:doubleduties}

Let $S=\left(x,z,e,u\right)$ be a feasible solution of the $\eqref{eq:MMILP}$ and let $c_i$ be time points for $i\in[n-1]$ with ${c_i<c_{i+1}}$ for ${i\in[n-2]}$. Let
\begin{align}
	L_{\operatorname{C}}\leq L_{\operatorname{S}}\label{eq:LCLS}
\end{align}

Let ${d=\left(v,t_1,\dots,t_k\right)}$ be a duty of $S$ with vehicle $v\in\mathcal{V}$. If $d$ is not feasible in $(\operatorname{CMILP})$, let $a$ be the smallest index such that ${t_a\not\to t_{a+1}}$ and let ${v'\in\mathcal{V}}$ with
\begin{align}
	z_{v'} + t_{v',t_{a+1}}\leq\zstart_{t_{a+1}}\label{eq:doubleduties:time}
\end{align}

and
\begin{align}
	f^0_{v'}\geq e_{t_{a+1}} + \fd_{v',t_{a+1}} + \ft_{t_{a+1}}.\label{eq:doubleduties:fuel}
\end{align}

Then there are duties $d_1,d_2$ with ${d_1\cupdot d_2=d\cupdot\left\{v'\right\}}$ such that $d_1,d_2$ are part of a feasible solution of the $(\operatorname{CMILP})$.

Let additionally
\begin{align}
	\cd_{v',t_{a+1}}\leq \cd_{v,t_1} + \sum_{j=1}^a \left(\ct_{t_j} + \cd_{t_j,t_{j+1}}\right) \label{eq:doubleduties:cost}
\end{align}

Then the cost of the duties $d_1,d_2$ is at most twice the original cost, \ie
\begin{align*}
	\operatorname{cost}\left(d_1\right) + \operatorname{cost}\left(d_2\right) \leq 2\cdot\operatorname{cost}\left(d\right)
\end{align*}

\end{lemma}

\begin{proof}

If $d$ is feasible in $\operatorname{CMILP}$, the result is obvious. Therefore we consider a vehicle duty ${d=\left(v,t_1,\dots,t_k\right)}$ that is not feasible in $\operatorname{CMILP}$ and $a$ as the smallest index with ${t_a\not\to t_{a+1}}$.

Consider ${s\prec t}$ with ${s\not\to t}$ and customers ${b_s:=\left(M\circ C\right)(s)}$ and ${b_t:=\left(M\circ C\right)(t)}$. If $s$ and $t$ is in the same partial trip set, then ${s\to t}$. If $s$ is in an earlier partial trip set, $s$ and $t$ are connected via a split point. Thus $s$ is in a later partial trip set. Using ${c_{0}:=-\infty}, {c_n:=+\infty}$, there are split points $c_{l-1},c_l,c_{l+1}$ for $l\in[n-1]$ with
\begin{align*}
	\zstart_s < \zstart_t && \zstart_{b_t}\leq c_l <\zstart_{b_s} && c_l+L_{\operatorname{S}}\leq c_{l+1} && \zstart_{b_s}\leq \zstart_s\leq \zstart_{b_s}+L_{\operatorname{C}}
\end{align*}

From $\eqref{eq:LCLS}$ follows:
\begin{gather*}
	\zstart_{b_s} \leq \zstart_s < \zstart_t\leq\zstart_{b_t}+L_{\operatorname{C}} \leq c_l+L_{\operatorname{C}} \leq c_l+L_{\operatorname{S}} \leq c_{l+1} \\
	\zstart_{b_t} \geq \zstart_t-L_{\operatorname{C}} > \zstart_s-L_{\operatorname{C}} \geq \zstart_{b_s}-L_{\operatorname{C}} > c_l-L_{\operatorname{C}}\geq c_l-L_{\operatorname{S}}\geq c_{l-1}
\end{gather*}

and therefore $t\in\mathcal{T}_l,s\in\mathcal{T}_{l+1}$.

In summary, we have shown the following equivalence: Let ${s\prec t}$ and ${t\in\mathcal{T}_l}$. Then
\begin{align*}
	s\to t \Leftrightarrow s\in\Cupdot_{j=1}^l \mathcal{T}_j && s\not\to t \Leftrightarrow s\in\mathcal{T}_{l+1}
\end{align*}

Note that the relation~$\preceq$ is an equivalence relation on $d$. Due to the cover constraints, there are no ${s,t\in d}$ with ${\left(M\circ C\right)(s)=\left(M\circ C\right)(t)}$ and ${M(s)\neq M(t)}$ and hence transitivity holds.

\paragraph{Time Feasibility} \proofparfill

For all ${i\in[k-2]}$ holds: ${t_i\prec t_{i+1}\prec t_{i+2}}$ and therefore ${t_i\prec t_{i+2}}$. We show how we construct feasible duties $d_1,d_2$ such that ${s\to t}$ holds for all subsequent trips $s$ and $t$ in one duty. We initially set the duties
\begin{align*}
	d_1 := \left(v,t_1,\dots,t_a\right) && d_2 := \left(v',t_{a+1}\right)
\end{align*}

which is feasible by assumption. For each ${i\in\left\{a+2,\dots, k\right\}}$, let $t$ be the current last trip of $d_1$. Append $t_i$ to $d_1$ if ${t\to t_i}$, else to $d_2$. We prove that $t_i$ can always be feasibly appended to one of the duties:

In each step, choose ${l_1,l_2\in[n]}$ as the indices such that for the current last trip $t$ of $d_1$ and $d_2$ holds ${t\in\mathcal{T}_{l_1}}$ and ${t\in\mathcal{T}_{l_2}}$, respectively. We prove the feasibility by induction over ${i\in\left\{a+1,\dots, k\right\}}$.
\begin{itemize}
	\item{Induction Base:}
		Trip~$t_{a+1}$ is feasibly appended to $d_2$ because of $\eqref{eq:doubleduties:time}$. After appending $t_{a+1}$ holds ${l_1>l_2}$ because of $t_a\not\to t_{a+1}$. 
	\item{Induction Hypothesis:} 
		For each ${i\in\left\{a+2,\dots, k\right\}}$, trip~$t_i$ can be appended to $d_1$ or $d_2$. Afterwards still holds ${l_1>l_2}$.
	\item{Induction Step:}
		Choose ${l\in[n]}$ such that ${t_i\in\mathcal{T}_l}$. Since $t_j\prec t_i$ for all ${j\in[i-1]}$ holds ${l+1\geq l_1}$ and since ${l_1>l_2}$ holds ${l\geq l_2}$. Thus $t_i$ can be appended to $d_1$ or $d_2$. If ${l<l_1}$ then $t_i$ is appended to $d_2$ and ${l_2 := l<l_1}$. Else $t_i$ is appended to $d_1$ and ${l_1 := l>l_2}$. Therefore still holds ${l_1>l_2}$.
\end{itemize}

In summary, we have proven that each trip ${t\in d}$ can be feasibly appended either to $d_1$ or to $d_2$ and the vehicles $v$ and $v'$ are feasibly assigned to the duties $d_1$ and $d_2$, respectively.

\paragraph{Fuel Feasibility} \proofparfill

After proving that we can construct duties $d_1$ and $d_2$ that are feasible in $(\operatorname{SMILP})$ \wrt time, we examine the fuel states in the duties and visiting the refuel points. We consider $d_1,d_2$ as constructed in the previous part. Let $i\in[n-1]$ and let ${z_{t_i,r,t_{i+1}}=1}$ for some ${r\in\mathcal{R}_{t_i,t_{i+1}}}$, \ie refuel point~$r$ is visited between the trips $t_i$ and $t_{i+1}$. We distinguish the following cases:
\begin{itemize}
	\item{$i<a$:}
		Then ${t_i,t_{i+1}\in d_1}$ and $r$ is set between $t_i$ and $t_{i+1}$ in $d_1$.
	\item{$i\geq a$:}
		Refuel point $r$ is inserted in both duties. Let ${j^-_1:=\max\left\{j\leq i\mid t_j\in d_1\right\}}$, ${j^+_1:=\min\left\{j>i\mid t_j\in d_1\right\}}$, $j^-_2,j^+_2$ analogously for $d_2$. If $j^+_1$ exists, insert $r$ between $t_{j^-_1}$ and $t_{j^+_1}$ in duty~$d_1$. If $j^+_2$ exists, insert $r$ between $t_{j^-_2}$ and $t_{j^+_2}$ in duty~$d_2$.
\end{itemize}

We now regard duty~$d_1$ and simply write ${t^-:=t_{j^-_1}}$ and ${t^+:=t_{j^+_1}}$. We prove that there is a refuel point copy ${r'\in\mathcal{R}_{t^-,t^+}}$ that belongs to the same refuel point as ${r\in\mathcal{R}_{t_i,t_{i+1}}}$. For simplicity of notation, we define the trip time ${t_t := \zend_{t} - \zstart_{t}}$ for ${t\in\mathcal{T}}$.

From $\eqref{eq:triangle_inequality_time}$ and ${r\in\mathcal{R}_{t_i,t_{i+1}}}$ follows
\begin{align*}
	& \zend_{t^-} + t_{t^-,r'} + t_{r',t^+} \\
	\leq & \zend_{t^-} + \sum_{j=j^-_1+1}^i \left(t_{t_{j-1},t_{j}} + t_{t_j}\right) + t_{t_i,r} + t_{r,t_{i+1}} + \sum_{j=i+1}^{j^+_1-1} \left(t_{t_j} + t_{t_{j},t_{j+1}}\right) \\
	\leq & \zend_{t_i} + t_{t_i,r} + t_{r,t_{i+1}} + \left(\zstart_{t^+} - \zstart_{t_{j+1}}\right) \\
	\leq & \zstart_{t^+}
\end{align*}

and therefore ${r'\in\mathcal{R}_{t^-,t^+}}$. From $\eqref{eq:triangle_inequality_time}$ we can also see that the refueling time between $t^-$ and $t^+$
\begin{align*}
	\left(\zstart_{t^+} - t_{r,t^+}\right) - \left(\zend_{t^-} + t_{t^-,r}\right) \geq \left(\zstart_{t_{i+1}} - t_{r,t_{i+1}}\right) - \left(\zend_{t_i} + t_{t_i,r}\right)
\end{align*}

is longer than the refueling time between $t_i$ and $t_{i+1}$ and thus the negative fuel consumption is smaller. Therefore
\begin{align}
	\ft_{r'}\leq\ft_{r} \label{eq:doubleduties:refuelpoint}
\end{align}

This works analogously for $d_2$ with $t_{j^-_2}$ and $t_{j^+_2}$. We apply this procedure to all refuel points in the original duty $d$.

Let $e_t\in[0,1]$ be feasible fuel states for ${t\in d}$. We prove that these fuel states are still feasible in $d_1$ and $d_2$. For the first trips, we distinguish the duties:
\begin{itemize}
	\item{Duty~$d_1$:}
		The values of $e_v$ and ${e_{t_1},\dots,e_{t_a}}$ are still feasible since $f^0_v$ and all the trip connections do not change.
	\item{Duty~$d_2$:}
		From condition $\eqref{eq:doubleduties:fuel}$ follows directly that $e_{t_{a+1}}$ is a feasible fuel state.
\end{itemize}

Let $t_i,t_{i'}$ be subsequent trips in $d_1$ or $d_2$ with no refuel point in-between. From $\eqref{eq:triangle_inequality_fuel}$ and $\eqref{eq:MMILP:fuel_consumption}$ follows that
\begin{align*}
	e_{t_{i'}} \leq e_{t_i} - \sum_{j=i+1}^{i'} \left(\fd_{t_{j-1},t_j}+\ft_{t_j}\right) \leq e_{t_i} - \left(\fd_{t_i,t_{i'}} + \ft_{t_{i'}}\right)
\end{align*}

From $\eqref{eq:doubleduties:refuelpoint}$ we additionally see that the fuel states are still feasible if a refuel point $r'$ lies between $t_i$ and $t_{i+1}$.

So far, we have neglected the case that more than one refuel point is visited between two trips of the same duty. This is for example ${d=\left(v,t_1,r_1,t_2,r_2,t_3\right)}$ with ${t_1,t_3\in d_1}$ and ${t_2\in d_2}$. As claimed in \Cref{sec:problem_description}, it is not allowed to visit more than one refuel point between two trips. Therefore we assume without proof that we can insert some refuel point ${r\in\mathcal{R}}$ between each pair of subsequent trips and receive a feasible solution.

In summary, we have proven that the refuel points can be visited in $d_1$ and $d_2$ analogously to the original duty and then the original fuel states are still feasible in the new duties.

\paragraph{Costs} \proofparfill

After constructing the duties $d_1$ and $d_2$, we show that the cost of the duties is not more than twice the original cost.

We first prove that ${\operatorname{cost}\left(d_1\right)\leq\operatorname{cost}\left(d\right)}$. The vehicle cost $\cv$ is the same in $d_1$ and $d$. The trip cost $\ct$ of $d_1$ is smaller than the trip cost of $d$ since ${d_1\subseteq d}$. The deadhead cost $\cd_{v,t_1}$ coincides since the same vehicle is used in $d_1$ and $d$. All other deadhead costs of $d_1$ are smaller due to $\eqref{eq:triangle_inequality_cost}$.

For duty~$d_2$, we first regard the deadhead cost~$\cd_{v',t_{a+1}}$. Due to condition~$\eqref{eq:doubleduties:cost}$, the total cost up to trip~$t_{a+1}$ is smaller than in the original duty. All subsequent trip and deadhead costs are smaller as argued for~$d_1$. Also the vehicle cost $\cv$ is the same in $d_2$ and $d$.

Therefore we have
\begin{align*}
	\operatorname{cost}\left(d_1\right)+\operatorname{cost}\left(d_2\right)\leq 2\cdot\operatorname{cost}\left(d\right).
\end{align*}

This concludes the proof.

\end{proof}

\begin{remark}
\label{rem:doubleduties}

\Cref{lem:doubleduties} also holds if instead of $\eqref{eq:doubleduties:time}$, $\eqref{eq:doubleduties:fuel}$ and $\eqref{eq:doubleduties:cost}$ there is a ${r\in\mathcal{R}_{v',t_{a+1}}}$ such that
\begin{align}
	z_{v'} + t_{v',r} + t_{r,t_{a+1}} & \leq \zstart_{t_{a+1}} \label{eq:doubleduties:time_r} \\
	f^0_{v'} - \left(\fd_{v',r}+\ft_r+\fd_{r,t_{a+1}}\right) & \geq e_{t_{a+1}} + \ft_{t_{a+1}} \label{eq:doubleduties:fuel_r} \\
	\cd_{v',r}+\cd_{r,t_{a+1}} & \leq \cd_{v,t_1} + \sum_{j=1}^a \left(\ct_j + \cd_{j,j+1}\right) \label{eq:doubleduties:cost_r}
\end{align}

Then we initially have $d_2:=\left(v',r,t_{a+1}\right)$ and the modified conditions ensure that $d_2$ is still feasible and ${\operatorname{cost}\left(d_2\right)\leq\operatorname{cost}\left(d\right)}$. These conditions give us more flexibility \wrt the initial fuel of $v'$.

\end{remark}

Given a duty of a solution that is feasible in the $\eqref{eq:MMILP}$ and an additional vehicle that fulfills certain conditions, we can construct a second duty, such that the duties are feasible in the heuristic, contain the same trips and the cost of the duties doubles at most. Based on this result, we aim to construct a feasible solution of the $(\operatorname{CMILP})$ with at most twice the original cost. For this, we particularly need an additional vehicle set, with which the additional duties are covered. We examine conditions of the additional vehicle set in order to make this procedure possible. Since we do not know the solution in advance, we cannot make assumptions based on this solution as we did in \Cref{lem:doubleduties}, but we need to generalize these conditions to all feasible solutions.

\begin{definition}[Conditions]
\label{def:conditions}

Let $\mathcal{T}$ be a trip set and $c_i$ time points for ${i\in[n-1]}$ with $c_i<c_{i+1}$ for ${i\in[n-2]}$. Let $\mathcal{V}$ and  $\mathcal{V}'$ with ${\mathcal{V}\cap\mathcal{V}'=\emptyset}$ be vehicle sets.
\begin{enumerate}
	\item $\mathcal{V}$ and $\mathcal{V}'$ fulfill the \emph{Feasibility Condition} if each $v\in\mathcal{V}$ can be assigned to some ${v'\in\mathcal{V}'}$ such that for all ${t\in\mathcal{T}}$ with ${\left\{s\in\mathcal{T}\mid v\prec s, s\prec t, s\not\to t\right\}\neq\emptyset}$ and ${\zstart_t>c_1}$ one of the following conditions is fulfilled:
	\begin{itemize}
		\item Feasibility condition without refuel point:
			\begin{align}
				z_{v'} + t_{v',t} & \leq \zstart_t \label{eq:doubleduties:timecond} \\
				f^0_{v'} - \fd_{v',t} & \geq f^0_v - \min\left\{\fd_{v,t},\min_{r'\in\mathcal{R}_{v,t}}\left(\fd_{v,r'}+\ft_{r'}+\fd_{r',t}\right)\right\} \label{eq:doubleduties:fuelcond}
			\end{align}
		\item Feasibility condition with refuel point: There is some ${r\in\mathcal{R}_{v',t}}$ such that
		\end{itemize}
			\begin{align}
				z_{v'} + t_{v',r} + t_{r,t} & \leq \zstart_t \label{eq:doubleduties:timecond_r} \\
				f^0_{v'} - \left(\fd_{v',r} + \ft_r + \fd_{r,t}\right) & \geq f^0_v - \min\left\{\fd_{v,t},\min_{r'\in\mathcal{R}_{v,t}}\left(\fd_{v,r'}+\ft_{r'}+\fd_{r',t}\right)\right\} \label{eq:doubleduties:fuelcond_r}
			\end{align}
	\item $\mathcal{V}$ and $\mathcal{V}'$ fulfill the \emph{Cost Condition} if each $v\in\mathcal{V}$ can be assigned to some ${v'\in\mathcal{V}'}$ such that for all ${t\in\mathcal{T}}$ with ${\zstart_t>c_1}$ and ${\left\{s\in\mathcal{T}\mid v\prec s, s\prec t, s\not\to t\right\}\neq\emptyset}$ one of the following conditions is fulfilled:
	\begin{itemize}
		\item Cost condition without refuel point: $\eqref{eq:doubleduties:timecond}, \eqref{eq:doubleduties:fuelcond}$ and for all $s\in\mathcal{T}$ with ${v\prec s, s\prec t, s\not\to t}$ holds:
			\begin{align}
				\cd_{v',t} & \leq \cd_{v,s} + \ct_s + \cd_{s,t} \label{eq:doubleduties:costcond}
			\end{align}
		\item Cost condition with refuel point: There is some ${r\in\mathcal{R}_{v',t}}$ such that $\eqref{eq:doubleduties:timecond_r}$, $\eqref{eq:doubleduties:fuelcond_r}$ and for all $s\in\mathcal{T}$ with ${v\prec s, s\prec t, s\not\to t}$ holds:
			\begin{align}
				\cd_{v',r} + \cd_{r,t} & \leq \cd_{v,s} + \ct_s + \cd_{s,t} \label{eq:doubleduties:costcond_r}
			\end{align}
	\end{itemize}
\end{enumerate}

\end{definition}

\begin{theorem}
\label{thm:doubleduties}

Let $S$ be a feasible solution of the $\eqref{eq:MMILP}$ which is computed using the vehicle set $\mathcal{V}$. Let $c_i$ be time points for $i\in[n-1]$ with ${c_i<c_{i+1}}$ for ${i\in[n-2]}$ and let
\begin{align}
	L_{\operatorname{C}} \leq L_{\operatorname{S}} \tag{\ref{eq:LCLS}}
\end{align}

Let $\mathcal{V}'$ with ${\mathcal{V}\cap\mathcal{V}'=\emptyset}$ be a vehicle set such that $\mathcal{V}$ and $\mathcal{V}'$ fulfill the Feasibility Condition according to \Cref{def:conditions}. Using the vehicle set $\mathcal{V}'\cupdot\mathcal{V}$, there exists a feasible solution $S'$ of the $(\operatorname{CMILP})$ with
\begin{align}
	\operatorname{duties}\left(S'\right) \leq 2\cdot\operatorname{duties}\left(S\right)
\end{align}

If $\mathcal{V}$ and $\mathcal{V}'$ additionally fulfill the Cost Condition according to \Cref{def:conditions}, there exists a feasible solution $S'$ of the $(\operatorname{CMILP})$ with
\begin{align}
	\operatorname{cost}\left(S'\right) \leq 2\cdot\operatorname{cost}\left(S\right)
\end{align}

\end{theorem}

\begin{proof}

Let $S=\left(x,z,e,u\right)$ be a feasible solution of the $\eqref{eq:MMILP}$. We prove that each duty $d$ of $S$ fulfills the conditions of \Cref{lem:doubleduties} or \Cref{rem:doubleduties}. Let ${v\in\mathcal{V}}$ be the vehicle that covers $d$ and ${v'\in\mathcal{V}'\backslash\mathcal{V}}$ be the vehicle assigned to $v$.

Let $a$ be the smallest index with ${t_a\not\to t_{a+1}}$ in $d$. Then holds ${t_a\not\in\mathcal{T}_1}$ and therefore
\begin{align*}
	 \zstart_{t_{a+1}} > \zstart_{t_a} \geq \zstart_{\left(M\circ C\right)\left(t_a\right)} > c_1
\end{align*}

Further we have $v\prec t_a$, $t_a\prec t_{a+1}$ and $t_a\not\to t_{a+1}$ and therefore ${\zstart_t>c_1}$ and ${\left\{s\in\mathcal{T}\mid v\prec s, s\prec t, s\not\to t\right\}\neq\emptyset}$. For $v'$ and $t_{a+1}$ hold either $\eqref{eq:doubleduties:timecond}$ and $\eqref{eq:doubleduties:fuelcond}$ or $\eqref{eq:doubleduties:timecond_r}$ and $\eqref{eq:doubleduties:fuelcond_r}$ for some ${r\in\mathcal{R}_{v',t_{a+1}}}$. The implications ${\eqref{eq:doubleduties:timecond}\Rightarrow\eqref{eq:doubleduties:time}}$ or ${\eqref{eq:doubleduties:timecond_r}\Rightarrow\eqref{eq:doubleduties:time_r}}$, respectively, can be seen easily.

We can estimate the fuel state from above by the maximal fuel of vehicle~$v$ after serving $t_{a+1}$, \ie
\begin{align*}
	e_{t_{a+1}} + \ft_{t_{a+1}} \leq f^0_v - \min\left\{\fd_{v,t_{a+1}}, \min_{r'\in\mathcal{R}_{v,t_{a+1}}}\left(\fd_{v,r'}+\ft_{r'}+\fd_{r',t_{a+1}}\right)\right\}
\end{align*}

and therefore $\eqref{eq:doubleduties:fuel}$ follows from $\eqref{eq:doubleduties:fuelcond}$ by
\begin{align*}
	f^0_{v'} & \geq f^0_v - \min\left\{\fd_{v,t_{a+1}}, \min_{r'\in\mathcal{R}_{v,t_{a+1}}}\left(\fd_{v,r'}+\ft_{r'}+\fd_{r',t_{a+1}}\right)\right\} + \fd_{v',t} \\
	& \geq e_{t_{a+1}} + \fd_{v',t_{a+1}} + \ft_{t_{a+1}}
\end{align*}

The implication ${\eqref{eq:doubleduties:fuelcond_r}\Rightarrow\eqref{eq:doubleduties:fuel_r}}$ works analogously.

As shown before, we have ${t_a\in\left\{s\in\mathcal{T}\mid v\prec s, s\prec t_{a+1}, s\not\to t_{a+1}\right\}}$ and therefore $\eqref{eq:doubleduties:cost}$ follows from $\eqref{eq:triangle_inequality_cost}$ and $\eqref{eq:doubleduties:costcond}$ by
\begin{align*}
	\cd_{v',t_{a+1}} & \leq \cd_{v,t_a} + \ct_{t_a} + \cd_{t_a,t_{a+1}} \\
	& \leq \cd_{v,t_1} + \sum_{j=1}^a \left(\ct_{t_j} + \cd_{t_j,t_{j+1}}\right)
\end{align*}

The implication ${\eqref{eq:doubleduties:costcond_r}\Rightarrow\eqref{eq:doubleduties:cost_r}}$ works analogously.

Therefore we can apply \Cref{lem:doubleduties} or \Cref{rem:doubleduties} for each duty of $S$ individually. For each duty~$d^v$, we receive duties $d^v_1$ and $d^v_2$, starting with vehicles $v$ and $v'$. If $d^v$ is already feasible, the duty~$d^v_2$ is empty. The duties $d^v_1$ and $d^v_2$ are feasible in $(\operatorname{CMILP})$. We construct the new solution $S'$ with all new duties as constructed in \Cref{lem:doubleduties}. For this, we need the vehicles $v\in\mathcal{V}$ for the duties~$d^v_1$ and the vehicles ${v'\in\mathcal{V}'}$ for the duties~$d^v_2$. Since these duties are feasible in the heuristic, the time constraints and fuel constraints are not violated by $S'$. Since the set of covered trips has not changed during the process, that cover constraints are not violated, too. Therefore, the new solution~$S'$ is a feasible solution of the $(\operatorname{CMILP})$ and
\begin{align*}
	\operatorname{duties}\left(S'\right) \leq 2\cdot\operatorname{duties}\left(S\right)
\end{align*}

The cost of solution~$S'$ comprises the vehicle cost $\cv$, the deadhead cost $\cd$, the fuel cost $\ct$ and the route cost $\croute$. Except from the route cost, all costs are already contained in the duty cost. These costs are bounded by ${\operatorname{cost}\left(d_1\right) + \operatorname{cost}\left(d_2\right) \leq 2\cdot\operatorname{cost}\left(d\right)}$. As mentioned before, the set of covered trips has not changed and thus the route costs have not changed either. Therefore, we have
\begin{align*}
	\operatorname{cost}\left(S'\right) \leq 2\cdot\operatorname{cost}\left(S\right)
\end{align*}

\end{proof}

To sum these results up, we have shown that we can always find a solution that is feasible in the customer-dependent heuristic and its total cost is not more than twice the optimal solution. For this result, we need the condition ${L_{\operatorname{C}}\leq L_{\operatorname{S}}}$. This condition applies for realistic instances, as we will discuss later. Further we need an additional vehicle set with the same size as the original vehicle set and the vehicles have certain requirements concerning their start positions and fuel states. As we regard the problem from the car sharing supplier's point of view, he is able to provide additional vehicles with the demanded properties in order to satisfy the travel request of the customers.

It is important to keep in mind that \Cref{thm:doubleduties} does not provide an approximation factor for the customer-dependent heuristic. We can neither guarantee that we receive a solution $S$ with ${\operatorname{cost}\left(S\right)\leq 2\cdot\operatorname{cost}\left(S^*\right)}$, if we apply \Cref{alg:successive_heuristic} and solve each subproblem with $(\operatorname{CMILP}_i)$ to optimality (not even with the conditions of \Cref{def:conditions}). Nor can we ensure that an existing solution $S$ which is computed with the customer-dependent heuristic fulfills ${\operatorname{cost}\left(S\right)\leq 2\cdot\operatorname{cost}\left(S^*\right)}$. In this context $S^*$ is an optimal solution. \Cref{thm:doubleduties} only says that there exists a solution $S'$ where each subproblem is feasible in $(\operatorname{CMILP}_i)$ and the total cost is at most twice the optimal cost.

\paragraph{Approximation Factor} \parfill

Finally, we show that the developed heuristic is not a constant-factor approximation. We provide an example where the ratio between the objective values of the heuristic solution and the optimal solution is arbitrarily large.

\begin{example}
\label{ex:approximation_factor}

Let $M\leq 0$ arbitrary. Let ${\mathcal{V} = \left\{v\right\}}$ and ${\mathcal{T} = \left\{t_1,t_2,t_3\right\}}$ with the properties of \Cref{tab:approximation_example}. 

\begin{table}[htp]
	\centering
	\begin{subtable}[h]{.6\textwidth}
		\centering
		\begin{tabular}{c|ccccc}
			Trip & $\zstart_t$ & $\zend_t$ & $M(t)$ & $\left(M\circ C\right)(t)$ & $\ct_t$ \\
			\hline
			$t_1$ & $1$ & $2$ & $m_1$ & $b_1$ & 1 \\
			$t_2$ & $3$ & $5$ & $m_2$ & $b_2$ & 2 \\
			$t_3$ & $3$ & $4$ & $m_3$ & $b_2$ & 1 \\
		\end{tabular}
		\caption{Trips}
	\end{subtable}
	~
	\begin{subtable}[h]{.3\textwidth}
		\centering
		\begin{tabular}{c|ccc}
			& $t_1$ & $t_2$ & $t_3$ \\
			\hline
			$v$   & 1 & 3 & 3 \\
			$t_1$ &   & 1 & 1 \\
		\end{tabular}
		\caption{Time between trips}
	\end{subtable}
	\caption{Example}
	\label{tab:approximation_example}
\end{table}

We set all deadhead cost equal to the time, \ie ${\cd_{s,t}=t_{s,t}}$. Then we increase all deadhead cost leading to $t_3$ by the parameter~$M$. Therefore
\begin{align*}
	\cd_{v,t_3} = M+2 && \cd_{t_1,t_3} = M
\end{align*}

For sake of completeness, we define the additional values:
\begin{align*}
	& \mathcal{R}=\emptyset && f^0_v=1 && \ft_t=0.1 && \fd_{s,t}=0.1 && \text{for all } s\in\mathcal{V}\cupdot\mathcal{T}, t\in\mathcal{T} \\
	& \cv = 0 &&&&&& \croute_m=0 && \text{for all } m\in\mathcal{M} \\
\end{align*}

The fuel constraints are chosen such that all solutions are feasible \wrt fuel. We have ${v\prec t}$ for all ${t\in\mathcal{T}}$ and ${t_1\prec t_2}, {t_1\prec t_3}$. For customer~$b_1$ the trip~$t_1$ is fulfilled, for customer~$b_2$ either trip~$t_2$ or $t_3$. The optimal solution~$S^*$ consists of one duty $d^*$ with
\begin{align*}
	d^* = \left(v, t_1, t_2\right) && \operatorname{cost}\left(S^*\right) = 5
\end{align*}

We solve this problem via \Cref{alg:successive_heuristic} with $n=2$ and $c_1=2$. Then the partial trip sets are ${\mathcal{T}_1=\left\{t_1\right\}}$ and ${\mathcal{T}_2=\left\{t_2,t_3\right\}}$. We first solve partial instance~$I_2$ where we chose the cheaper trip $t_3$ and receive ${\operatorname{cost}\left(S_2\right)=1}$. Therefore the heuristic solution~$S$ consists of duty $d$ with
\begin{align*}
	d = \left(v, t_1, t_3\right) && \operatorname{cost}\left(S\right) = M+3
\end{align*}

For a heuristic solution $S$ and an optimal solution $S^*$, we have
\begin{align*}
	\frac{\operatorname{cost}\left(S\right)}{\operatorname{cost}\left(S^*\right)}\in\Theta(M)
\end{align*}

in this example.

\end{example}

This is a remarkable result. In the original version of the Successive Heuristics without customers, the heuristic always computes a solution $S$ with ${\operatorname{cost}\left(S\right)\leq n\cdot\operatorname{cost}\left(S^*\right)}$ (cf.~\cite[p.~130]{Knoll}).

%########################################################################################################################################
%#
%#   Time-dependent Splitting
%#
%########################################################################################################################################

\section{Time-dependent Splitting}
\label{sec:time_dependent_splitting}

The developed formulation (CMILP) based on a customer-dependent splitting is not equivalent to the original formulation $\eqref{eq:MMILP}$. The goal now is to develop a splitting that is equivalent and create a heuristic based on this splitting. Therefore, it is necessary that trips of the same customer may be in different splittings. This leads to the following problem: If the partial instances are solved successively, we need a possibility to still guarantee the customer satisfaction for the entire problem. This has to be applied already in the first partial instance where a certain customer is concerned, although we do not have any knowledge about the trips of the same customer in the later solved partial instances.

\subsection{Basic Idea}
\label{sec:basic_idea}

We a define time-dependent splitting similar to \cite{Knoll}. Based on this splitting, we adapt the model and describe the necessary cost estimation.

\paragraph{Splitting} \parfill

We split the trip set~$\mathcal{T}$ according to the start times of the trips.

\begin{definition}[Time-dependent Splitting]
\label{def:time_dependent_splitting}

Given time points $c_i$ for $i\in[n-1]$ with $c_i<c_{i+1}$ for $i\in[n-2]$. We define the splitting of $\mathcal{T}$ as
\begin{align*}
	\Ti := \begin{cases}
		\left\{t\in\mathcal{T}\mid \zstart_t\leq c_1\right\} & \text{for } i=1 \\
		\left\{t\in\mathcal{T}\mid c_{i-1}<\zstart_t\leq c_i\right\} & \text{for } i\in[n-1]\backslash\{1\} \\
		\left\{t\in\mathcal{T}\mid c_{n-1}<\zstart_t\right\} & \text{for } i=n
	\end{cases}
\end{align*}

\end{definition}

We denote the formulation $\eqref{eq:SMILP}$ with a splitting according to \Cref{def:time_dependent_splitting} as (TMILP).

\paragraph{Solving the Partial Instances} \parfill

Since the trips of the same customer may be in different splittings, we cannot easily guarantee the customer satisfaction in just one partial instance. We have to put great effort in this issue. The partial instances are solved from the end to the beginning. Thus the earliest partial instance in which a trip of a customer arises, is defined as follows:
\begin{align*}
	\gamma: \mathcal{C}\to[n] && \gamma(c) := \max\left\{i\in[n]\mid\left(\left(M\circ C\right)^{-1}(c)\cap\Ti\right)\neq\emptyset\right\}
\end{align*}

Depending on $\gamma$ and $\left\{\mathcal{T}_1,\dots\mathcal{T}_n\right\}$ we define a partition ${\mathcal{C}=\Cupdot_{i=1}^n \mathcal{C}_i}$ as
\begin{align*}
	\mathcal{C}_i := \left\{c\in\mathcal{C}\mid \gamma(c)=i\right\} && \text{for } i\in[n]
\end{align*}

Consider an arbitrary customer $c\in\mathcal{C}$. In the partial instance~$I_{\gamma(c)}$, a multimodal route $m\in C^{-1}(c)$ is chosen and this choice is definite. This means, in all subsequently solved partial instances, all trips ${t\in m}$ are fixed to be chosen in advance and all trips ${t\in(M\circ C)^{-1}(c)\backslash m}$ are fixed to be neglected.

In the partial trip set~$\mathcal{T}_{\gamma(c)}$ there is at least one trip of $c$. But there are also trips of $c$ that are in other partial trip sets. There are even multimodal routes with no trip in $\mathcal{T}_{\gamma(c)}$ at all. These routes must not be neglected. Therefore, we need a method to choose the routes where all routes ${m\in C^{-1}(c)}$ are considered. For this, we try to estimate the total cost of the routes in advance. Solving the partial instances is again based on $\eqref{eq:SMILPi}$.

We now consider partial instance~$I_i$. For the cover constraints, we introduce the decision variable ${u_m\in\{0,1\}}$ for ${m\in C^{-1}\left(\mathcal{C}_i\right)}$.  Notice that the definition of $\mathcal{C}_i$ is different from \Cref{def:customer_dependent_splitting}. In the customer constraints, only the customers in $\mathcal{C}_i$ are considered. The route constraints are restricted to the trips in $\Ti$. The cover constraints read as follows:
\begin{align}
	& \sum_{m\in C^{-1}(c)} u_m = 1 && \text{for all } c\in\mathcal{C}_i \label{eq:TMILP:customer} \\
	& \sum_{s\in\operatorname{N}_{\overline{G}_i}^-(t)} x_{s,t} = u_m && \text{for all } m\in C^{-1}\left(\mathcal{C}_i\right), t\in m\cap\Ti \label{eq:TMILP:route} \\
	& u_m\in\{0,1\} && \text{for all } m\in C^{-1}\left(\mathcal{C}_i\right) \label{eq:TMILP:um}
\end{align}

For the constraint $\eqref{eq:TMILP:customer}$ it is irrelevant, if the considered route has a trip in~$\Ti$.

After solving the partial instance, all determined $u_m$ are fixed for the later solved partial instances. The fixed route decisions from the previous partial instances have an impact on this instance, too. 

Let $\bar{u}_m\in\{0,1\}$ be the fixed route choices from the previous instances. Define
\begin{align*}
	\overline{\mathcal{C}}_i := \left\{c\in\mathcal{C}\mid \gamma\left(c\right)>i\right\}
\end{align*}

as the set of customers that have been treated before $I_i$. This means, in partial instance $I_i$, we have chosen the routes for all ${c\in\overline{C}_i}$. We have ${\bar{u}_m=1}$ if the route $m$ has been chosen for the respective customer, \ie ${u_m=1}$ in the partial solution $S_{\gamma(C(m))}$. We are given $\bar{u}_m$ for all ${m\in C^{-1}\left(\overline{\mathcal{C}}_i\right)}$. Thus, we introduce the constraint
\begin{align}
	&\sum_{s\in\operatorname{N}_{\overline{G}_i}^-(t)} x_{s,t} = \bar{u}_m && \text{for all } m\in C^{-1}\left(\overline{\mathcal{C}}_i\right), t\in m\cap\Ti \label{eq:TMILP:route_fix}
\end{align}

which ensures that the previous route choices are considered.

\paragraph{Cost Estimation} \parfill

We have to select one route of customer~$c$ in the partial instance~$I_{\gamma(c)}$. For this we have to estimate the costs for all routes of~$c$ in advance. But these costs partly arise in the later solved instances. The entire cost for the problem consists of vehicle costs $\cv$, trip costs $\ct$, deadhead costs $\cd$ and route costs $\croute$. While the trip cost and route cost can be determined easily for a route, the vehicle cost and deadhead cost strongly depend on the environment of the route and cannot be determined. We therefore focus on the trip and route costs and define the estimated route cost as follows:
\begin{align*}
	C_1(m) := \croute_m + \sum_{t\in m}\ct_t && \text{for } m\in\mathcal{M}
\end{align*}

We use these costs in order to define the modified route cost
\begin{align*}
	\hat{c}^{\operatorname{r}}_m := \croute_m + \sum_{t\in m\backslash\Ti}\ct_t && \text{for } m\in\mathcal{M}
\end{align*}

and add the following term to the objective function:
\begin{align*}
	\sum_{m\in C^{-1}\left(\mathcal{C}_i\right)} u_m \hat{c}^{\operatorname{r}}_m
\end{align*}

\begin{remark}

The trips in the considered partial trip set $t\in m\cap\Ti$ are not considered in~$\hat{c}^{\operatorname{r}}_m$ since their trip costs are already part of the objective function. The other trips ${t\in m\backslash\Ti}$ are added to~$\hat{c}^{\operatorname{r}}_m$ such that they have an impact on the choice of the routes.

Consider a trip $t$  that is decided before this partial instance, \ie ${t\in(M\circ C)\left(\overline{\mathcal{C}}_i\right)}$. Its trip cost $\ct_t$ arises twice in the objective functions. Once in the partial instance $I_{\gamma\left((M\circ C)(t)\right)}$ as part of $\hat{c}^{\operatorname{r}}_{M(t)}$ and once in partial instance $I_i$ as $\ct_t$. But since in partial instance $I_i$ the trip is fulfilled anyway, this cost is only an additional constant that does not influence the solution. 

\end{remark}

We denote the formulation $\eqref{eq:SMILPi}$ with the constraints $\eqref{eq:TMILP:customer}$, $\eqref{eq:TMILP:route}$, $\eqref{eq:TMILP:um}$ and $\eqref{eq:TMILP:route_fix}$ and the new objective function including modified route costs as $(\operatorname{TMILP}_i)$ for $i\in[n]$.

\paragraph{Model Equivalence} \parfill

\begin{theorem}
\label{thm:equivalence_TMILP_MMILP}

Let $S$ be a solution that is created with \Cref{alg:successive_heuristic} and the respective partial solutions~$S_i$ are feasible in $(\operatorname{TMILP}_i)$ for ${i\in[n]}$. Then~$S$ is feasible in the $\eqref{eq:MMILP}$.

\end{theorem}

\begin{proof}

Proof\fxnote{Proof}

\end{proof}

\begin{theorem}
\label{thm:equivalence_MMILP_TMILP}

Let $S$ be a feasible solution of the $\eqref{eq:MMILP}$. Then $S$ is feasible in the $(\operatorname{TMILP})$.

\end{theorem}

\begin{proof}

Proof\fxnote{Proof}

\end{proof}

%----------------------------------------------------------------------------------------------------------------------------------------

\subsection{Iterative Approach}
\label{sec:iterative_approach}

We use the previously developed heuristic for an iterative approach. First, we compute an initial solution while we choose the routes according to cost function $C_1$. Based on this solution, we determine the actual costs of the selected routes. With this, we can estimate the contribution of a route to the objective function. We compare the estimated route cost to the actual route cost. If the actual route cost is considerably higher than the estimated route cost, this route choice was likely bad. We identify the customers with the worst route choices and solve a subproblem, where we fix all route choices except for the considered customers. Regarding one customer set after another, we can iteratively improve the solution.

\paragraph{Initial Solution} \parfill

We determine a solution with \Cref{alg:successive_heuristic} and a splitting according to \Cref{def:time_dependent_splitting}. Based on this solution $S=\left(\bar{x},\bar{z},\bar{e},\bar{u}\right)$, we determine 
\begin{align*}
	C_1(c) := C_1(m) && \text{for } c\in\mathcal{C}, m\in C^{-1}(c) \text{ with } \bar{u}_m = 1
\end{align*}

\paragraph{Finding Bad Route Choices} \parfill

For an existing solution, the subproblem is to find a customer $\bar{c}$ with a bad route choice. This means, for this customer there is another route, such that the total cost decreases by choosing the other route. We can exchange these routes and compute a new solution considering the new route choice. 

An initial idea is to compute the cost that a route in the solution contributes to the total cost. Then we compare this to the cost with which we have estimated the route cost before. If the actual cost are considerably higher than the estimated cost, this customer is a candidate for exchanging routes. Since we cannot determine the contributing cost exactly, we try to estimate this cost.

Let $S=\left(\bar{x},\bar{z},\bar{e},\bar{u}\right)$ be a feasible solution of the $\eqref{eq:MMILP}$. In order to determine the contributing cost for route $m\in\mathcal{M}$, we define the following auxiliary costs for every trip $t\in\mathcal{T}$ that is covered in the solution.
\begin{enumerate}
	\item{Vehicle cost $\cv_t(S)$:}
Let $v\in\mathcal{V}$ be the vehicle covering $t$ and $k_v$ the number of trips covered by $v$:
\begin{align*}
	\cv_t(S) := \frac{\cv}{k_v}
\end{align*}
	\item{Refueling cost $c^{\operatorname{refuel}}_t(S)$:}
Let $r\in\mathcal{R}$ be the next refuel station used after $t$ and $T_r$ all trips covered since the last station, let $\bar{z}_{s,r,s'} = 1$:
\begin{align*}
	c^{\operatorname{refuel}}_t(S) := \frac{\ft_t}{\sum_{t'\in T_r} \ft_t}\left(\cd_{s,r}+\cd_{r,s'}-\cd_{s,s'}\right)
\end{align*}
If the vehicle is not refueled after $t$, then $c^{\operatorname{refuel}}_t(S) := 0$.
	\item{Deadhead cost $\cd_t(S)$:}
Let $s\in\mathcal{V}\cup\mathcal{T},s'\in\mathcal{T}$ be the trips covered directly before and after $t$ by vehicle $v$, i.e. $\bar{x}_{s,t}=\bar{x}_{t,s'}=1$:
\begin{align*}
	\cd_t(S) := \frac 1 2 \left(\cd_{s,t}+\cd_{t,s'}\right)
\end{align*}
If $t$ is the last trip of the duty, i.e. $\bar{x}_{s,t}=\bar{x}_{t,d^{\operatorname{e}}}=1$, then $\cd_t(S) := \frac 1 2 \cd_{s,t}$.
\end{enumerate}

With these auxiliary costs we can define new route costs which describe the contribution of a multimodal route to the entire solution better:

\begin{definition}[Improved Cost Estimation]

Let $S=\left(\bar{x},\bar{z},\bar{e},\bar{u}\right)$ be a solution of the $\eqref{eq:MMILP}$. With the auxiliary costs described before, we define the improved cost estimation for all multimodal routes ${m\in\mathcal{M}}$ with ${\bar{u}_m=1}$:
\begin{align*}
	C_2(S,m) := C_1(m) + \sum_{t\in m}\left(\cv_t(S) + c^{\operatorname{refuel}}_t(S) + \cd_t(S)\right)
\end{align*}

We further define
\begin{align*}
	C_2(S,c) := C_2(S,m) && \text{for } c\in\mathcal{C},m\in C^{-1}(c) \text{ with } \bar{u}_m = 1
\end{align*}

\end{definition}

Now we can evaluate the previous estimation for the route contribution. If $C_2(S,c)$ is significantly higher than $C_1(S,c)$ then the probability is high that a bad route has been chosen for customer $c\in\mathcal{C}$.

After defining an indicator for bad route choices, we decide which of the customers we want to review. It is presumably not profitable to solve a subproblem for a single customer. Instead we create a set ${B\subseteq\mathcal{C}}$ with customers that are reviewed. We aim this procedure to be efficient. To achieve this, the subproblem should significantly decrease the objective value of the solution on the one hand, on the other hand it should be solved very fast. We examine desirable properties of the customer set~$B$.

Let ${c\in\mathcal{C}}$ with ${\bar{m}\in C^{-1}(c)}$ be the route chosen in the solution~$S$. Assume that~$\bar{m}$ is a bad route choice for~$c$ and with changing the route choice a great cost saving can be done. Then the following properties apply:
\begin{enumerate}
	\item The ratio $\frac{C_2(S,c)}{C_1\left(\bar{m}\right)}$ is large. \\
	Although~$\bar{m}$ is a bad route choice, $C_1\left(\bar{m}\right)$ is small enough that~$\bar{m}$ was chosen in the original setting. $C_2\left(S,\bar{m}\right)$ is large enough that the total cost decreases with choosing another route.
	\item There are ${m\in C^{-1}(c)\backslash\left\{\bar{m}\right\}}$ with ${C_1(m)<C_2(S,c)}$. \\
	If $\bar{m}$ is a bad choice, better alternatives are available.
	\item The difference ${C_2(S,c) - C_1\left(\bar{m}\right)}$ is large. \\
	The cost that is saved by exchanging routes is bounded by this difference.
	\item The set ${(M\circ C)^{-1}(c)\backslash\mathcal{T}_{\gamma(c)}}$ is large. \\
	This set contains all trips of $c$ that are not in the partial instance where the route has been chosen. If this set is large, much information about these trips were not available and the route decision is heavily based on the cost estimations. Thus $\bar{m}$ is more likely a bad route choice.
\end{enumerate}

We have to consider these properties for creating the customer set~$B$. Further we have to keep the subproblem small, such that it can be solved in reasonable time. Therefore we make additional assumptions on~$B$:
\begin{enumerate}
\setcounter{enumi}{4}
	\item The time interval ${[\max_{c\in B}\zend_c, \min_{c\in B}\zstart_c]}$ is small. \\
	In the subproblem, all duties stay fixed up to this time interval. A small time interval causes a small number of trips that are variable \wrt the duties. This keeps the size of the subproblem small.
	\item The set ${(M\circ C)^{-1}(B)}$ is small. \\
	This set contains all trips of one of the customers in~$B$. In the subproblem, all other trips are fixed to be fulfilled. Therefore a small number of trips that are variable \wrt the duties or can be neglected keeps the subproblem small.
\end{enumerate}

It is not possible to meet the requirements for~$B$ and simultaneously cover all customers with potential bad route choices. Therefore we partition a into several subsets ${B=\Cupdot_{j=1}^n B_j}$. It suffices if $B_j$ fulfill the set requirements for all ${j\in[k]}$. We iteratively execute the subproblem, each with a small customer set~$B_j$.

\begin{algorithm}[htb]
	\SetAlgoLined
	\KwIn{solution $S$, $\mathcal{C}$, $\bar{m}_c$ for ${c\in\mathcal{C}}$, $r_{\min}, c_{\max}, t_{\max}, n_{\max}$}
	\KwOut{$\left\{B_1,\dots,B_k\right\}$}
	\lForEach{$c\in\mathcal{C}$}{determine $C_2(S,c)$}
	$B\gets\left\{c\in\mathcal{C}\mid\frac{C_2(S,c)}{C_1\left(\bar{m}_c\right)}\geq r_{\min}, \exists m\in C^{-1}(c)\backslash\left\{\bar{m}_c\right\} \text{ with } C_1(m)<C_2(S,c)\right\}$\;
	$i\gets 1$\;
	\While{$B\neq\emptyset\land i\leq n_{\max}$}{
		$\bar{c}\gets\argmax_{c\in B}\left(\frac{C_2(S,c)}{C_1\left(\bar{m}_c\right)}\right)$\;
		$B_i\gets\left\{c\in B\mid \zstart_{\bar{c}} - \frac{t_{\max}}{2} \leq \zstart_c, \zend_c \leq \zstart_{\bar{c}} + \frac{t_{\max}}{2}\right\}$\;
		\lWhile{$|B_i| > c_{\max}$}{$B_i\gets B_i\backslash\left\{\argmin_{c\in B_i}\left(\frac{C_2(S,c)}{C_1\left(\bar{m}_c\right)}\right)\right\}$}
		\lIf{$B_i=\emptyset$}{$B\gets B\backslash\left\{\bar{c}\right\}$}
		\lElse{$B\gets B\backslash B_i$; $i\gets i+1$}
	}
	$k\gets i$\;
	\Return{$\left\{B_1,\dots,B_k\right\}$}
	\caption{Determination of critical customers}
	\label{alg:critical_customers}
\end{algorithm}

\Cref{alg:critical_customers} shows how we create the customer sets. In order to meet the requirements, we introduce the following parameters:
\begin{itemize}
	\item{$r_{\min}$:} The minimal ratio $\frac{C_2(S,c)}{C_1\left(\bar{m}\right)}$ for ${c\in B}$
	\item{$c_{\max}$:} The maximal number of customers in $B_j$
	\item{$t_{\max}$:} The maximal time range of the customers in $B_j$
	\item{$n_{\max}$:} The maximal number of iterations
\end{itemize}

\paragraph{Subproblem} \parfill

Let $S=\left(\bar{x},\bar{z},\bar{e},\bar{u}\right)$ be a solution of the $\eqref{eq:MMILP}$ and $B\subseteq\mathcal{C}$ a set of candidates for a bad route choice. We define the following subproblem $(\operatorname{HSP}_B)$: Assume the schedule according to~$S$ for the entire time without the trips of $B$ and all route choices for customers except~$B$ as fix. Determine an optimal schedule within these restrictions.

\begin{definition}
\label{def:splitting_HSP}

Let ${B\subseteq\mathcal{C}}$. We set
\begin{align*}
	\zstart_B := \min_{c\in B}\zstart_c && \zend_B := \max_{c\in B}\zend_c
\end{align*}

and define a splitting $\left\{\mathcal{T}_1,\mathcal{T}_2,\mathcal{T}_3\right\}$ by
\begin{align*}
	\mathcal{T}_i := \begin{cases}
		\left\{t\in\mathcal{T}\mid \zstart_t<\zstart_B\right\} & \text{if } i=1 \\
		\left\{t\in\mathcal{T}\mid \zstart_B\leq\zstart_t\leq\zend_B\right\} & \text{if } i=2 \\
		\left\{t\in\mathcal{T}\mid \zend_B<\zstart_t\right\} & \text{if } i=3
	\end{cases}
\end{align*}

\end{definition}

The $(\operatorname{HSP}_B)$ is a partial instance of the Successive Heuristic with a splitting according to \Cref{def:splitting_HSP}. We split the duties of $S$ into three partial solutions $\left\{S_1,S_2,S_3\right\}$, each having trips only in $\Ti$. For this, we identify the transitions from $\mathcal{T}_1$ to $\mathcal{T}_2$ and from $\mathcal{T}_2$ to $\mathcal{T}_3$. These transitions form a start point set $\Vhat$ and an end point set $\Phat$. We solve the subproblem with a modified formulation of $(\operatorname{SMILP}_1)$. The vehicle set is replaced by $\Vhat$ and the end point set is $\Phat$. 

The start point set comprises the respective last trips of all partial duties of $S_1$ and all vehicles that have no duty in this partial solution. The end point set comprises the respective first trips in $S_3$. We set $\Vhat$ and $\Phat$ as
\begin{align*}
	\Vhat & := \left\{s\in\mathcal{V}\cupdot\mathcal{T}_1\mid\bar{x}_{s,t}=1\text{ for some } t\in\mathcal{T}_2\cupdot\mathcal{T}_3\cupdot\left\{\de\right\}\right\} \\
	\Phat & := \left\{t\in\mathcal{T}_3\mid\bar{x}_{s,t}=1\text{ for some } s\in\mathcal{V}\cupdot\mathcal{T}_2\cupdot\mathcal{T}_3\right\}
\end{align*}

Strictly speaking, $\Vhat$ and $\Phat$ consist of start or end points that are created from the respective trips. For each start or end point~$t$ that is created from a trip or vehicle $s$ hold the following properties:
\begin{align*}
	\pstart_t = \pend_t := \pend_s && \zstart_t = \zend_t := \zend_s && \text{for all } t\in\Vhat \\
	\pstart_t = \pend_t := \pstart_s && \zstart_t = \zend_t := \zstart_s && \text{for all } t\in\Phat
\end{align*}

How the initial fuel states $f^0_t$ for ${t\in\Vhat\cupdot\Phat}$ are created, is explained afterwards.

Using these definitions, we adapt the formulation $(\operatorname{SMILP}_1)$ to $(\operatorname{HSP}_B)$. The vehicle set~$\mathcal{V}$ is replaced by the start point set~$\Vhat$. We add the cover constraints
\begin{align}
	& \sum_{m\in C^{-1}(c)} u_m = 1 && \text{for all } c\in B \label{eq:HSP:customer} \\
	& \sum_{s\in\operatorname{N}_{\overline{G}_1}^-(t)} x_{s,t} = u_m && \text{for all } m\in C^{-1}(B),t\in m \label{eq:HSP:route} \\
	& \sum_{s\in\operatorname{N}_{\overline{G}_1}^-(t)} x_{s,t} = \bar{u}_{M(t)} && \text{for all } t\in\mathcal{T}_2\backslash(M\circ C)^{-1}(B) \label{eq:HSP:route_fix} \\
	& u_m\in\{0,1\} && \text{for all } m\in C^{-1}(B) \label{eq:HSP:um}
\end{align}

where $\bar{u}_m$ are the fixed route decisions of $S$ for ${m\in\mathcal{M}\backslash C^{-1}(B)}$. The constraints $\eqref{eq:HSP:customer}$, $\eqref{eq:HSP:route}$ and $\eqref{eq:HSP:um}$ ensure the cover constraints for all trips ${t\in(M\circ C)^{-1}(B)}$, \ie all trips of the reviewed customers. $\eqref{eq:HSP:route_fix}$ ensures that the fixed route decisions for all other customers are maintained. 

\begin{figure}[htb]
	\centering
	\begin{tikzpicture}[node distance=1cm, auto,]
		\node[circ] (de) {$d^{\operatorname{e}}$};
		\node[dummy, above=of de] (dummy1) {};
		\node[dummy, below=of de] (dummy2) {};
		\node[rect, left= 1.5cm of dummy2] (endpoints) {$\widehat{\mathcal{P}}$};
		\node[rect, left= 3cm of dummy1] (trips) {$\mathcal{T}_2$};
		\node[dummy, left= 2cm of trips] (dummy3) {};
		\node[dummy, below=of dummy3] (dummy4) {};
		\node[rect, above=0cm of dummy4] (startpoints) {$\mathcal{T}\cap\widehat{\mathcal{V}}$};
		\node[rect, below=0cm of dummy4] (vehicles) {$\mathcal{V}\cap\widehat{\mathcal{V}}$};
		\node[circ, left=of dummy4] (ds) {$d^{\operatorname{s}}$};
		\draw[arrow] (ds) to node[auto] {$0$} (startpoints.west);
		\draw[arrow] (ds) to node[auto, swap] {$0$} (vehicles.west);
		\draw[arrow] (startpoints.east) to node[auto] {$0$} (trips.west);
		\draw[arrow] (startpoints.east) to node[auto] {$0$} (endpoints.west);
		\draw[arrow, bend left=90] (startpoints.north) to node[auto] {$0$} (de.north);
		\draw[arrow] (vehicles.east) to node[auto, swap] {$c^{\operatorname{v}}$} (trips.west);
		\draw[arrow] (vehicles.east) to node[auto, swap] {$c^{\operatorname{v}}$} (endpoints.west);
		\draw[arrow, bend right=90] (vehicles.south) to node[auto, swap] {$0$} (de.south);
		\draw[arrow] (trips) to node[auto] {$0$} (endpoints);
		\draw[arrow] (trips.east) to node[auto] {$0$} (de);
		\draw[arrow] (endpoints.east) to node[auto] {$-c^{\operatorname{v}}$} (de);
	\end{tikzpicture}
	\caption{Vehicle cost in $(\operatorname{HSP}_B)$}
	\label{fig:graph_hsp}
\end{figure}

In $(\operatorname{HSP}_B)$, we decide the route of customers ${c\in B}$. Thus we add their route cost to the objective function. The vehicle cost is only caused by the vehicles, but not by the other start points. A partial duty that ends with an end point does not cause any vehicle cost since this cost is already considered in $S_3$. A duty that starts with a trip ${s\in\mathcal{T}\cap\Vhat}$ and ends with a trip ${t\in\Phat}$ has negative vehicle cost since it has been charged in $S_1$ and $S_3$. \Cref{fig:graph_hsp} illustrates the associated task graph and the vehicle cost for the subproblem. We replace the term
\begin{align*}
	\left(\sum_{s\in\mathcal{V}} \sum_{t\in\operatorname{N}^+_{\overline{G}_1}\backslash\left\{\de\right\}} x_{s,t} - \sum_{s\in\Phat_1} x_{s,\de}\right) \cv
\end{align*}

in $(\operatorname{SMILP}_1)$ by
\begin{align*}
	\left(\sum_{s\in\mathcal{V}\cap\Vhat} \sum_{t\in\operatorname{N}^+_{\overline{G}_1}\backslash\left\{\de\right\}} x_{s,t} - \sum_{s\in\Phat} x_{s,\de}\right) \cv + \sum_{m\in C^{-1}(B)} u_m \croute_m.
\end{align*}

\paragraph{Determination of the Initial Fuel States} \parfill

We now examine the determination of the initial fuel states $f^0_t$ for ${t\in\Vhat_2\cupdot\Phat_2}$. These fuel states should guarantee as feasible continuation of the existing duties. Besides this, we aim to have as much scope as possible for feasible solutions. Therefore the initial fuel state should be large for a start point and small for an end point. In order to determine the optimal initial fuel states, we draw up another linear program where all results are fixed by the existing solution and only the fuel states stay variable. Then we optimize the respective fuel values.

Given a solution ${S=\left(\bar{x},\bar{z},\bar{e},\bar{u}\right)}$ that is feasible in the $\eqref{eq:MMILP}$. We state the problems $\eqref{eq:FMILP_min}$ and $\eqref{eq:FMILP_max}$ as follows:

\begin{align}
	\min \quad & \sum_{s\in\mathcal{V}\cupdot\mathcal{T}} e_s \hphantom{\sum_{s\in\mathcal{V}} \sum_{t\in\Nout(s)\backslash\{d^{\operatorname{e}}\}} x_{s,t}\cv + u_m} \tag{$\operatorname{FMILP}^{\min}_S$} \label{eq:FMILP_min} \\
	\max \quad & \sum_{s\in\mathcal{V}\cupdot\mathcal{T}} e_s \tag{$\operatorname{FMILP}^{\max}_S$} \label{eq:FMILP_max} \\
	\text{s.t.} \quad & e_s \leq f_s^0 & & \text{for all } s\in\mathcal{V} \tag{\ref{eq:MMILP:initial_fuel}} \\
	& 0 \leq e_s - \sum_{r\in\Rst} \bar{z}_{s,r,t}\fd_{s,r} & & \text{for all } t\in\mathcal{T}, s\in\Nin(t) \label{eq:FMILP:min_fuel} \\
	& e_t \leq 1 - \ft_t - \sum_{r\in\Rst} \bar{z}_{s,r,t}\fd_{r,t} & & \text{for all } t\in\mathcal{T}, s\in\Nin(t) \label{eq:FMILP:max_fuel} \\
	& \omit\rlap{$\displaystyle{e_t \leq e_s - \bar{x}_{s,t}\left(f_{s,t}^{\operatorname{d}}+f_t^{\operatorname{t}}\right) - \sum_{r\in\Rst} \bar{z}_{s,r,t}\left(\fd_{s,r}+\ft_r+\fd_{r,t}-\fd_{s,t}\right) + \left(1-\bar{x}_{s,t}\right)}$} \nonumber \\
	& & & \text{for all } t\in\mathcal{T}, s\in\Nin(t) \label{eq:FMILP:fuel_consumption} \\
	& e_s\in[0,1] & & \text{for all } s\in V\backslash\left\{d^{\operatorname{s}},d^{\operatorname{e}}\right\} \tag{\ref{eq:MMILP:es}}
\end{align}

These formulations provide the same solution as $S$ with minimal or maximal fuel states, respectively. Let $e^{\min}$ be a solution of the $\eqref{eq:FMILP_min}$ and $e^{\max}$ be a solution of the $\eqref{eq:FMILP_max}$, then we define the initial fuel states as follows:
\begin{align*}
	f^0_t := e^{\max}_t && \text{for all } t\in\Vhat_2 && f^0_t := e^{\min}_t && \text{for all } t\in\Phat_2
\end{align*}

\paragraph{Creating an Improved Solution} \parfill

After constructing the subproblem, we describe how we compose the old solution and the result of the subproblem to a new feasible solution. Let $S$ be the current solution, $B\subseteq\mathcal{C}$ the set of critical customers and $\left\{\mathcal{T}_1,\mathcal{T}_2,\mathcal{T}_3\right\}$ the respective splitting. We create the partial solutions $S_1$ and $S_3$. Partial solution~$S_1$ consists of the partial duties of~$S$ ending with a trip or vehicle representing a start point ${t\in\Vhat_2}$. Partial solution~$S_3$ consists of the partial duties of~$S$ starting with a trip representing an end point ${t\in\Phat_2}$. 

Let $\widehat{S}_2$ be a solution of $(\operatorname{HSP}_B)$. Each of its partial duties certainly starts with a start point ${t\in\Vhat}$. It ends with a start point, a trip or an end point. For each partial duty ${d\in\widehat{S}_2}$, delete its start point and prepend the partial duty ${d'\in S_1}$ that ends with the trip representing the start point to it. If~$d$ ends with an end point, delete the end point and append the partial duty ${d'\in S_3}$ that starts with the trip representing the end point. All the so created duties are part of the new solution $\widehat{S}$. 

The cost of the new solution is
\begin{align*}
	\operatorname{cost}\left(\widehat{S}\right) = \operatorname{cost}\left(S_1\right) + \operatorname{cost}\left(\widehat{S}_2\right) + \operatorname{cost}\left(S_3\right) + \sum_{c\in\mathcal{C}\backslash B} \croute_{m(c)}
\end{align*}

where ${c\mapsto m(c)}$ describes the route decision for the previous solution $S$. We show that $\widehat{S}$ is again feasible and the cost does not increase.

\begin{lemma}
\label{lem:feasibility_hsp}

Let $S$ be a feasible solution of the $\eqref{eq:MMILP}$ and $B\subseteq\mathcal{C}$. Let $\widehat{S}$ be a solution that is computed as described in \Cref{sec:iterative_approach}. Then $\widehat{S}$ is also feasible and
\begin{align*}
	\operatorname{cost}\left(\widehat{S}\right) \leq \operatorname{cost}\left(S\right)
\end{align*}

\end{lemma}

\begin{proof}

The partial solutions $S_1$, $\widehat{S}_2$ and $S_3$ are connected in such a way that $\widehat{S}$ is feasible \wrt time. The initial fuel states in $\Vhat$ and $\Phat$ are computed appropriately in order to maintain fuel feasibility. For ${c\in B}$, the cover constraints are ensured by $\eqref{eq:HSP:customer}$, $\eqref{eq:HSP:route}$ and $\eqref{eq:HSP:um}$. By construction, $\widehat{S}$ fulfills exactly the same trips as $S$ for ${c\in\mathcal{C}\backslash B}$.

The deadhead and trip cost are determined as before. From the construction of the objective function of $(\operatorname{HSP}_B)$ follows that the vehicle cost arise exactly once for each non-empty duty in $\widehat{S}$. The vehicle cost is charged for each duty starting with a vehicle and not with a trip. It is subtracted for each duty ending with an end point. For ${c\in B}$, the route cost occurs in $\operatorname{cost}\left(\widehat{S}_2\right)$ and for ${c\in\mathcal{C}\backslash B}$ in the additional term.

The original solution $S_2$ is a feasible solution of the $(\operatorname{HSP}_B)$ by construction. Therefore the total cost of $\widehat{S}$ is not greater than the total cost of $S$.

\end{proof}

Finally, we describe the complete Iterative Approach to create a solution. First we solve the problem with the time-dependent Successive Heuristic according to \Cref{alg:successive_heuristic}. We call this initial solution~$S^0$. Based on this solution, we determine the customer sets $\left\{B_1,\dots,B_k\right\}$ with \Cref{alg:critical_customers}. For each ${i\in[k]}$ we create a new solution $S^i$ by the formulation $(\operatorname{HSP}_{B_i})$ based on the previous solution $S^{i-1}$. Due to \Cref{lem:feasibility_hsp}, the total cost does not increase during this process. Finally, we receive an improved solution $S^k$.

\paragraph{Remarks} \parfill

We provide several remarks concerning the developed heuristics and the results that can be expected or not.

Analogously to the customer-dependent heuristic, the time-dependent heuristic is not a constant-factor approximation. \Cref{ex:approximation_factor} directly applies to $(\operatorname{TMILP})$, too. With the same choice of the time point~$c_1$, the splitting $\left\{\mathcal{T}_1,\mathcal{T}_2\right\}$ is equal if it is performed according to \Cref{def:time_dependent_splitting}. Thus the heuristic solution can be arbitrarily bad compared to the optimal solution, even if all subproblems are solved to optimality.

In the iterative approach, there is not guarantee that an optimal solution is achieved. If we choose $B_1=\mathcal{C}$, \ie all customers are reviewed during one iteration, then we will receive an optimal solution. But the formulation $(\operatorname{HSP}_{\mathcal{C}})$ is equal to $\eqref{eq:MMILP}$ and it is expected that this formulation is too big to solve it in reasonable time for realistic problem sizes. Even if ${\Cupdot_{i=1}^k B_i = \mathcal{C}}$, \ie every customer is reviewed during the process, we cannot expect an optimal solution.

The previously discussed criteria, whether the route choice of a customer was bad, are only indications. It is not sure that a customer that fulfills all of them actually has a bad route choice. Further, changing the route for a customer does not necessarily improve the cost of the current solution, even if the new route is also chosen in an optimal solution. The subproblem does not certainly fix other bad heuristical decisions besides the route choice, \eg the assignment of trips to duties or the visitation of refuel points.

There are several ways to further improve the heuristics. We have not worked them out in detail and have not implemented them. We further cannot estimate how the additional computation time is in proportion to the additional cost saving. But we provide the main ideas in order to improve the heuristical solutions.
\begin{itemize}
	\item
We can put additional effort in the choice of the time points. We aim to have only few customers that are represented in more than one partial trip set. Preferably, the customers are represented in only few partial instances in summary. Nevertheless, the time points should be distributed evenly over time such that the partial instances have more or less the same size. We can create a supplementary subproblem for choosing the time points in a desirable way.
	\item
In partial instance~$I_i$, it is not beneficial to choose a route with ${m\cap\Ti=\emptyset}$. If such a route is the most suitable one, the route choice can be left open. In the next partial instance, the route is chosen among all routes with ${m\cap\Ti=\emptyset}$. In this case it is not necessary to fix the route choice in~$I_i$ because there are no trips to cover in this partial instance. In the next partial instance, there is more additional information available in order to choose a better route.
\end{itemize}

%----------------------------------------------------------------------------------------------------------------------------------------

%\subsection{Restricted Approach}
%\label{sec:restricted_approach}
%
%We regard the special case in which each customer has trips in at most two subsequent splittings. This can be ensured if the customer extension is bounded by the splitting length. We try to exploit this special structure. For each customer, we basically distinguish two cases: There are more trips of this customer in the later partial trip set (Case 1) or in the earlier partial trip set (Case 2). Remember that the later partial instance is solved earlier. In Case 1, the cost estimation for the routes is easy since most of the structure is already contained in this partial instance. In Case 2, there is not much structure in the first processed partial instance, thus the cost prediction will be imprecise. In order to prevent an imprecise cost estimation as in Case 2, we inspect the possibility of reversing a previous route choice in the later solved partial instance, if we find a better alternative there. In this section we inspect the potential of cost saving for a belated trip deletion and develop a more flexible formulation in order to receive a better solution.
%
%\begin{lemma}
%
%Let $\mathcal{C}$ be a customer set and let $c_i$ be time points for ${i\in[n-1]}$ with ${c_i<c_{i+1}}$ for all ${i\in[n-2]}$. Let
%\begin{align}
	%L_{\operatorname{C}}\leq L_{\operatorname{S}} \tag{\ref{eq:LCLS}}
%\end{align}
%
%For each customer $c\in\mathcal{C}$, there is some $i\in[n-1]$ such that
%\begin{align}
	%t\in\Ti\cupdot\mathcal{T}_{i+1} && \text{for all } t\in (M\circ C)^{-1}(c)
%\end{align}
%
%this means, each customer is represented in at most two subsequent splittings.
%
%\end{lemma}
%
%\begin{proof}
%
%For simplicity of notion, we state $c_0:=-\infty$ and $c_n:=+\infty$. Consider customer $c\in\mathcal{C}$ and $i\in[n]$ such that ${c_{i-1} \leq \zstart_c < c_i}$. For $i=n$ we have ${t\in\mathcal{T}_n}$ for all ${t\in\left(M\circ C\right)^{-1}(c)}$. For $i<n$ we have
%\begin{align*}
	%\zstart_c \leq \zstart_t \leq \zstart_c + L_{\operatorname{C}} < c_i + L_{\operatorname{C}} \leq c_i + L_{\operatorname{S}} \leq c_{i+1} && \text{for all } t\in (M\circ C)^{-1}(c)
%\end{align*}
%
%Thus we have
%\begin{align*}
	%t\in\mathcal{T}_i\cupdot\mathcal{T}_{i+1} && \text{for all } t\in (M\circ C)^{-1}(c)
%\end{align*}
%
%\end{proof}
%
%In the following considerations, we neglect all customers whose trips are contained in only one splitting. Their cover constraints are already ensured in the partial instance.
%
%Consider partial instance $i\in[n-1]$, the customer set
%\begin{align*}
	%\CR_i := \left\{c\in\mathcal{C}\mid\gamma(c)=i+1\land\left((M\circ C)^{-1}(c)\cap\Ti\right)\neq\emptyset\right\}
%\end{align*}
%
%and the route set
%\begin{align*}
	%\mathcal{M}^{\operatorname{R}}_i := \left\{m\in\mathcal{M}\mid C(m)\in\CR_i\land m\subset\Ti\right\}
%\end{align*}
%
%$\CR_i$ are all customers represented in $\Ti$ but initially treated in another partial instance, $\MR_i$ are all routes of these customers where all its trips are in $\Ti$.
%
%For each customers ${c\in\CR_i}$, the respective route choice is already done in partial instance~$I_{i+1}$. We regard the possibility to revise the previous route choice if we find a better alternative in partial instance~$I_i$. For this, we examine the cost saving for a belated trip deletion. As in \Cref{sec:iterative_approach}, the cost function $C_1(m)$ is used for cost estimation.
%
%\paragraph{Costs for Trip Replacement} \parfill
%
%We regard the possibility of deleting an already chosen route in partial instance~$I_i$. For this, we introduce the following notation.
%
%\begin{definition}
%
%Let $c\in\CR_i$ and let ${S_{i+1}=\left(\bar{x},\bar{z},\bar{e},\bar{u}\right)}$ be the partial solution of the previously solved partial instance, where the route of $c$ has been chosen. Let $\bar{m}(c)\in C^{-1}(c)$ be the unique route with $\bar{u}_m = 1$
%
%Let ${s_1(t)\in\left\{\ds_{i+1}\right\}\cupdot\mathcal{T}_{i+1}}$ and ${s_2(t)\in\mathcal{T}_{i+1}\cupdot\hat{\mathcal{P}}_{i+1}\cupdot\left\{\de_{i+1}\right\}}$ be the unique trips with $\bar{x}_{s_1,t}=\bar{x}_{t,s_2}=1$ for all $t\in\left(\bar{m}(c)\backslash\Ti\right)$ and let ${r(t)\in\mathcal{R}_{s_1(t),t}}$ if ${\bar{z}_{s_1(t),r,t}=1}$.
%
%Here, ${\ds_{i+1},\de_{i+1}\in\overline{V}_{i+1}}$ are the respective source and sink node of~$\overline{G}_{i+1}$.
%
%\end{definition}
%
%The route $\bar{m}(c)$ denotes the route that is chosen for customer $c\in\CR_i$ by the partial solution, $s_1(t)$ and $s_2(t)$ are the trips that are directly before and after this trip in its respective duty. 
%
%We assume ${\cd_{\ds,t}=\cd_{t,\de}=:0}$ for all ${t\in\mathcal{T}_{i+1}}$. If we delete 
%
%By assuming ${\cd_{\ds,t}=\cd_{t,\de}=:0}$ for all ${t\in\mathcal{T}_{\gamma(c)}}$, the cost saving for deleting a trip $t$ in partial instance $I_{\gamma(c)}$ is
%\begin{align*}
	%\cd_{s_1(t),t}+\ct_t+\cd_{t,s_2(t)}-\cd_{s_1(t),s_2(t)}
%\end{align*}
%
%\paragraph{Adaption of the Model} \parfill
%
%In the following, we adapt the formulation $(\operatorname{TMILP}_i)$ in order to allow a belated route replacement. The restriction $\eqref{eq:LCLS}$ is required for this formulation. It is also necessary that at least one adjacent partial instance is already solved. In this procedure, the partial instance is solved before, with the additional ability to replace already chosen routes under strong restrictions: If for customer $c\in\mathcal{C}$ a route has been chosen in a previously solved partial instance $I_{\gamma(c)}$ and there are routes whose trips are all in the partial trip set $\mathcal{T}_i$, then either one of these routes is chosen or the previous route decision is confirmed. The choice of another route is not possible since this would require an insertion of trips into an already existing partial solution. We call this formulation $\eqref{eq:RTMILPi}$. The underlying partial task graph $\overline{G}_i$ is not modified.
%
%We introduce new decision variables $u^c$ for $c\in\CR_i$. They indicate whether the route choice for customer $c$ is confirmed or not. If the route choice is not confirmed, adding of routes of the same customer is necessary. This is only possible, if all trips of this route are in $\mathcal{T}_i$. We therefore introduce decision variables $u_m$ for all $m\in\MR_i$.
%
%For every $c\in\CR_i$, either the previous choice must be confirmed or a new route is chosen. This is ensured by
%\begin{align}
	%u^c + \sum_{\substack{m\in\MR_i \\ C(m)=c}} u_m = 1 && \text{for all } c\in\CR_i \label{eq:RTMILP:customer_old}
%\end{align}
%
%We have $\overline{\mathcal{C}}_i = \CR_i$ since $\eqref{eq:LCLS}$. The constraint $\eqref{eq:TMILP:route_fix}$ ensures the route decisions of the previous partial instances. It is replaced by
%\begin{align}
	%& \sum_{s\in\Ninoi(t)} x_{s,t} = u^c && \text{for all } c\in\CR_i, t\in\bar{m}(c)\cap\Ti \label{eq:RTMILP:route_confirmed} \\
	%& \sum_{s\in\Ninoi(t)} x_{s,t} = u_m && \text{for all } t\in M^{-1}\left(\MR_i\right) \label{eq:RTMILP:route_old} \\
	%& \sum_{s\in\Ninoi(t)} x_{s,t} = 0 && \text{for all } c\in\CR_i, t\in M^{-1}\left(C^{-1}(c)\backslash\left(\MR_i\cup\left\{\bar{m}(c)\right\}\right)\right)\cap\Ti \label{eq:RTMILP:route_fix}
%\end{align}
%
%The constraint $\eqref{eq:RTMILP:route_confirmed}$ ensures the route satisfaction for the previously decided route, $\eqref{eq:RTMILP:route_old}$ for all route completely in $\Ti$ and $\eqref{eq:RTMILP:route_fix}$ for all other trips in $\Ti$. Note that $\mathcal{C}_i\cap\CR_i = \emptyset$. Hence, $\eqref{eq:TMILP:customer}$ and $\eqref{eq:TMILP:route}$ are not influenced by them. We contract $\eqref{eq:TMILP:route}$ and $\eqref{eq:RTMILP:route_old}$ to
%\begin{align}
	%\sum_{s\in\Ninoi(t)} x_{s,t} = u_m && \text{for all } m\in\MR_i\cupdot C^{-1}\left(\mathcal{C}_i\right), t\in m\cap\Ti \label{eq:RTMILP:route}
%\end{align}
%
%Finally, we replace $\eqref{eq:TMILP:um}$ by
%\begin{align}
	%& u_m\in\{0,1\} && \text{for all } m\in C^{-1}\left(\mathcal{C}_i\right)\cupdot\MR_i \label{eq:RTMILP:um} \\
	%& u^c \in\{0,1\} && \text{for all } c\in\CR_i \label{eq:RTMILP:uc}
%\end{align}
%
%\paragraph{Cost Function} \parfill
%
%We have to consider additional contributions to the cost function. If the route choice is not confirmed, the trips of $\bar{m}(c)$ are deleted and the route cost and the saved cost are subtracted from the cost function. We define these cost as
%\begin{align*}
	%\hat{c}_c := \croute_{\bar{m}(c)} + \sum_{t\in\left(\bar{m}(c)\backslash\Ti\right)} \left(\cd_{s_1(t),t}+\ct_t+\cd_{t,s_2(t)}-\cd_{s_1(t),s_2(t)}\right) && \text{for } c\in\CR_i
%\end{align*}
%
%Note, that the costs $\ct$ and $\cd$ belong to the partial instance $I_{\gamma(i)}$ and are not part of the considered partial task graph $\overline{G}_i$. The term $\hat{c}_c$ describes the cost saving for not confirming the route choice of $c$ and is completely given in advance.
%
%In order to determine the route costs for all $c\in\CR_i$, we add the following term to the objective function.
%\begin{align*}
	%\sum_{m\in\MR_i} u_m \croute_m - \sum_{c\in\CR_i} \left(1-u^c\right)\hat{c}_c
%\end{align*}
%
%In summary, the formulation $\eqref{eq:RTMILPi}$ is given by $\eqref{eq:SMILPi}$ with the constraints $\eqref{eq:TMILP:customer}$, $\eqref{eq:RTMILP:customer_old}$, $\eqref{eq:RTMILP:route_confirmed}$, $\eqref{eq:RTMILP:route_fix}$, $\eqref{eq:RTMILP:route}$, $\eqref{eq:RTMILP:um}$ and $\eqref{eq:RTMILP:uc}$ and the objective function
%\begin{align}
	%&\left(\sum_{s\in\Ti\cup\Phat_i} x_{\ds,s} - \sum_{s\in\Phat_i} x_{s,\de}\right)\cv + \sum_{m\in C^{-1}\left(\mathcal{C}_i\right)} u_m \hat{c}^{\operatorname{r}}_m + \sum_{m\in\MR_i} u_m \croute_m + \sum_{c\in\CR_i} \left(u^c - 1\right)\hat{c}_c \nonumber \\
	%+ & \sum_{t\in\Ti\cup\Phat_i}\sum_{s\in\Ninoi(t)\backslash\left\{\ds\right\}}\left[x_{s,t}\left(\cd_{s,t}+\ct_t\right)+\sum_{r\in\Rst}z_{s,r,t}\left(\cd_{s,r}+\cd_{r,t}-\cd_{s,t}\right)\right] \tag{$\operatorname{RTMILP}_i$} \label{eq:RTMILPi}
%\end{align}
%
%%----------------------------------------------------------------------------------------------------------------------------------------
%
%\subsection{Improvements}
%
%This is listing of comments regarding this section. It includes some small changes that can be made in the formulations in order to improve the performance, some new considerations and some small mistakes, where the developed methods work inaccurately but there is not an easy handling.
%
%\begin{enumerate}
	%\item{$\eqref{eq:LCLS}$ does not hold in general}:
%It is possible that each customer is represented in at most two splittings although $\eqref{eq:LCLS}$ does not hold. If this is not the case, one can possibly deviate some split points by a small value \st the condition holds. If only a small number of customers exceeds the splitting length, their exclusion from the formulations $(\operatorname{HSP}_c)$ or $\eqref{eq:RTMILPi}$ still promises good results.
	%\item{Create Preprocessing}:
%One can create the split points via an own problem. The goal of this preprocessing is minimizing the customers represented in several splittings, constraints are a minimal and a maximal splitting length. If there are only few customers in more than one splitting, the solution behavior is improved.
	%\item{Strategy for route choice in \Cref{sec:iterative_approach}}:
%In $I_i$, it is not beneficial to choose a route with $m\cap\Ti=\emptyset$. If such a route is the most suitable one, one can leave the choice open and choose in the next partial instance among all routes with $m\cap\Ti=\emptyset$. In $I_i$ is is not necessary to choose the route because there are no trips to cover, thus it is not beneficial fix the route choice already there.
	%\item{Strategy for route choice in \Cref{sec:restricted_approach}}:
%In $I_{\gamma(c)}$, it is beneficial to choose a route with $m\cap\mathcal{T}_{\gamma(c)}\neq\emptyset$, even is another choice, \ie $m'\in\MR_i$ is more beneficial there. If $m$ is a bad choice at the end, it will be reversed in $I_i$. If $m$ is a good choice against expectation, it will be confirmed in $I_i$.
	%\item{Deleting subsequent trips}:
%If in $\eqref{eq:RTMILPi}$ two subsequent trips of the same duty are deleted, the value for cost saving is wrong. For four subsequent trips $t_1, t_2, t_3, t_4$ where $t_2, t_3$ are deleted, the difference between the real cost saving and the computed cost saving is ${\cd_{t_1,t_4}+\cd_{t_2,t_3}-\cd_{t_1,t_3}-\cd_{t_2,t_4}}$. If there a subsequent trips of the same route in the same duty, the term can be adapted. An exact solution would be the introduction of a decision variable for each combination of route deletions.
%\end{enumerate}