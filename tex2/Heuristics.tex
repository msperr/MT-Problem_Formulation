\chapter{Successive Heuristics}
\label{ch:heuristics}

In this chapter, successive heuristics are introduced in order to solve our problem. As seen in \Cref{sec:complexity}, the problem is ${\mathcal{NP}\text{-hard}}$ even if we apply one of the restrictions, the cover constraints or the fuel constraints, individually. Our goal is to develop a heuristic that can cope with both multi-leg cover constraints and fuel constraints. We build our heuristic on a heuristic for a simpler version of the problem, developed in the underlying theses. \cite{Knoll} present heuristical solution methods for the problem only with fuel constraints. The problem settings assumes that there is a set of trips where each of these trips shall be fulfilled. They already claim, that solving a complete instance of 24 hours to optimality is not possible with their respective computing capacity. Therefore it is a plausible assumption that an optimal solution for our problem cannot be expected in reasonable time. 

Their solution methods are based on the idea of splitting the complete instance according to several time intervals. For each interval, only the trips starting in the respective interval are considered. From this formulation emerge several separate partial instances that are still loosely connected to each other. Each of these partial instances is solved separately and then the partial solutions are connected to a complete feasible solution. Two different approaches are presented in order to solve the problem: The constraints connecting the partial instances are relaxed by using Lagrange Relaxation. With suitable computation of Lagrange multipliers, the partial instances are solved in parallel. In the other one, the partial instances are solved successively, where the respective connecting constraints are fixed beginning from the end.

An adaption of the cover constraints to the heuristic using Lagrange Relaxation seems not practicable. This heuristics heavily exploits the loosely connection of the partial instances. The cover constraints strongly influence the complete instance by selecting the fulfilled trips, the multi-leg cover constraints even require an additional set of variables, belonging to none of the partial instances. Therefore, an additional relaxing of these cover constraints is not a promising approach. Instead, we focus on the second approach of Successive Heuristics.

The crucial difficulty for this procedure is to ensure the customer satisfaction. In particular, if trips of a customer are wide apart in terms of time, these trips will lie in different splittings. This makes it hard to keep control over the trip selection in separately solved partial instances.

We first define the splitting of the instance and the arising adaptions of task graph and model. Then, we describe the heuristic in general. Finally, we introduce different splitting methods, one according to the customers and one according to time. 

%########################################################################################################################################
%#
%#   Successive Heuristics
%#
%########################################################################################################################################

\section{Successive Heuristics}

\subsection{Splitting the Problem}

In order to create the partial instances, we define splittings of $\mathcal{V}$ and $\mathcal{T}$. In contrast to \cite{Knoll}, we define the splittings in a general way.

\begin{definition}[Splitting]
\label{def:splitting}

Let $n\in\mathbb{N}$ and let
\begin{align*}
	\mathcal{T}=\Cupdot_{i=1}^n\Ti && \mathcal{V}=\Cupdot_{i=1}^n\Vi
\end{align*}

be partitions of the set of trips, respectively vehicles. Then we call $\left\{\Ti\mid i\in[n]\right\}$ and $\left\{\Vi\mid i\in[n]\right\}$ splitting of $\mathcal{T}$ and $\mathcal{V}$ and $\Ti$ and $\Vi$ partial trip respectively vehicle set.

\end{definition}

\paragraph{Adaption of the Task Graph} \parfill

We transform our task graph such that it contains the splittings as defined in \Cref{def:splitting}. For this, we introduce so called split points connecting the partial sets. Arcs that connected two partial sets before, take a detour over the respective split point in the transformed graph.

\begin{definition}[Transformed Task Graph]

Let $\left\{\mathcal{T}_1,\dots\mathcal{T}_n\right\}$ be a splitting of $\mathcal{T}$ according to \Cref{def:splitting}. Then we define:
\begin{enumerate}
	\item{Split Point: Let $s\in\Ti$ for $i\in[n]\backslash\{1\}$. For $j\in[i-1]$, we define the split point $\SPjs$ with $\pstart_{\SPjs}=\pend_{\SPjs}=:\pstart_s, \zstart_{\SPjs}=\zend_{\SPjs}=:\zstart_s$ and $\ft_{\SPjs}=:0$.}
	\item{For $i\in[n]\backslash\{1\}$ and $j\in[i-1]$, we define $\mathcal{P}_{j,i}:=\left\{\SPjs\mid s\in\Ti\right\}$.}
	\item{Partial Split Point Set: For $j\in[n-1]$, we define the partial split point set $\mathcal{P}_j:=\Cupdot_{i=j+1}^n \mathcal{P}_{j,i}$.}
	\item{Split Point Set: We define the split point set $\mathcal{P}:=\Cupdot_{j=1}^{n-1}\mathcal{P}_j$.}
\end{enumerate}

Let $G=(V,A)$ be the task graph, $\left\{\mathcal{V}_1,\dots,\mathcal{V}_n\right\}$ a splitting of $\mathcal{V}$.
\begin{enumerate}
	\setcounter{enumi}{4}
	\item{Transformed Task Graph: We define the transformed task graph $\overline{G}=\left(\overline{V},\overline{A}\right)$ with vertex set
		\begin{align*}
			\overline{V} := V\cup \mathcal{P} = V\cup\left\{\operatorname{SP}_i(s)\mid i\in[n-1],j\in[n+1]\backslash[i],s\in\mathcal{T}_j\right\}
		\end{align*}
		and arc set
		\begin{align*}
			\overline{A} := & \left(\ds\times\mathcal{V}\right)\cupdot\bigcup_{i=1}^n\left\{(s,t)\in\left(\Vi\cupdot\Ti\right)\times\left(\Ti\cupdot \mathcal{P}_i\right)\mid s\prec t\right\} \\
			& \cupdot\bigcup_{i=1}^n\left\{(s,t)\in\left(\left(\bigcup_{j=1}^{i-1} \mathcal{P}_{j,i}\right)\times\Ti\right)\mid s=\operatorname{SP}_i(t)\right\}\cupdot \left(\left(\mathcal{V}\cupdot\mathcal{T}\right)\times\left\{\de\right\}\right)
		\end{align*}}
\end{enumerate}

\end{definition}

\paragraph{Adaption of the Model} \parfill

In order to adapt $\eqref{eq:MMILP}$ to the transformed task graph, we make the following considerations:

For all split points we define the costs and fuel states as
\begin{align*}
	\ct_s := 0 && \cd_{s,t} := 0 && \ft_s := 0 && \fd_{s,t} := 0 && \text{for } s\in \mathcal{P},t\in\Nouto(s)
\end{align*}

since $\pend_s = \pstart_t$ and $\zend_s = \zstart_t$. Furthermore, refueling is not possible between $s$ and $t$.

In the transformed task graph, the arcs between two trips of different splittings are replaced by the detour over the splitting point. Therefore, the trip costs of trip directly after a split point are not considered in the objective function any more. In order to compensate this, we add the following term to the objective function:
\begin{align*}
	\sum_{s\in \mathcal{P}}\sum_{t\in\Nouto(s)}x_{s,t}\ct_t
\end{align*}

We want to ensure the flow conservation also in the new nodes $\mathcal{P}$, thus we add the inequality
\begin{align}
	\sum_{t\in\Nino(s)} x_{t,s} = \sum_{t\in\Nouto(s)} x_{s,t} & & \text{for all } s\in\mathcal{P} \label{eq:SMILP:splitpoint_flow}
\end{align}

The equations $\eqref{eq:MMILP:flow}$ and $\eqref{eq:SMILP:splitpoint_flow}$ are contracted to
\begin{align}
	\sum_{t\in\Nino(s)} x_{t,s} = \sum_{t\in\Nouto(s)} x_{s,t} & & \text{for all } s\in \overline{V}\backslash\left\{d^{\operatorname{s}},d^{\operatorname{e}}\right\} \label{eq:SMILP:flow}
\end{align}

\newpage

\begin{align}
	\min \quad & \omit\rlap{$\displaystyle{\sum_{s\in\mathcal{V}} \sum_{t\in\Nouto(s)\backslash\{d^{\operatorname{e}}\}} x_{s,t}\cv + \sum_{s\in \mathcal{P}}\sum_{t\in\Nouto(s)} x_{s,t} \ct_t + \sum_{m\in\mathcal{M}} u_m \croute_m}$} \nonumber \\
	& \omit\rlap{$\displaystyle{ + \sum_{t\in\mathcal{T}\cup \mathcal{P}} \sum_{s\in\Nino(t)\backslash \mathcal{P}} \left[x_{s,t}\left(\cd_{s,t}+\ct_t\right) + \sum_{r\in\Rst} z_{s,r,t}\left(\cd_{s,r}+\cd_{r,t}-\cd_{s,t}\right)\right]}$} \tag{SMILP} \label{eq:SMILP} \\
	\text{s.t.} \quad & \sum_{t\in\Nino(s)} x_{t,s} = \sum_{t\in\Nouto(s)} x_{s,t} & & \text{for all } s\in \overline{V}\backslash\left\{d^{\operatorname{s}},d^{\operatorname{e}}\right\} \tag{\ref{eq:SMILP:flow}} \\
	& \sum_{s\in\Nino(t)} x_{s,t} = 1 & & \text{for all } t\in\mathcal{V} \tag{\ref{eq:MMILP:vehicles}} \\
	& \sum_{m\in C^{-1}(c)} u_m = 1 && \text{for all } c\in\mathcal{C} \tag{\ref{eq:MMILP:customer}} \\
	& \sum_{s\in\Nino(t)} x_{s,t} = u_m && \text{for all } m\in\mathcal{M},t\in m \tag{\ref{eq:MMILP:route}} \\
	& \sum_{r\in\Rst} z_{s,r,t} \leq x_{s,t} & & \text{for all } t\in\mathcal{T}\cup \mathcal{P}, s\in\Nino(t)\backslash \mathcal{P} \label{eq:SMILP:refuel} \\
	& e_s \leq f_s^0 & & \text{for all } s\in\mathcal{V} \tag{\ref{eq:MMILP:initial_fuel}} \\
	& 0 \leq e_s - \sum_{r\in\Rst} z_{s,r,t}\fd_{s,r} & & \text{for all } t\in\mathcal{T}\cup \mathcal{P}, s\in\Nino(t)\backslash \mathcal{P} \label{eq:SMILP:min_fuel} \\
	& e_t \leq 1 - \ft_t - \sum_{r\in\Rst} z_{s,r,t}\fd_{r,t} & & \text{for all } t\in\mathcal{T}\cup \mathcal{P}, s\in\Nino(t)\backslash \mathcal{P} \label{eq:SMILP:max_fuel} \\
	& \omit\rlap{$\displaystyle{e_t \leq e_s - x_{s,t}\left(f_{s,t}^{\operatorname{d}}+f_t^{\operatorname{t}}\right) - \sum_{r\in\Rst} z_{s,r,t}\left(\fd_{s,r}+\ft_r+\fd_{r,t}-\fd_{s,t}\right) + \left(1-x_{s,t}\right)}$} \nonumber \\
	& & & \text{for all } t\in\mathcal{T}\cup \mathcal{P}, s\in\Nino(t)\backslash \mathcal{P} \label{eq:SMILP:fuel_consumption} \\
	& e_t \leq e_s-x_{s,t}\ft_t+\left(1-x_{s,t}\right) && \text{for all } s\in \mathcal{P},t\in\Nouto(s) \tag{\ref{eq:SMILP:fuel_splitpoint}} \\
	& x_{s,t}\in\{0,1\} & & \text{for all } (s,t)\in\overline{A} \\
	& z_{s,r,t}\in\{0,1\} & & \text{for all } t\in\mathcal{T}\cup \mathcal{P},s\in\Nino(t)\backslash \mathcal{P},r\in\Rst \\
	& e_s\in[0,1] & & \text{for all } s\in\overline{V}\backslash\left\{d^{\operatorname{s}},d^{\operatorname{e}}\right\} \\
	& u_m \in\{0,1\} && \text{for all } m\in\mathcal{M} \tag{\ref{eq:MMILP:um}}
\end{align}

The fuel constraints are adapted in the following way: $\eqref{eq:MMILP:refuel}$, $\eqref{eq:MMILP:min_fuel}$, $\eqref{eq:MMILP:max_fuel}$ and $\eqref{eq:MMILP:fuel_consumption}$ hold also on the arcs leading to $\mathcal{P}$ and are therefore replaced by $\eqref{eq:SMILP:refuel}$, $\eqref{eq:SMILP:min_fuel}$, $\eqref{eq:SMILP:max_fuel}$ and $\eqref{eq:SMILP:fuel_consumption}$.

Further the arcs leading from a split points to its respective trips have to be considered. Since refueling is not possible there, we have only to adapt $\eqref{eq:MMILP:fuel_consumption}$. Since $\fd_{s,t} = 0$ and refueling is not possible between $s$ and $t$, the constraint reads as follows:
\begin{align}
	e_t \leq e_s - x_{s,t}\ft_t + \left(1-x_{s,t}\right) && \text{for all } s\in \mathcal{P},t\in\Nouto(s) \label{eq:SMILP:fuel_splitpoint}
\end{align}

The customer constraints $\eqref{eq:MMILP:customer}$ are not affected by transforming the graph. The decision whether a trip $t\in\mathcal{T}$ is fulfilled is still given by $\sum_{s\in\Nino(t)} x_{s,t}$, no matter if the ingoing arc is a split point or not. Thus, the route constraints $\eqref{eq:MMILP:route}$ do not change either.

Putting all together, we have the formulation $\eqref{eq:SMILP}$.

%----------------------------------------------------------------------------------------------------------------------------------------

\subsection{General Setting}
\label{sec:general_setting}

In this section, we describe the general setting of the Successive Heuristics. First we describe how the partial task graph is created, given a splitting of $\mathcal{V}$ and $\mathcal{T}$. It is based on $\overline{G}$ and contains start and end points, which are created in the partial instances solved before this. Then we treat the order in which the partial instances are solved. The first partial instance is a special instance since there the vehicles come into play. Therefore, this instance is solved last. We explain how start and end points are are created out of a partial solution. Finally, we describe the feasible connection of the partial instances to an overall solution.

\paragraph{Order of Solving the Partial Instances} \parfill

Consider a splitting $\left\{\mathcal{T}_1,\dots,\mathcal{T}_n\right\}$ and $\left\{\mathcal{V}_1,\dots,\mathcal{V}_n\right\}$ for $\mathcal{T}$ and $\mathcal{V}$ respectively. Let $\sigma\in S_n$ be a permutation of $[n]$ with $\sigma(n)=1$. $\sigma$ indicates in which order the partial instances are solved. This means, partial instance $\sigma(i)\in[n]$ is solved at the $i$-th position, the first partial instance is solved at last. The actual specification of $\sigma$ follows in the description of the respective heuristic. 

\paragraph{Determination of Start and End Points} \parfill

The sets of start and end points $\Vhat_i, \Phat_i$ are initially empty for all $i\in[n]$. Assume, we have solved the partial instance $\sigma(i)$ just now. Based on the received partial solution, we update the start point set of the next partial instance after $\sigma(i)$ and we update the end point set of the next partial instance before $\sigma(i)$ which is not yet solved. This means, we update $\Vhat_{\sigma(j)}$ and $\Phat_{\sigma(k)}$ for ${j=\argmin_{j>i}\left\{\sigma(j)\mid \sigma(j)>\sigma(i)\right\}}$ and ${k=\argmin_{k>i}\left\{\sigma(k)\mid \sigma(k)<\sigma(i)\right\}}$.

For each duty of the partial solution that does either visit no node out of $\Vhat_{\sigma(i)}$ or no node out of $\Phat_{\sigma(i)}$, we create a start point and/or an end point. If a duty starts with a trip or an end point $s$, we create an end point out of it. The end point $t$ has the following properties
\begin{align*}
	\pstart_t = \pend_t := \pstart_s && \zstart_t = \zend_t := \zstart_s && f_t^0 := e_s + \ft_s
\end{align*}

where $e_s$ is the respective value of decision variable $e$ in the partial solution. We add $t$ to the end point set $\Phat_{\sigma(k)}$. If a duty ends with a trip or a start point $s$, we create a start point out of it. The start point $t$ has the following properties
\begin{align*}
	\pstart_t = \pend_t := \pend_s && \zstart_t = \zend_t := \zend_s && f_t^0 := e_s
\end{align*}

where $e_s$ is the respective value of decision variable $e$ in the partial solution. We add $t$ to the start point set $\Vhat_{\sigma(j)}$.

For each start or end point $s$, we call the respective trip $t$ from where it is created, the trip representing $t$. If a start point $t$ is created from a start point $s$, the trip representing $t$ is the trip representing $s$. Note, that each start point ${s\in\bigcup_{i=1}^n\Phat_i}$ has a trip ${t\in\mathcal{T}}$ representing it. This works analogously for end points.

\begin{remark}

Since $\sigma(n)=1$, the set ${\left\{k>i\mid\sigma(k)<\sigma(i)\right\}}$ is never empty for $i\in[n-1]$. Therefore, it is always possible to create an end point. If there is no later partial instance left, which is not yet solved, \ie ${\left\{j>i\mid\sigma(j)>\sigma(i)\right\}=\emptyset}$, then we create no start points out of $\sigma(i)$.

If a duty consists of exactly one trip, then for this trip we create both a start and an end point.

\end{remark}

The partial instance $I_1$ has a special role. In this instance, we have no start points, but we include the vehicle set $\mathcal{V}$. Therefore, we set ${\Vhat_1:=\mathcal{V}}$. Since $I_1$ is solved last, here is decided which vehicles are actually used. 

\begin{algorithm}
	\SetAlgoLined
	\KwIn{splitting $\mathcal{T}=\left\{\mathcal{T}_1,\dots,\mathcal{T}_n\right\}$, $\mathcal{V}=\left\{\mathcal{V}_1,\dots,\mathcal{V}_n\right\}$, $\sigma\in S_n$ with $\sigma(n)=1$}
	\KwOut{overall solution $S$}
	\ForEach{$i\in[n]$}{
		$\Vhat_{\sigma(i)}\gets\emptyset$\;
		$\Phat_{\sigma(i)}\gets\emptyset$\;
	}
	\ForEach{$i\in[n-1]$}{
		solve partial instance~$\sigma(i)$, receive partial solution~$S_{\sigma(i)}$ with duty set~$D_{\sigma(i)}$\;
		$j=\argmin_{j>i}\left\{\sigma(j)\mid\sigma(j)>\sigma(i)\right\}, k=\argmin_{k>i}\left\{\sigma(k)\mid\sigma(k)<\sigma(i)\right\}$\;
		\ForEach{$D_{\sigma(i)}\ni d=\left(s_1,\dots,s_l\right)$}{
			\If{$s_1\in\mathcal{T}_{\sigma(i)}\cupdot\Phat_{\sigma(i)}$}{
				create end point $t$\;
				$\pstart_t\gets\pstart_{s_1}, \pend_t\gets\pstart_{s_1}, \zstart_t\gets\zstart_{s_1}, \zend_t\gets\zstart_{s_1}, f_t^0\gets e_{s_1} + \ft_{s_1}$\;
				$\Phat_{\sigma(k)}\gets\Phat_{\sigma(k)}\cup\{t\}$\;
			}
			\If{$s_l\in\Vhat_{\sigma(i)}\cupdot\mathcal{T}_{\sigma(i)}$}{
				create start point $t$\;
				$\pstart_t\gets\pend_{s_l}, \pend_t\gets\pend_{s_l}, \zstart_t\gets\zend_{s_l}, \zend_t\gets\zend_{s_l}, f_t^0 := e_{s_l}$\;
				$\Vhat_{\sigma(j)}\gets\Vhat_{\sigma(j)}\cup\{t\}$\;
			}
		}
	}
	$\Vhat_1\gets\mathcal{V}$\;
	solve partial instance $1$, receive partial solution~$1$ with duty set~$D_1$\;
	\ForEach{$D_1\ni d = \left(s_1,\dots,s_l\right)$}{
		\Repeat{Duty finished}{
			\If{$s_l\in\bigcup_{i=1}^{n}\Phat_i$}{
				determine duty $d'=\left(t_1,\dots,t_{l'}\right)$ with $t_1$ representing $s_l$\;
				$d\gets\left(s_1,\dots,s_{l-1},t_1,\dots,t_{l'}\right)$\;
			}
			\ElseIf{$\exists d'\in\bigcup_{i=1}^{n} D_i$ \st $s_l$ represents $t_1\in\bigcup_{i=1}^{n}\Vhat_i$}{
				determine duty $d'=\left(t_1,\dots,t_{l'}\right)$\;
				$d\gets\left(s_1,\dots,s_l,t_2,\dots,t_{l'}\right)$\;
			}
			\lElse{Duty finished}
		}
	}
	\Return{$S$ with duties $d\in D_1$}
	\caption{Successive Heuristic (general setting) \label{alg:successive_heuristic}}
\end{algorithm}

\paragraph{Feasible Connection of Partial Solutions} \parfill

In order to generate an overall solution which is feasible for $\eqref{eq:MMILP}$, we connect the partial solutions. Let ${\left\{S_1,\dots\S_n\right\}}$ be the partial solutions, solved as described before with the start and end points created as before. The connection works as follows:

For each duty of $S_1$, we check whether it ends with an end point $t\in\bigcup_{i=1}^n\Phat_i$. We call this duty start duty.
\begin{itemize}
	\item{If it does, we delete the end point and append the duty of $S_i$ for ${i\in[n]\backslash\{1\}}$, that starts with the trip representing $t$, to the start duty. We then restart this procedure with the new end of the start duty.}
	\item{If it does not, it ends with a trip or start point ${t\in\left(\mathcal{T}\cupdot\bigcup_{i=1}^n\Vhat_i\right)}$. We check whether there is a duty in $S_i$ for ${i\in[n]\backslash\{1\}}$, that starts with a start point represented by $t$. If such a duty exists, we append it without the start point to the start duty. We then restart this procedure with the new end of the start duty. If no such duty exists, this start duty is finished}.
\end{itemize}

%----------------------------------------------------------------------------------------------------------------------------------------

\subsection{Identifying the Subproblems}

Given a splitting of $\mathcal{T}$ and $\mathcal{V}$, we describe how the subproblems of $\eqref{eq:SMILP}$ are created. For each partial trip and vehicle set $\mathcal{T}_i$, $\mathcal{V}_i$, we solve a partial instance $I_i$. We call the solution of a partial instance $I_i$ partial solution $S_i$. 

\paragraph{Partial Instances} \parfill

First we define the task graph with which we can solve the partial instances. The transformed task graph $\overline{G}$ covers the complete instance, but contains the partial sets from the splittings of $\mathcal{V}$ and $\mathcal{T}$. The partial task graph $\overline{G}_i$ only contains the respective partial trip and vehicle set. It additionally contains a start point set $\hat{\mathcal{V}}_i$ and an end point set $\hat{\mathcal{P}}_i$. How these sets are defined is explained later.

\begin{definition}[Partial Transformed Task Graph]

Let $i\in[n]$. For a set of start points $\Vhat_i$, a set of end points $\Phat_i$ and the partial trip set $\Ti$, the partial transformed task graph is the directed graph $\overline{G}_i=\left(\overline{V}_i,\overline{A}_i\right)$ with vertex set
\begin{align*}
	\overline{V}_i := \left\{\ds,\de\right\}\cupdot\Vhat_i\cupdot\Ti\cupdot\Phat_i
\end{align*}

and arc set
\begin{align*}
	\overline{A}_i := & \left(\left\{\ds\right\}\times\left(\Vhat_i\cupdot\Ti\cupdot\Phat_i\right)\right)\cupdot\left\{(s,t)\in\left(\Vhat_i\cupdot\mathcal{T}\right)\times\left(\Ti\cupdot\Phat_i\right)\mid s\prec t\right\} \\
	& \cupdot\left(\left(\Vhat_i\cupdot\Ti\cupdot\Phat_i\right)\times\left\{\de\right\}\right)
\end{align*}

\end{definition}

\paragraph{Solving of the Partial Instances} \parfill

In order to solve each partial instance, we create a formulation which is based on the partial transformed task graph $\overline{G}_i$. The flow constraints and the fuel constraints are basically the same as in $\eqref{eq:SMILP}$, restricted to $\overline{G}_i$. This formulation is only a basic structure for the partial instances. Some details are depending on the actual choice of the splitting and left out here. These details are inserted later.

In the partial instance, there is no vehicle set anymore. Instead we ensure that each start and each end point is visited. Therefore we replace $\eqref{eq:MMILP:vehicles}$ by
\begin{align}
	& \sum_{s\in\Ninoi(t)} x_{s,t} = 1 && \text{for all } t\in\Vhat_i\cup\Phat_i \label{eq:CMILP:start_end_points}
\end{align}

For start and end points, we are given initial fuel levels. The initial fuel level for a start point indicates the still available fuel from the end of the previous partial duty. The initial fuel level for an end point indicates the required fuel for the start of the next partial duty. Therefore, these fuel levels work as boundaries for the duties considered in this partial instance. In order to guarantee this, we introduce the constraints
\begin{align}
	& e_s \leq f^0_s && \text{for all } s\in\Vhat_i \label{eq:CMILP:initial_fuel} \\
	& f^0_s \leq e_s && \text{for all } s\in\Phat_i \label{eq:CMILP:final_fuel}
\end{align}

Since there are no vehicles in the partial instance, the constraint $\eqref{eq:MMILP:initial_fuel}$ is dropped.

We introduce two additional constraints. If a duty starts or ends with a trip, then the fuel at the start or at the end of this duty has to be in certain boundaries $f^{\min}$ or $f^{\max}$, respectively. How these boundaries are actually defined, is part of the heuristic. The constraints are the following:
\begin{align}
	& e_s + \ft_s \leq f^{\max}_s + \left(1-x_{\ds,s}\right)\cdot\left(1+\ft_s\right) && \text{for all } s\in\Ti \label{eq:CMILP:fmax} \\
	& f^{\min}_s \leq e_s + \left(1-x_{s,\de}\right) && \text{for all } s\in\Ti \label{eq:CMILP:fmin}
\end{align}

As mentioned before, it requires some additional work to include the cover constraints into the partial instances. The fulfilling of the cover constraints is also part of the respective heuristics and therefore $\eqref{eq:MMILP:customer}$ and $\eqref{eq:MMILP:route}$ are left out in this formulation.

\paragraph{Cost Function} \parfill

The trip costs are handled as before. If a trip is fulfilled, it is fulfilled in exactly one partial instance and the trip cost is included there. The deadhead costs between two trips $s,t\in\Ti$ are the same as before. If start and end points are included, the behavior is as follows: Each start and end point represents a trip of an already solved partial instance. The deadhead cost after this trip (if it is a start point) or before this trip (if it is an end point) has not occurred up to now. The deadhead cost including a start or an end point is therefore the same as the deadhead cost with the trip representing it.

The fixed vehicle costs require a different treatment. If a duty begins at a start point or finishes at an end point, the vehicles cost of this duty arises already in the partial instance where the start point is created. Therefore, the arcs ${\left\{\ds\right\}\times\Vhat_i}$ have no vehicle cost, the arcs ${\left\{\ds\right\}\times\left(\Ti\cupdot\Phat_i\right)}$ have vehicles cost $\cv$. Since the vehicle cost for an end point are already paid in the other partial instance, the arcs ${\Phat_i\times\left\{\de\right\}}$ have negative vehicle cost. This means, a duty beginning at a start point and finishing at an end point has negative vehicle cost, since the vehicle cost has already occurred twice, in the partial instance where start, respectively end point was created.

Since the cover constraints are left out in this formulation, also the route cost is not treated here. This is also defined with the specification of the splitting. The formulation of the partial instance is called $\eqref{eq:SMILPi}$ for $i\in[n]\backslash\{1\}$.

\newpage

\begin{align}
	\min \quad & \omit\rlap{$\displaystyle{\left(\sum_{s\in\Ti\cup\Phat_i} x_{\ds,s} - \sum_{s\in\Phat_i} x_{s,\de}\right)\cv}$} \nonumber \\
	& \omit\rlap{$\displaystyle{\sum_{t\in\Ti\cup\Phat_i}\sum_{s\in\Ninoi(t)\backslash\left\{\ds\right\}}\left[x_{s,t}\left(\cd_{s,t}+\ct_t\right)+\sum_{r\in\Rst}z_{s,r,t}\left(\cd_{s,r}+\cd_{r,t}-\cd_{s,t}\right)\right]}$} \tag{$\operatorname{SMILP}_i$} \label{eq:SMILPi} \\
	\text{s.t.} \quad & \sum_{t\in\Ninoi(s)} x_{t,s} = \sum_{t\in\Noutoi(s)} x_{s,t} & & \text{for all } s\in \overline{V}_i\backslash\left\{\ds,\de\right\} \label{eq:CMILP:flow} \\
	& \sum_{s\in\Ninoi(t)} x_{s,t} = 1 && \text{for all } t\in\Vhat_i\cup\Phat_i \tag{\ref{eq:CMILP:start_end_points}} \\	
	& \sum_{r\in\Rst} z_{s,r,t} \leq x_{s,t} && \text{for all } t\in\Ti\cup\Phat_i, s\in\Ninoi(t)\backslash\left\{\ds\right\} \label{eq:CMILP:refuel} \\
	& e_s \leq f_s^0 & & \text{for all } s\in\Vhat_i \tag{\ref{eq:CMILP:initial_fuel}} \\
	& f^0_s \leq e_s && \text{for all } s\in\Phat_i \tag{\ref{eq:CMILP:final_fuel}} \\
	& 0 \leq e_s - \sum_{r\in\Rst} z_{s,r,t}\fd_{s,r} & & \text{for all } t\in\Ti\cup\Phat_i, s\in\Ninoi(t)\backslash\left\{\ds\right\} \label{eq:CMILP:min_fuel} \\
	& e_t \leq 1 - \ft_t - \sum_{r\in\Rst} z_{s,r,t}\fd_{r,t} & & \text{for all } t\in\Ti\cup\Phat_i, s\in\Ninoi(t)\backslash\left\{\ds\right\} \label{eq:CMILP:max_fuel} \\
	& \omit\rlap{$\displaystyle{e_t \leq e_s - x_{s,t}\left(f_{s,t}^{\operatorname{d}}+f_t^{\operatorname{t}}\right) - \sum_{r\in\Rst} z_{s,r,t}\left(\fd_{s,r}+\ft_r+\fd_{r,t}-\fd_{s,t}\right) + \left(1-x_{s,t}\right)}$} \nonumber \\
	& & & \text{for all } t\in\Ti\cup\Phat_i, s\in\Ninoi(t) \label{eq:CMILP:fuel_consumption} \\
	& \omit\rlap{$\displaystyle{e_s + \ft_s \leq f^{\max}_s + \left(1-x_{\ds,s}\right)\cdot\left(1+\ft_s\right)} \qquad \text{for all } s\in\Ti \tag{\ref{eq:CMILP:fmax}}$} \\
	& f^{\min}_s \leq e_s + \left(1-x_{s,\de}\right) && \text{for all } s\in\Ti \tag{\ref{eq:CMILP:fmin}} \\
	& x_{s,t}\in\{0,1\} & & \text{for all } (s,t)\in\overline{A}_i \label{eq:CMILP:xst} \\
	& z_{s,r,t}\in\{0,1\} & & \text{for all } t\in\Ti\cup\Phat_i,s\in\Ninoi(t)\backslash\left\{\ds\right\},r\in\Rst \label{eq:CMILP:zsrt} \\
	& e_s\in[0,1] & & \text{for all } s\in\overline{V}_i\backslash\left\{\ds,\de\right\} \label{eq:CMILP:es}
\end{align}

\paragraph{Solving Partial Instance $\boldsymbol{I_1}$} \parfill

As mentioned before, the partial instance $I_1$ plays a special role since here the vehicles are introduced. We have ${\Vhat_1=\mathcal{V}}$. This requires some changes in the formulation. All duties have to start with a vehicle node, therefore all nodes out of ${\left\{\ds\right\}\times\left(\mathcal{T}_1\cupdot\Vhat_1\right)}$ are deleted. This graph is denoted as ${\overline{G}_1 = \left(\overline{V}_1,\overline{A}_1\right)}$.
The objective function is modified, too. Each vehicles causes vehicle costs $\cv$. Thus, the term 
\begin{align*}
	\left(\sum_{s\in\Ti\cupdot\Phat_i} x_{\ds,s} - \sum_{s\in\Phat_i} x_{s,\de}\right)\cv
\end{align*}

in the objective function is replaced by
\begin{align*}
	\left(\sum_{s\in\Vhat_1} \sum_{t\in\operatorname{N}^+_{\overline{G}_1}(s)\backslash\left\{\de\right\}} x_{s,t} - \sum_{s\in\Phat_1} x_{s,\de}\right)\cv
\end{align*}

We call this formulation $(\operatorname{SMILP}_1)$.

%########################################################################################################################################
%#
%#   Customer-dependent Splitting
%#
%########################################################################################################################################

\section{Customer-dependent Splitting}
\label{sec:customer_dependent_splitting}

In this section, we introduce customer-dependent splitting. In contrast to the splitting performed by \cite{Knoll}, the trips are not split according to their start times but according to their customers' start times. This means, that all trips of a route and all routes of a customer are in the same splitting. This has the advantage, that the cover constraints can be applied easily in the respective subproblems. The problem is that this formulation is potentially not equivalent to the original problem, \ie duties that are feasible in $\eqref{eq:MMILP}$ can be cut in this formulation. We show restrictions, in which the application of this splitting is sensible, though. 

\paragraph{Splitting} \parfill

The customer-dependent splitting is defined as follows:

\begin{definition}[customer-dependent Splitting]
\label{def:customer_dependent_splitting}

Given points in time $c_i$ for $i\in[n-1]$ with $c_i<c_{i+1}$ for $i\in[n-2]$. We first define a splitting of the customers $\mathcal{C}=\Cupdot_{i=1}^n\mathcal{C}_i$ as
\begin{align*}
	\mathcal{C}_i := \begin{cases}
		\left\{c\in\mathcal{C}\mid \zstart_c\leq c_1\right\} & \text{for } i=1 \\
		\left\{c\in\mathcal{C}\mid c_{i-1}<\zstart_c\leq c_i\right\} & \text{for } i\in[n-1]\backslash\{1\} \\
		\left\{c\in\mathcal{C}\mid c_{n-1}<\zstart_c\right\} & \text{for } i=n.
	\end{cases}
\end{align*}

Based on the customer splitting, we define the splittings of $\mathcal{T}$ and $\mathcal{V}$ as
\begin{align*}
	\Ti := \left\{t\in\mathcal{T}\mid (M\circ C)(t)\in\mathcal{C}_i\right\} && \text{for } i\in[n]
\end{align*}

and
\begin{align*}
	\Vi := \begin{cases}
		\left\{v\in\mathcal{V}\mid z_v\leq c_1\right\} & \text{for } i=1 \\
		\left\{v\in\mathcal{V}\mid c_{i-1}<z_v\leq c_i\right\} & \text{for } i\in[n-1]\backslash\{1\} \\
		\left\{v\in\mathcal{V}\mid c_{n-1}<z_v\right\} & \text{for } i=n.
	\end{cases}
\end{align*}

\end{definition}

We denote the formulation $\eqref{eq:SMILP}$ with a splitting according to \Cref{def:customer_dependent_splitting} as (CMILP).

\paragraph{Solving of the Partial Instances} \parfill

The formulation is built on the basic structure $\eqref{eq:SMILPi}$. The cover constraints are not considered so far. We therefore introduce the decision variable $u_m\in\{0,1\}$ for $m\in C^{-1}\left(\mathcal{C}_i\right)$. Since for a customer $c\in\mathcal{C}_i$ all trips are in the splitting $\Ti$, only the cover constraints concerning these customers are included in partial instance $I_i$. We therefore add the following constraints:
\begin{align}
	& \sum_{m\in C^{-1}(c)} u_m = 1 && \text{for all } c\in\mathcal{C}_i \label{eq:CMILP:customer} \\
	& \sum_{s\in\operatorname{N}_{\overline{G}_i}^-(t)} x_{s,t} = u_m && \text{for all } m\in C^{-1}\left(\mathcal{C}_i\right), t\in m \label{eq:CMILP:route} \\
	& u_m\in\{0,1\} && \text{for all } m\in C^{-1}\left(\mathcal{C}_i\right) \label{eq:CMILP:um}
\end{align}

The route cost is not considered in $\eqref{eq:SMILPi}$ so far. Again, we have to consider only the route costs belonging to $c\in\mathcal{C}_i$. We therefore add the following term to the objective function
\begin{align*}
	\sum_{m\in C^{-1}\left(\mathcal{C}_i\right)} u_m \croute_m
\end{align*}

We call this formulation $(\operatorname{CMILP}_i)$ for $i\in[n]$.

\paragraph{Model Equivalence} \parfill

This heuristic formulation is not equivalent to the original formulation $\eqref{eq:MMILP}$. This is shown by the following example.

\begin{example}

Let $t_1$, $t_2$, $t_3$ with $t_1\prec t_2\prec t_3$ be trips with the properties shown in \Cref{tab:customer_heuristic_example}

\begin{table}[htb]
	\centering
	\begin{tabular}{c|cccc}
		Trip & Start & End & Route & customer \\
		\hline
		$t_1$ & 8:00 & 8:15 & $m_1$ & $C_1$ \\
		$t_2$ & 8:30 & 8:45 & $m_2$ & $C_2$ \\
		$t_3$ & 9:00 & 9:15 & $m_1$ & $C_1$ \\
	\end{tabular}
	\caption{Trips}
	\label{tab:customer_heuristic_example}
\end{table}

In this case, customer $C_1$ uses public transport between 8:15 and 9:00. The duty $\left(t_1,t_2,t_3\right)$ is a feasible result of the $\eqref{eq:MMILP}$.

If there is a split point at 8:15 then the splittings are $\mathcal{T}_1=\left\{t_1,t_3\right\},\mathcal{T}_2=\left\{t_2\right\}$. Hence, there is one split point $\operatorname{SP}_1\left(t_2\right)$ with $\zstart_{\operatorname{SP}_1\left(t_2\right)} =$ 8:30. The partial solution of instance~$1$ is $\left(t_1,t_3\right)$ and $t_3\not\prec \operatorname{SP}_1\left(t_2\right)$. Thus, the partial solutions cannot be feasibly connected to the solution $\left(t_1,t_2,t_3\right)$.

\end{example}

With this example we have seen, that the formulations $(\operatorname{CMILP})$ and $\eqref{eq:MMILP}$ are not equivalent. It is even possible, that an optimal solution of $\eqref{eq:MMILP}$ is not feasible in $(\operatorname{CMILP})$.

Although the formulations are not equivalent, we can give an estimation on the objective value when we make some restrictions.

\begin{definition}

For $n\geq 3$, consider a customer set $\mathcal{C}$ and split points $c_i$ for $i\in[n-1]$ with $c_i<c_{i+1}$ for all $i\in[n-2]$. We define the following values:
\begin{itemize}
	\item{customer Extension for $c\in\mathcal{C}$: $\displaystyle{L_{\operatorname{C}}(c) := \max_{t\in(M\circ C)^{-1}(c)}\zstart_t - \min_{t\in(M\circ C)^{-1}(c)}\zstart_t}$}
	\item{customer Extension: $\displaystyle{L_{\operatorname{C}} := \max_{c\in\mathcal{C}} L_{\operatorname{C}}(c)}$}
	\item{Splitting Length: $\displaystyle{L_{\operatorname{S}} := \min_{i\in[n-1]} c_{i+1}-c_i}$}
\end{itemize}

\end{definition}

\begin{theorem}

For $n\geq 3$, consider the problem with customer set $\mathcal{C}$ and split points $c_i$ for $i\in[n-1]$ with $c_i<c_{i+1}$ for all $i\in[n-2]$. Let
\begin{align}
\label{eq:LCLS}
	L_{\operatorname{C}}\leq L_{\operatorname{S}}
\end{align}

Let $d:=\left(t_1,\dots,t_k\right)$ be the duty of a vehicle of a feasible solution of the $\eqref{eq:MMILP}$. Then, there are duties $d_1\cupdot d_2=d$, where $d_1,d_2$ are part of a feasible solution of $(\operatorname{CMILP})$. Moreover, there holds
\begin{align}
	\operatorname{cost}\left(d_1\right)+\operatorname{cost}\left(d_2\right)\leq 2\cdot\operatorname{cost}\left(d\right).
\end{align}

\end{theorem}

\begin{proof}

We consider the vehicle duty $d=\left(t_1,\dots t_k\right)$. We write $s\prec t$ according to \Cref{def:partial_order}, i.e. $(s,t)$ is feasible in $\eqref{eq:MMILP}$. We write $s\to t$ iff $(s,t)$ is feasible in (CMILP).

Consider $s\prec t$ with $s\not\to t$ and customers $C_s:=(M\circ C)(s)$ and $C_t:=(M\circ C)(t)$. Then $s$ is in a later splitting than $t$. There are split points $c_{l-1},c_l,c_{l+1}$ for $l\in[n]$ with
\begin{align*}
	\zstart_s < \zstart_t && \zstart_{C_t}\leq c_l <\zstart_{C_s} && c_l+L_{\operatorname{S}}\leq c_{l+1} && \zstart_{C_s}\leq \zstart_s\leq \zstart_{C_s}+L_{\operatorname{C}}
\end{align*}

Since $\eqref{eq:LCLS}$, holds
\begin{gather*}
	\zstart_{C_s} \leq \zstart_s < \zstart_t\leq\zstart_{C_t}+L_{\operatorname{C}} \leq c_l+L_{\operatorname{C}} \leq c_l+L_{\operatorname{S}} \leq c_{l+1} \\
	\zstart_{C_t} \geq \zstart_t-L_{\operatorname{C}} > \zstart_s-L_{\operatorname{C}} \geq \zstart_{C_s}-L_{\operatorname{C}} > c_l-L_{\operatorname{C}}\geq c_l-L_{\operatorname{S}}\geq c_{l-1}
\end{gather*}

and therefore $t\in\mathcal{T}_l,s\in\mathcal{T}_{l+1}$. Here, we use $c_{0}:=-\infty,c_{n+1}:=+\infty$.

\paragraph{Feasibility}

For arbitrary $i\in[k-2]$ holds: $t_i\prec t_{i+1}\prec t_{i+2}$, therefore also $t_i\prec t_{i+2}$. We prove that $t_{i+2}$ can be appended after $t_{i}$ or $t_{i+1}$. We differentiate between the following cases:
\begin{enumerate}
	\item{$t_{i+1}\to t_{i+2}$:}
		Clear.
	\item{$t_{i+1}\not\to t_{i+2}$:}
		Then holds $t_{i+2}\in\mathcal{T}_l$ and $t_{i+1}\in\mathcal{T}_{l+1}$ for some $l\in[k]$. From $t_i\prec t_{i+2}$ follows $t_i\in\bigcup_{j=1}^{l+1}\mathcal{T}_j$. Therefore $t_i\to t_{i+1}$ or $t_i\to t_{i+2}$.
	\begin{itemize}
		\item{$t_i\to t_{i+2}$:}
			Clear.
		\item{$t_i\not\to t_{i+2}$:}
			Then holds $t_{i+2}\in\mathcal{T}_l$ and $t_i,t_{i+1}\in\mathcal{T}_{l+1}$ and therefore $t_i\to t_{i+1}$. For $i'\geq i$ holds $t_{i'}\in\bigcup_{j=l}^n \mathcal{T}_j$ and therefore $t_{i+1}\to t_{i'}$ or $t_{i+2}\to t_{i'}$. Thus, every later trip can be appended after on of these duties.
	\end{itemize}
\end{enumerate}

We have seen that two duties $d_1,d_2$ can fulfill the trips of duty $d$, such that $d_1$ and $d_2$ are feasible in (CMILP). Each trip can be appended to $d_1$ or to $d_2$.

\paragraph{Costs}

The costs of duty $d$ are
\begin{align*}
	\operatorname{cost}(d)=\cv+\cd_{v,t_1}+\ct_{t_1}+\sum_{i=2}^k \left(\cd_{t_{i-1},t_i}+\ct_{t_i}\right).
\end{align*}

Each duty $d_1,d_2$ has cost $\cd_{t,t'}+\ct_{t'}+\cd_{t',t''}$ if trip $t'$ is covered and cost $\cd_{t,t''}$ if not. According to $\eqref{eq:triangle_inequality_ext}$, the costs for not covering the trip do not exceed the costs for covering. Therefore we have
\begin{align*}
	\operatorname{cost}\left(d_1\right)+\operatorname{cost}\left(d_2\right)\leq 2\cdot\operatorname{cost}\left(d\right).
\end{align*}

\end{proof}

\begin{corollary}

Consider the problem with $L_{\operatorname{C}}\leq L_{\operatorname{S}}$. Let $S_1$ be a feasible solution of $\eqref{eq:MMILP}$. Then there exists a solution $S_2$ feasible also in $(\operatorname{CMILP})$.
\begin{align*}
	\operatorname{val}\left(S_2\right)\leq 2\cdot\operatorname{val}\left(S_1\right)
\end{align*}

\end{corollary}

%########################################################################################################################################
%#
%#   Time-dependent Splitting
%#
%########################################################################################################################################

\section{Time-dependent Splitting}
\label{sec:time_dependent_splitting}

The developed formulation (CMILP) based on a customer-dependent splitting is not equivalent to the original formulation $\eqref{eq:MMILP}$. The goal now is to develop a splitting that is equivalent and create a heuristic based on this splitting. Therefore, it is necessary that trips of the same customer may be in different splittings. This leads to the following problem: When the partial instances are solved successively, we need a possibility to still guarantee the customer satisfaction for the entire problem. This has to be applied already in the first partial instance where a certain customer is concerned, although we do not have any knowledge about the trips of the same customer in the later solved partial instances.

\subsection{Basic Idea}
\label{sec:basic_idea}

We define time-dependent splitting similar to \cite{Knoll}. Based on this splitting, we adapt the model and describe the necessary cost estimation.

\paragraph{Splitting} \parfill

We split the sets $\mathcal{T}$ and $\mathcal{V}$ according to their start times.

\begin{definition}[Time-dependent Splitting]
\label{def:time_dependent_splitting}

Given points in time $c_i$ for $i\in[n-1]$ with $c_i<c_{i+1}$ for $i\in[n-2]$. We define the splitting of $\mathcal{T}$ and $\mathcal{V}$ as follows:
\begin{align*}
	\Ti := \begin{cases}
		\left\{t\in\mathcal{T}\mid \zstart_t\leq c_1\right\} & \text{for } i=1 \\
		\left\{t\in\mathcal{T}\mid c_{i-1}<\zstart_t\leq c_i\right\} & \text{for } i\in[n-1]\backslash\{1\} \\
		\left\{t\in\mathcal{T}\mid c_{n-1}<\zstart_t\right\} & \text{for } i=n
	\end{cases}
\end{align*}

and
\begin{align*}
	\Vi := \begin{cases}
		\left\{v\in\mathcal{V}\mid z_v\leq c_1\right\} & \text{for } i=1 \\
		\left\{v\in\mathcal{V}\mid c_{i-1}<z_v\leq c_i\right\} & \text{for } i\in[n-1]\backslash\{1\} \\
		\left\{v\in\mathcal{V}\mid c_{n-1}<z_v\right\} & \text{for } i=n
	\end{cases}
\end{align*}

\end{definition}

We denote the formulation $\eqref{eq:SMILP}$ with a splitting according to \Cref{def:time_dependent_splitting} as (TMILP).

\paragraph{Solving of the Partial Instances} \parfill

Since the trips of the same customer may be in different splittings, we cannot easily guarantee the customer satisfaction only in just one partial instance. We have to put great effort in this issue. Let $\sigma\in S_n$ with $\sigma(n)=1$ be the order in which the partial instances are solved. We first define the earliest solved partial instance, in which a trip of a customer arises, as follows: 
\begin{align*}
	\gamma: \mathcal{C}\to[n] && \gamma(c):=\sigma\left(\min\left\{i\in[n]\mid\left((M\circ C)^{-1}(c)\cap\mathcal{T}_{\sigma(i)}\right)\neq\emptyset\right\}\right)
\end{align*}

Depending on $\gamma$ and $\left\{\mathcal{T}_1,\dots\mathcal{T}_n\right\}$ we define a partition $\mathcal{C}=\left\{\mathcal{C}_1,\dots\mathcal{C}_n\right\}$ as
\begin{align*}
	\mathcal{C}_i := \left\{c\in\mathcal{C}\mid \gamma(c)=i\right\} && \text{for } i\in[n]
\end{align*}

Consider customer $c\in\mathcal{C}$. In partial instance $I_{\gamma(c)}$, a multimodal route $m\in C^{-1}(c)$ is chosen and this choice is definite. This means, in all subsequently solved partial instances, all trips ${t\in m}$ are fixed to be chosen in advance and all trips ${t\in\left((M\circ C)^{-1}(c)\backslash m\right)}$ are fixed to be neglected.

In partial instance $\gamma(c)$ we have at least one trip of $c$. But there are also trips of $c$ that are in other splittings. There are even multimodal routes with no trip in this splitting at all. These routes must not be neglected. Therefore, we need a method to choose the routes where all routes $m\in C^{-1}(c)$ are considered. Therefore, we try to estimate the costs of the routes in advance. The solving of the partial instances is again based on $\eqref{eq:SMILPi}$.

For the cover constraints, we again introduce the decision variable $u_m\in\{0,1\}$ for $m\in C^{-1}\left(\mathcal{C}_i\right)$.  Notice that the definition of $\mathcal{C}_i$ is different to the definition in \Cref{sec:customer_dependent_splitting}. In the customer constraints, only the customers in this splitting are considered. The route constraints are restricted to the trips that are actually in this splitting. The cover constraints read as follows:
\begin{align}
	& \sum_{m\in C^{-1}(c)} u_m = 1 && \text{for all } c\in\mathcal{C}_i \label{eq:TMILP:customer} \\
	& \sum_{s\in\operatorname{N}_{\overline{G}_i}^-(t)} x_{s,t} = u_m && \text{for all } m\in C^{-1}\left(\mathcal{C}_i\right), t\in m\cap\Ti \label{eq:TMILP:route} \\
	& u_m\in\{0,1\} && \text{for all } m\in C^{-1}\left(\mathcal{C}_i\right) \label{eq:TMILP:um}
\end{align}

For the constraint $\eqref{eq:TMILP:customer}$ it is irrelevant, if the considered route has a trip in this splitting.

After solving the partial instance, all determined $u_m$ are fixed for the later solved partial instances. The fixed route decisions from the previous partial instances have an impact on this instance, too. 

Let $\bar{u}_m\in[0,1]$ be the fixed route choices from the previous instances. Define
\begin{align*}
	\overline{\mathcal{C}}_i := \left\{c\in\mathcal{C}\mid \gamma\left(c\right)<\sigma(i)\right\}
\end{align*}

as the customers that are already treated. Then, we introduce the constraint
\begin{align}
	&\sum_{s\in\operatorname{N}_{\overline{G}_i}^-(t)} x_{s,t} = \bar{u}_m && \text{for all } m\in C^{-1}\left(\overline{\mathcal{C}}_i\right), t\in m\cap\Ti \label{eq:TMILP:route_fix}
\end{align}

which ensures that the previous route choices are considered.

\paragraph{Cost Estimation} \parfill

In order to choose a route in a partial instance, we have to estimate the costs for all routes of the same customer in all subsequently solved partial instances in advance. The entire cost for the problem consists of vehicle costs $\cv$, trip costs $\ct$, deadhead costs $\cd$ and route costs $\croute$. While we can determine the trip costs and route costs easily for a route, the vehicle costs and trip costs strongly depend on the environment of the route and cannot be determined. We therefore focus on the trip and route costs and define the estimated route cost as follows:
\begin{align*}
	C_1(m) := \croute_m + \sum_{t\in m}\ct_t && \text{for } m\in\mathcal{M}
\end{align*}

We use these costs in order to define the modified route costs
\begin{align*}
	\hat{c}^{\operatorname{r}}_m := \croute_m + \sum_{t\in m\backslash\Ti}\ct_t && \text{for } m\in\mathcal{M}
\end{align*}

and add the following term to the objective function:
\begin{align*}
	\sum_{m\in C^{-1}\left(\mathcal{C}_i\right)} u_m \hat{c}^{\operatorname{r}}_m
\end{align*}

\begin{remark}

The trips in the considered splitting $t\in \left(m\cap\Ti\right)$ are not considered in $\hat{c}^{\operatorname{r}}_m$ since they are already part of the objective function. The other trips $t\in\left(m\backslash\Ti\right)$ are added to $\hat{c}^{\operatorname{r}}_m$, such that they have an impact on the choice of the routes.

Consider a trip $t$ that is decided before this partial instance, i.e. $t\in(M\circ C)\left(\overline{\mathcal{C}}_i\right)$. Its trip costs $\ct_t$ arise twice in the objective functions. Once in the partial instance $\gamma\left((M\circ C)(t)\right)$ as part of $\hat{c}^{\operatorname{r}}_{M(t)}$ and once in partial instance $I_i$ as $\ct_t$. But since in partial instance $I_i$ the trip has fulfilled anyway, this cost is only an additional constant that does not influence the solution. 

\end{remark}

We denote the formulation $\eqref{eq:SMILPi}$ with the constraints $\eqref{eq:TMILP:customer}$, $\eqref{eq:TMILP:route}$, $\eqref{eq:TMILP:route_fix}$ and $\eqref{eq:TMILP:um}$ and the new objective function including modified route costs as $(\operatorname{TMILP}_i)$ for $i\in[n]$.

%----------------------------------------------------------------------------------------------------------------------------------------

\subsection{Iterative Approach}
\label{sec:iterative_approach}

We use the previously developed heuristic for an iterative approach. First, we compute an initial solution while we choose the routes according to cost function $C_1$. Based on this solution, we determine the actual costs of the routes. With this, we can estimate the contribution of a route to the objective function. We compare the estimated route cost to the actual route cost. If the actual route cost is considerably higher than the estimated route cost, it is likely that this route choice was bad. We identify the customer with the worst route choice and solve a subproblem, where we fix all route choices except for the considered customer. Regarding one customer after another, we can iteratively improve the solution.

\paragraph{Initial Solution} \parfill

We determine a solution with the heuristic developed in \Cref{sec:basic_idea} with a splitting according to \Cref{def:time_dependent_splitting}. Based on this solution $S=\left(\bar{x},\bar{z},\bar{e},\bar{u}\right)$, we determine 
\begin{align*}
	C_1(c) := C_1(m) && \text{for } c\in\mathcal{C}, m\in C^{-1}(c) \text{ with } \bar{u}_m = 1
\end{align*}

\paragraph{Finding Bad Route Choice} \parfill

Given a solution of the problem, the subproblem is to find a customer with a bad route choice. This means, for this customer there is another route, such that the total cost is lower choosing this route. We can exchange these routes and compute a new solution considering the new route. 

An initial idea is to compute the cost, one route in the solution contributes to the entire solution. Then, we can compare this to the cost, with which we estimated the route costs before. If the actual cost are considerably higher than the estimated cost, this customer is a candidate for exchanging routes. Since we cannot determine the contributing cost exactly, we try to estimate this cost.

Let $S=\left(\bar{x},\bar{z},\bar{e},\bar{u}\right)$ be a solution of $\eqref{eq:MMILP}$. In order to determine the contributing cost for route $m\in\mathcal{M}$, we define the following auxiliary costs for every trip $t\in\mathcal{T}$ of the solution:

Vehicle costs $\cv_t(S)$: Let $v\in\mathcal{V}$ be the vehicle covering $t$ and $k_v$ the number of trips covered by $v$:
\begin{align*}
	\cv_t(S) := \frac{\cv}{k_v}
\end{align*}

Refueling costs $c^{\operatorname{refuel}}_t(S)$: Let $r\in\mathcal{R}$ be the next refuel station used after $t$ and $T_r$ all trips covered since the last station, let $\bar{z}_{s,r,s'} = 1$:
\begin{align*}
	c^{\operatorname{refuel}}_t(S) := \frac{\ft_t}{\sum_{t'\in T_r} \ft_t}\left(\cd_{s,r}+\cd_{r,s'}-\cd_{s,s'}\right)
\end{align*}
If the vehicle is not refueled after $t$, then $c^{\operatorname{refuel}}_t(S) := 0$.

Deadhead costs $\cd_t(S)$: Let $s\in\mathcal{V}\cup\mathcal{T},s'\in\mathcal{T}$ be the trips covered directly before and after $t$ by vehicle $v$, i.e. $\bar{x}_{s,t}=\bar{x}_{t,s'}=1$:
\begin{align*}
	\cd_t(S) := \frac 1 2 \left(\cd_{s,t}+\cd_{t,s'}\right)
\end{align*}
If $t$ is the last trip of the duty, i.e. $\bar{x}_{s,t}=\bar{x}_{t,d^{\operatorname{e}}}=1$, then $\cd_t(S) := \frac 1 2 \cd_{s,t}$.

With these auxiliary costs we can define new route costs which describe the contribution of a multimodal route to the entire solution better:

\begin{definition}[Improved Cost Estimation]

Let $S=\left(\bar{x},\bar{z},\bar{e},\bar{u}\right)$ be a solution of the $\eqref{eq:MMILP}$. With the auxiliary costs described before, we define the improved cost estimation for all multimodal routes $m\in\left\{m\in\mathcal{M}\mid \bar{u}_m=1\right\}$:
\begin{align*}
	C_2(S,m) := C_1(m) + \sum_{t\in m}\left(\cv_t(S) + c^{\operatorname{refuel}}_t(S) + \cd_t(S)\right)
\end{align*}

We further define
\begin{align*}
	C_2(S,c) := C_2(S,m) && \text{for } c\in\mathcal{C},m\in C^{-1}(c) \text{ with } \bar{u}_m = 1
\end{align*}

\end{definition}

Now we can evaluate our previous estimation for the route contribution. If $C_2(S,c)$ is significantly higher than $C_1(S,c)$ then the probability is high that we made a bad route choice for customer $c\in\mathcal{C}$.

We therefore determine
\begin{align*}
	c^* := \argmax_{c\in\mathcal{C}} \frac{C_2(S,c)}{C_1(S,c)}
\end{align*}

The probability is high that we made a bad route choice for customer $c^*$. Thus, we look at the route choice for $c^*$ again.

\begin{remark}

For simplicity of notation, we assume that $S$ is a solution of $\eqref{eq:MMILP}$. This is possible since the formulations (TMILP) and $\eqref{eq:MMILP}$ are equivalent.

\end{remark}

\paragraph{Subproblem} \parfill

Let $S=\left(\bar{x},\bar{z},\bar{e},\bar{u}\right)$ be a solution of $\eqref{eq:MMILP}$ and $c\in\mathcal{C}$ a candidate for a bad route choice. We define the following subproblem $(\operatorname{HSP}_c)$: Assume the schedule according to $S$ for the entire time without $[\zstart_c,\zend_c]$ and all route choices for customers except $c$ as fix. Determine an optimal schedule within these restrictions.

We define the splittings $\mathcal{T}=\left\{\mathcal{T}^c_1,\mathcal{T}^c_2,\mathcal{T}^c_3\right\}$ and $\mathcal{V}=\left\{\mathcal{V}^c_1,\mathcal{V}^c_2,\mathcal{V}^c_3\right\}$ by
\begin{align*}
	\mathcal{T}^c_i := \begin{cases}
		\left\{t\in\mathcal{T}^c\mid \zstart_t<\zstart_c\right\} & \text{if } i=1 \\
		\left\{t\in\mathcal{T}^c\mid \zstart_c\leq\zstart_t\leq\zend_c\right\} & \text{if } i=2 \\
		\left\{t\in\mathcal{T}^c\mid \zend_c<\zstart_t\right\} & \text{if } i=3
	\end{cases}
\end{align*}

and
\begin{align*}
	\mathcal{V}^c_i := \begin{cases}
		\left\{v\in\mathcal{V}\mid z_v<\zstart_c\right\} & \text{if } i=1 \\
		\left\{v\in\mathcal{V}\mid \zstart_c\leq z_v\leq\zend_c\right\} & \text{if } i=2 \\
		\left\{v\in\mathcal{V}\mid z_v<\zend_c\right\} & \text{if } i=3
	\end{cases}
\end{align*}

We then define the start point set $\hat{\mathcal{V}}_2$ and the end point set $\hat{\mathcal{P}}_2$
\begin{align*}
	\hat{\mathcal{V}}_2 & := \left\{s\in\mathcal{T}^c_1\mid \bar{x}_{s,t}=1\text{ for }t\in\left(\mathcal{T}^c_2\cupdot\mathcal{T}^c_3\cupdot\left\{\de\right\}\right)\right\}\cupdot\mathcal{V}^c_1\cupdot\mathcal{V}^c_2 \\
	\hat{\mathcal{P}}_2 & := \left\{t\in\mathcal{T}^c_3\mid \bar{x}_{s,t}=1\text{ for }s\in\left(\left\{\ds\right\}\cupdot\mathcal{T}^c_1\cupdot\mathcal{T}^c_2\right)\right\}
\end{align*}

With these definitions, we can adapt the formulation $(\operatorname{TMILP}_i)$ for $i=2$ to $(\operatorname{HSP}_c)$. The only modified constraints are the cover constraints $\eqref{eq:TMILP:customer}$, $\eqref{eq:TMILP:route}$, $\eqref{eq:TMILP:um}$ and $\eqref{eq:TMILP:route_fix}$. They are replaced by
\begin{align}
	& \sum_{m\in C^{-1}(c)} u_m = 1 \label{eq:HSP:customer} \\
	& \sum_{s\in\operatorname{N}_{\overline{G}_2}^-(t)} x_{s,t} = u_m && \text{for all } m\in C^{-1}(c),t\in m \label{eq:HSP:route} \\
	& \sum_{s\in\operatorname{N}_{\overline{G}_2}^-(t)} x_{s,t} = \bar{u}_{M(t)} && \text{for all } t\in\mathcal{T}^c_2\backslash(M\circ C)^{-1}(c) \label{eq:HSP:route_fix} \\
	& u_m\in\{0,1\} && \text{for all } m\in M^{-1}(c) \label{eq:HSP:um}
\end{align}

We decide only the routes of customer $c$. Thus, we use the objective function of $\eqref{eq:SMILPi}$ and add the following term:
\begin{align*}
	\sum_{m\in C^{-1}(c)} u_m \croute_m
\end{align*}

\paragraph{Creating an Improved Solution} \parfill

With solving $(\operatorname{HSP}_c)$, we receive a new partial solution denoted as $\hat{S}^c_2$. Let $S$ be the original entire solution. First, we transform $S$ into three partial solutions $\left\{S^c_1,S^c_2,S^c_3\right\}$ according to the splitting $\mathcal{T}=\left\{\mathcal{T}^c_1,\mathcal{T}^c_2,\mathcal{T}^c_3\right\}$ and $\mathcal{V}=\left\{\mathcal{V}^c_1,\mathcal{V}^c_2,\mathcal{V}^c_3\right\}$.\fxnote{This is done according to the procedure in ...} Then, we feasibly connect the partial solutions $\left\{S^c_1,\hat{S}^c_2,S^c_3\right\}$ to a new solution $\hat{S}$ according to the procedure described in \Cref{sec:general_setting}.

The original partial solution $S^c_2$ is a feasible solution of $(\operatorname{HSP}_c)$. Therefore, with this method we cannot get a worse entire solution than before.

After completing this step, we can apply this procedure to the customer with the second-highest ratio of $\frac{C_2(S,c)}{C_1(c)}$.

\begin{remark}

The customer extension $\LC$ is not bounded explicitly like $\eqref{eq:LCLS}$. But also here a small customer extension is beneficial due to the size of the $(\operatorname{HSP}_c)$.

\end{remark}

%----------------------------------------------------------------------------------------------------------------------------------------

\subsection{Restricted Approach}
\label{sec:restricted_approach}

We regard the special case in which each customer has trips in at most two subsequent splittings. This can be ensured if the customer extension is bounded by the splitting length. We try to exploit this special structure. For each customer, we basically distinguish between two cases: There are more trips of this customer in the splitting whose partial instance is solved first (Case 1) or there are more trips in the splitting whose partial instance is solved later (Case 2). In Case 1, the cost estimation for the routes is easy since most of the structure is already contained in the first processed partial instance. In Case 2, there is not much structure in the first processed partial instance, so the cost prediction will be imprecise. In order to prevent an imprecise cost estimation as in Case 2, we inspect the possibility of reversing a previous route choice in the later solved partial instance, if we find a better alternative there. In this section, we inspect the potential of cost saving for a belated trip deletion and develop a more flexible formulation in order to receive a better solution.

\begin{lemma}

For $n\geq 3$, consider the problem with customer set $\mathcal{C}$ and split points $c_i$ for ${i\in[n-1]}$ with $c_i<c_{i+1}$ for all $i\in[n-2]$. Let
\begin{align}
	L_{\operatorname{C}}\leq L_{\operatorname{S}} \tag{\ref{eq:LCLS}}
\end{align}

For every customer $c\in\mathcal{C}$, there is $i\in[n-1]$ such that
\begin{align}
	t\in\left(\Ti\cupdot\mathcal{T}_{i+1}\right) && \text{for all } t\in (M\circ C)^{-1}(c)
\end{align}

this means, each customer is represented in at most two subsequent splittings.

\end{lemma}

\begin{proof}

For simplicity of notion, we state $c_0:=-\infty$ and $c_n:=+\infty$. Consider customer $c\in\mathcal{C}$ and $i\in[n]$ such that ${c_{i-1} \leq \zstart_c < c_i}$. For $i=n$ all trips of $c$ are in splitting $n$.	 For $i<n$ we have
\begin{align*}
	\zstart_c \leq \zstart_t \leq \zstart_c + L_{\operatorname{C}} < c_i + L_{\operatorname{C}} \leq c_i + L_{\operatorname{S}} \leq c_{i+1} && \text{for all } t\in (M\circ C)^{-1}(c)
\end{align*}

Thus we have
\begin{align*}
	t\in\left(\mathcal{T}_i\cupdot\mathcal{T}_{i+1}\right) && \text{for all } t\in (M\circ C)^{-1}(c)
\end{align*}

\end{proof}

In the following considerations, we neglect the customer whose trip are in one splitting. These cover constraints are already ensured in the partial instance.

Consider partial instance $i\in[n]$, the customer set
\begin{align*}
	\CR_i := \left\{c\in\mathcal{C}\mid\gamma(c)\in\left\{i-1,i+1\right\}\land\left((M\circ C)^{-1}(c)\cap\Ti\right)\neq\emptyset\right\}
\end{align*}

and the route set
\begin{align*}
	\mathcal{M}^{\operatorname{R}}_i := \left\{m\in\mathcal{M}\mid C(m)\in\CR_i\land m\subset\Ti\right\}
\end{align*}

$\CR_i$ are all customers represented in $\Ti$ but initially treated in another partial instance, $\MR_i$ are all routes of these customers where all trips are in $\Ti$.

We regard the possibility to revise a previous route choice if we find a better alternative in partial instance~$i$. For this, we think about the cost saving for subsequent trip deletion. As in \Cref{sec:iterative_approach}, the cost function $C_1(m)$ is used for cost estimation.

\paragraph{Costs for Trip Replacement} \parfill

We want to regard the possibility of deleting an already chosen route in partial instance $I_i$. We therefore consider customer $c\in\CR_i$, \ie the customer has trips in an adjacent splitting and this partial instance is solved before. For this, we introduce the following notation.

\begin{definition}

Let $c\in\CR_i$ and let ${S_{\gamma(c)}=\left(\bar{x},\bar{z},\bar{e},\bar{u}\right)}$ be the partial solution of the previously solved partial instance, where the route of $c$ has been chosen. Let $\bar{m}(c)\in C^{-1}(c)$ be the unique route with $\bar{u}_m = 1$

Let ${s_1(t)\in\left(\left\{\ds_{\gamma(c)}\right\}\cupdot\hat{\mathcal{V}}_{\gamma(c)}\cupdot\mathcal{T}_{\gamma(c)}\right)}$, ${s_2(t)\in\left(\mathcal{T}_{\gamma(c)}\cupdot\hat{\mathcal{P}}_{\gamma(c)}\cupdot\left\{\de_{\gamma(c)}\right\}\right)}$ be the unique trips with $\bar{x}_{s_1,t}=\bar{x}_{t,s_2}=1$ for all $t\in\left(\bar{m}(c)\backslash\Ti\right)$.

Here, ${\ds_{\gamma(c)},\de_{\gamma(c)}\in\overline{V}_{\gamma(c)}}$ are the respective source and sink node of the partial task graph $\overline{G}_{\gamma(c)}$.

\end{definition}

The route $\bar{m}(c)$ denotes the route that is chosen for customer $c\in\CR_i$ by the partial solution, $s_1(t)$ and $s_2(t)$ are the trips that are directly before and after this trip in its respective duty. 

By assuming ${\cd_{\ds,t}=\cd_{t,\de}=:0}$ for all ${t\in\mathcal{T}_{\gamma(c)}}$, the cost saving for deleting a trip $t$ in partial instance $I_{\gamma(c)}$ is
\begin{align*}
	\cd_{s_1(t),t}+\ct_t+\cd_{t,s_2(t)}-\cd_{s_1(t),s_2(t)}
\end{align*}

\paragraph{Adaption of the Model} \parfill

In the following, we adapt the formulation $(\operatorname{TMILP}_i)$ in order to allow a belated route replacement. The restriction $\eqref{eq:LCLS}$ is required for this formulation. It is also necessary that at least one adjacent partial instance is already solved. In this procedure, the partial instance is solved before, with the additional ability to replace already chosen routes under strong restrictions: If for customer $c\in\mathcal{C}$ a route has been chosen in a previously solved partial instance $I_{\gamma(c)}$ and there are routes whose trips are all in the partial trip set $\mathcal{T}_i$, then either one of these routes is chosen or the previous route decision is confirmed. The choice of another route is not possible since this would require an insertion of trips into an already existing partial solution. We call this formulation $\eqref{eq:RTMILPi}$. The underlying partial task graph $\overline{G}_i$ is not modified.

We introduce new decision variables $u^c$ for $c\in\CR_i$. They indicate whether the route choice for customer $c$ is confirmed or not. If the route choice is not confirmed, adding of routes of the same customer is necessary. This is only possible, if all trips of this route are in $\mathcal{T}_i$. We therefore introduce decision variables $u_m$ for all $m\in\MR_i$.

For every $c\in\CR_i$, either the previous choice must be confirmed or a new route is chosen. This is ensured by
\begin{align}
	u^c + \sum_{\substack{m\in\MR_i \\ C(m)=c}} u_m = 1 && \text{for all } c\in\CR_i \label{eq:RTMILP:customer_old}
\end{align}

We have $\overline{\mathcal{C}}_i = \CR_i$ since $\eqref{eq:LCLS}$. The constraint $\eqref{eq:TMILP:route_fix}$ ensures the route decisions of the previous partial instances. It is replaced by
\begin{align}
	& \sum_{s\in\Ninoi(t)} x_{s,t} = u^c && \text{for all } c\in\CR_i, t\in\bar{m}(c)\cap\Ti \label{eq:RTMILP:route_confirmed} \\
	& \sum_{s\in\Ninoi(t)} x_{s,t} = u_m && \text{for all } t\in M^{-1}\left(\MR_i\right) \label{eq:RTMILP:route_old} \\
	& \sum_{s\in\Ninoi(t)} x_{s,t} = 0 && \text{for all } c\in\CR_i, t\in M^{-1}\left(C^{-1}(c)\backslash\left(\MR_i\cup\left\{\bar{m}(c)\right\}\right)\right)\cap\Ti \label{eq:RTMILP:route_fix}
\end{align}

The constraint $\eqref{eq:RTMILP:route_confirmed}$ ensures the route satisfaction for the previously decided route, $\eqref{eq:RTMILP:route_old}$ for all route completely in $\Ti$ and $\eqref{eq:RTMILP:route_fix}$ for all other trips in $\Ti$. Note that $\mathcal{C}_i\cap\CR_i = \emptyset$. Hence, $\eqref{eq:TMILP:customer}$ and $\eqref{eq:TMILP:route}$ are not influenced by them. We contract $\eqref{eq:TMILP:route}$ and $\eqref{eq:RTMILP:route_old}$ to
\begin{align}
	\sum_{s\in\Ninoi(t)} x_{s,t} = u_m && \text{for all } m\in\MR_i\cupdot C^{-1}\left(\mathcal{C}_i\right), t\in m\cap\Ti \label{eq:RTMILP:route}
\end{align}

Finally, we replace $\eqref{eq:TMILP:um}$ by
\begin{align}
	& u_m\in\{0,1\} && \text{for all } m\in C^{-1}\left(\mathcal{C}_i\right)\cupdot\MR_i \label{eq:RTMILP:um} \\
	& u^c \in\{0,1\} && \text{for all } c\in\CR_i \label{eq:RTMILP:uc}
\end{align}

\paragraph{Cost Function} \parfill

We have to consider additional contributions to the cost function. If the route choice is not confirmed, the trips of $\bar{m}(c)$ are deleted and the route cost and the saved cost are subtracted from the cost function. We define these cost as
\begin{align*}
	\hat{c}_c := \croute_{\bar{m}(c)} + \sum_{t\in\left(\bar{m}(c)\backslash\Ti\right)} \left(\cd_{s_1(t),t}+\ct_t+\cd_{t,s_2(t)}-\cd_{s_1(t),s_2(t)}\right) && \text{for } c\in\CR_i
\end{align*}

Note, that the costs $\ct$ and $\cd$ belong to the partial instance $I_{\gamma(i)}$ and are not part of the considered partial task graph $\overline{G}_i$. The term $\hat{c}_c$ describes the cost saving for not confirming the route choice of $c$ and is completely given in advance.

In order to determine the route costs for all $c\in\CR_i$, we add the following term to the objective function.
\begin{align*}
	\sum_{m\in\MR_i} u_m \croute_m - \sum_{c\in\CR_i} \left(1-u^c\right)\hat{c}_c
\end{align*}

In summary, the formulation $\eqref{eq:RTMILPi}$ is given by $\eqref{eq:SMILPi}$ with the constraints $\eqref{eq:TMILP:customer}$, $\eqref{eq:RTMILP:customer_old}$, $\eqref{eq:RTMILP:route_confirmed}$, $\eqref{eq:RTMILP:route_fix}$, $\eqref{eq:RTMILP:route}$, $\eqref{eq:RTMILP:um}$ and $\eqref{eq:RTMILP:uc}$ and the objective function
\begin{align}
	&\left(\sum_{s\in\Ti\cup\Phat_i} x_{\ds,s} - \sum_{s\in\Phat_i} x_{s,\de}\right)\cv + \sum_{m\in C^{-1}\left(\mathcal{C}_i\right)} u_m \hat{c}^{\operatorname{r}}_m + \sum_{m\in\MR_i} u_m \croute_m + \sum_{c\in\CR_i} \left(u^c - 1\right)\hat{c}_c \nonumber \\
	+ & \sum_{t\in\Ti\cup\Phat_i}\sum_{s\in\Ninoi(t)\backslash\left\{\ds\right\}}\left[x_{s,t}\left(\cd_{s,t}+\ct_t\right)+\sum_{r\in\Rst}z_{s,r,t}\left(\cd_{s,r}+\cd_{r,t}-\cd_{s,t}\right)\right] \tag{$\operatorname{RTMILP}_i$} \label{eq:RTMILPi}
\end{align}

%----------------------------------------------------------------------------------------------------------------------------------------

\subsection{Improvements}

This is listing of comments regarding this section. It includes some small changes that can be made in the formulations in order to improve the performance, some new considerations and some small mistakes, where the developed methods work inaccurately but there is not an easy handling.

\begin{enumerate}
	\item{$\eqref{eq:LCLS}$ does not hold in general}:
It is possible that each customer is represented in at most two splittings although $\eqref{eq:LCLS}$ does not hold. If this is not the case, one can possibly deviate some split points by a small value \st the condition holds. If only a small number of customers exceeds the splitting length, their exclusion from the formulations $(\operatorname{HSP}_c)$ or $\eqref{eq:RTMILPi}$ still promises good results.
	\item{Create Preprocessing}:
One can create the split points via an own problem. The goal of this preprocessing is minimizing the customers represented in several splittings, constraints are a minimal and a maximal splitting length. If there are only few customers in more than one splitting, the solution behavior is improved.
	\item{Strategy for route choice in \Cref{sec:iterative_approach}}:
In $I_i$, it is not beneficial to choose a route with $m\cap\Ti=\emptyset$. If such a route is the most suitable one, one can leave the choice open and choose in the next partial instance among all routes with $m\cap\Ti=\emptyset$. In $I_i$ is is not necessary to choose the route because there are no trips to cover, thus it is not beneficial fix the route choice already there.
	\item{Strategy for route choice in \Cref{sec:restricted_approach}}:
In $I_{\gamma(c)}$, it is beneficial to choose a route with $m\cap\mathcal{T}_{\gamma(c)}\neq\emptyset$, even is another choice, \ie $m'\in\MR_i$ is more beneficial there. If $m$ is a bad choice at the end, it will be reversed in $I_i$. If $m$ is a good choice against expectation, it will be confirmed in $I_i$.
	\item{Deleting subsequent trips}:
If in $\eqref{eq:RTMILPi}$ two subsequent trips of the same duty are deleted, the value for cost saving is wrong. For four subsequent trips $t_1, t_2, t_3, t_4$ where $t_2, t_3$ are deleted, the difference between the real cost saving and the computed cost saving is ${\cd_{t_1,t_4}+\cd_{t_2,t_3}-\cd_{t_1,t_3}-\cd_{t_2,t_4}}$. If there a subsequent trips of the same route in the same duty, the term can be adapted. An exact solution would be the introduction of a decision variable for each combination of route deletions.
\end{enumerate}